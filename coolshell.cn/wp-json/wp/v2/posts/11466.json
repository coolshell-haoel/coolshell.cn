{"id":11466,"date":"2014-04-21T08:18:01","date_gmt":"2014-04-21T00:18:01","guid":{"rendered":"http:\/\/coolshell.cn\/?p=11466"},"modified":"2020-07-08T17:30:37","modified_gmt":"2020-07-08T09:30:37","slug":"c%e8%af%ad%e8%a8%80%e7%9a%84%e6%95%b4%e5%9e%8b%e6%ba%a2%e5%87%ba%e9%97%ae%e9%a2%98","status":"publish","type":"post","link":"https:\/\/coolshell.cn\/articles\/11466.html","title":{"rendered":"C\u8bed\u8a00\u7684\u6574\u578b\u6ea2\u51fa\u95ee\u9898"},"content":{"rendered":"<p>\u6574\u578b\u6ea2\u51fa\u6709\u70b9\u8001\u751f\u5e38\u8c08\u4e86\uff0cbla, bla, bla&#8230; \u4f46\u4f3c\u4e4e\u6ca1\u6709\u5f15\u8d77\u591a\u5c11\u4eba\u7684\u91cd\u89c6\u3002\u6574\u578b\u6ea2\u51fa\u4f1a\u6709\u53ef\u80fd\u5bfc\u81f4\u7f13\u51b2\u533a\u6ea2\u51fa\uff0c\u7f13\u51b2\u533a\u6ea2\u51fa\u4f1a\u5bfc\u81f4\u5404\u79cd\u9ed1\u5ba2\u653b\u51fb\uff0c\u6bd4\u5982\u6700\u8fd1OpenSSL\u7684heartbleed\u4e8b\u4ef6\uff0c\u5c31\u662f\u4e00\u4e2abuffer overread\u7684\u4e8b\u4ef6\u3002\u5728\u8fd9\u91cc\u5199\u4e0b\u8fd9\u7bc7\u6587\u7ae0\uff0c\u5e0c\u671b\u5927\u5bb6\u90fd\u4e86\u89e3\u4e00\u4e0b\u6574\u578b\u6ea2\u51fa\uff0c\u7f16\u8bd1\u5668\u7684\u884c\u4e3a\uff0c\u4ee5\u53ca\u5982\u4f55\u9632\u8303\uff0c\u4ee5\u5199\u51fa\u66f4\u5b89\u5168\u7684\u4ee3\u7801\u3002<\/p>\n<div id=\"ez-toc-container\" class=\"ez-toc-v2_0_48 counter-hierarchy ez-toc-counter ez-toc-grey ez-toc-container-direction\">\n<div class=\"ez-toc-title-container\">\n<p class=\"ez-toc-title\">\u76ee\u5f55<\/p>\n<span class=\"ez-toc-title-toggle\"><\/span><\/div>\n<nav><ul class='ez-toc-list ez-toc-list-level-1 ' ><li class='ez-toc-page-1 ez-toc-heading-level-4'><a class=\"ez-toc-link ez-toc-heading-1\" href=\"https:\/\/coolshell.cn\/articles\/11466.html\/#%E4%BB%80%E4%B9%88%E6%98%AF%E6%95%B4%E5%9E%8B%E6%BA%A2%E5%87%BA\" title=\"\u4ec0\u4e48\u662f\u6574\u578b\u6ea2\u51fa\">\u4ec0\u4e48\u662f\u6574\u578b\u6ea2\u51fa<\/a><\/li><li class='ez-toc-page-1 ez-toc-heading-level-4'><a class=\"ez-toc-link ez-toc-heading-2\" href=\"https:\/\/coolshell.cn\/articles\/11466.html\/#%E6%95%B4%E5%9E%8B%E6%BA%A2%E5%87%BA%E7%9A%84%E5%8D%B1%E5%AE%B3\" title=\"\u6574\u578b\u6ea2\u51fa\u7684\u5371\u5bb3\">\u6574\u578b\u6ea2\u51fa\u7684\u5371\u5bb3<\/a><ul class='ez-toc-list-level-5'><li class='ez-toc-heading-level-5'><a class=\"ez-toc-link ez-toc-heading-3\" href=\"https:\/\/coolshell.cn\/articles\/11466.html\/#%E7%A4%BA%E4%BE%8B%E4%B8%80%EF%BC%9A%E6%95%B4%E5%BD%A2%E6%BA%A2%E5%87%BA%E5%AF%BC%E8%87%B4%E6%AD%BB%E5%BE%AA%E7%8E%AF\" title=\"\u793a\u4f8b\u4e00\uff1a\u6574\u5f62\u6ea2\u51fa\u5bfc\u81f4\u6b7b\u5faa\u73af\">\u793a\u4f8b\u4e00\uff1a\u6574\u5f62\u6ea2\u51fa\u5bfc\u81f4\u6b7b\u5faa\u73af<\/a><\/li><li class='ez-toc-page-1 ez-toc-heading-level-5'><a class=\"ez-toc-link ez-toc-heading-4\" href=\"https:\/\/coolshell.cn\/articles\/11466.html\/#%E7%A4%BA%E4%BE%8B%E4%BA%8C%EF%BC%9A%E6%95%B4%E5%BD%A2%E8%BD%AC%E5%9E%8B%E6%97%B6%E7%9A%84%E6%BA%A2%E5%87%BA\" title=\"\u793a\u4f8b\u4e8c\uff1a\u6574\u5f62\u8f6c\u578b\u65f6\u7684\u6ea2\u51fa\">\u793a\u4f8b\u4e8c\uff1a\u6574\u5f62\u8f6c\u578b\u65f6\u7684\u6ea2\u51fa<\/a><\/li><li class='ez-toc-page-1 ez-toc-heading-level-5'><a class=\"ez-toc-link ez-toc-heading-5\" href=\"https:\/\/coolshell.cn\/articles\/11466.html\/#%E7%A4%BA%E4%BE%8B%E4%B8%89%EF%BC%9A%E5%88%86%E9%85%8D%E5%86%85%E5%AD%98\" title=\"\u793a\u4f8b\u4e09\uff1a\u5206\u914d\u5185\u5b58\">\u793a\u4f8b\u4e09\uff1a\u5206\u914d\u5185\u5b58<\/a><\/li><li class='ez-toc-page-1 ez-toc-heading-level-5'><a class=\"ez-toc-link ez-toc-heading-6\" href=\"https:\/\/coolshell.cn\/articles\/11466.html\/#%E7%A4%BA%E4%BE%8B%E5%9B%9B%EF%BC%9A%E7%BC%93%E5%86%B2%E5%8C%BA%E6%BA%A2%E5%87%BA%E5%AF%BC%E8%87%B4%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98\" title=\"\u793a\u4f8b\u56db\uff1a\u7f13\u51b2\u533a\u6ea2\u51fa\u5bfc\u81f4\u5b89\u5168\u95ee\u9898\">\u793a\u4f8b\u56db\uff1a\u7f13\u51b2\u533a\u6ea2\u51fa\u5bfc\u81f4\u5b89\u5168\u95ee\u9898<\/a><\/li><li class='ez-toc-page-1 ez-toc-heading-level-5'><a class=\"ez-toc-link ez-toc-heading-7\" href=\"https:\/\/coolshell.cn\/articles\/11466.html\/#%E7%A4%BA%E4%BE%8B%E4%BA%94%EF%BC%9Asize_t_%E7%9A%84%E6%BA%A2%E5%87%BA\" title=\"\u793a\u4f8b\u4e94\uff1asize_t \u7684\u6ea2\u51fa\">\u793a\u4f8b\u4e94\uff1asize_t \u7684\u6ea2\u51fa<\/a><\/li><\/ul><\/li><li class='ez-toc-page-1 ez-toc-heading-level-4'><a class=\"ez-toc-link ez-toc-heading-8\" href=\"https:\/\/coolshell.cn\/articles\/11466.html\/#%E5%85%B3%E4%BA%8E%E7%BC%96%E8%AF%91%E5%99%A8%E7%9A%84%E8%A1%8C%E4%B8%BA\" title=\"\u5173\u4e8e\u7f16\u8bd1\u5668\u7684\u884c\u4e3a\">\u5173\u4e8e\u7f16\u8bd1\u5668\u7684\u884c\u4e3a<\/a><ul class='ez-toc-list-level-5'><li class='ez-toc-heading-level-5'><a class=\"ez-toc-link ez-toc-heading-9\" href=\"https:\/\/coolshell.cn\/articles\/11466.html\/#%E7%BC%96%E8%AF%91%E5%99%A8%E4%BC%98%E5%8C%96\" title=\"\u7f16\u8bd1\u5668\u4f18\u5316\">\u7f16\u8bd1\u5668\u4f18\u5316<\/a><\/li><li class='ez-toc-page-1 ez-toc-heading-level-5'><a class=\"ez-toc-link ez-toc-heading-10\" href=\"https:\/\/coolshell.cn\/articles\/11466.html\/#%E8%8A%B1%E7%B5%AE%EF%BC%9A%E7%BC%96%E8%AF%91%E5%99%A8%E7%9A%84%E5%BD%A9%E8%9B%8B\" title=\"\u82b1\u7d6e\uff1a\u7f16\u8bd1\u5668\u7684\u5f69\u86cb\">\u82b1\u7d6e\uff1a\u7f16\u8bd1\u5668\u7684\u5f69\u86cb<\/a><\/li><\/ul><\/li><li class='ez-toc-page-1 ez-toc-heading-level-4'><a class=\"ez-toc-link ez-toc-heading-11\" href=\"https:\/\/coolshell.cn\/articles\/11466.html\/#%E6%AD%A3%E7%A1%AE%E6%A3%80%E6%B5%8B%E6%95%B4%E5%9E%8B%E6%BA%A2%E5%87%BA\" title=\"\u6b63\u786e\u68c0\u6d4b\u6574\u578b\u6ea2\u51fa\">\u6b63\u786e\u68c0\u6d4b\u6574\u578b\u6ea2\u51fa<\/a><ul class='ez-toc-list-level-5'><li class='ez-toc-heading-level-5'><a class=\"ez-toc-link ez-toc-heading-12\" href=\"https:\/\/coolshell.cn\/articles\/11466.html\/#%E4%BA%8C%E5%88%86%E5%8F%96%E4%B8%AD%E6%90%9C%E7%B4%A2%E7%AE%97%E6%B3%95%E4%B8%AD%E7%9A%84%E6%BA%A2%E5%87%BA\" title=\"\u4e8c\u5206\u53d6\u4e2d\u641c\u7d22\u7b97\u6cd5\u4e2d\u7684\u6ea2\u51fa\">\u4e8c\u5206\u53d6\u4e2d\u641c\u7d22\u7b97\u6cd5\u4e2d\u7684\u6ea2\u51fa<\/a><\/li><li class='ez-toc-page-1 ez-toc-heading-level-5'><a class=\"ez-toc-link ez-toc-heading-13\" href=\"https:\/\/coolshell.cn\/articles\/11466.html\/#%E4%B8%8A%E6%BA%A2%E5%87%BA%E5%92%8C%E4%B8%8B%E6%BA%A2%E5%87%BA%E7%9A%84%E6%A3%80%E6%9F%A5\" title=\"\u4e0a\u6ea2\u51fa\u548c\u4e0b\u6ea2\u51fa\u7684\u68c0\u67e5\">\u4e0a\u6ea2\u51fa\u548c\u4e0b\u6ea2\u51fa\u7684\u68c0\u67e5<\/a><\/li><\/ul><\/li><li class='ez-toc-page-1 ez-toc-heading-level-4'><a class=\"ez-toc-link ez-toc-heading-14\" href=\"https:\/\/coolshell.cn\/articles\/11466.html\/#%E5%85%B6%E5%AE%83\" title=\"\u5176\u5b83\">\u5176\u5b83<\/a><\/li><\/ul><\/nav><\/div>\n<h4><span class=\"ez-toc-section\" id=\"%E4%BB%80%E4%B9%88%E6%98%AF%E6%95%B4%E5%9E%8B%E6%BA%A2%E5%87%BA\"><\/span>\u4ec0\u4e48\u662f\u6574\u578b\u6ea2\u51fa<span class=\"ez-toc-section-end\"><\/span><\/h4>\n<p>C\u8bed\u8a00\u7684\u6574\u578b\u95ee\u9898\u76f8\u4fe1\u5927\u5bb6\u5e76\u4e0d\u964c\u751f\u4e86\u3002\u5bf9\u4e8e\u6574\u578b\u6ea2\u51fa\uff0c\u5206\u4e3a\u65e0\u7b26\u53f7\u6574\u578b\u6ea2\u51fa\u548c\u6709\u7b26\u53f7\u6574\u578b\u6ea2\u51fa\u3002<\/p>\n<p><strong>\u5bf9\u4e8eunsigned\u6574\u578b\u6ea2\u51fa\uff0cC\u7684\u89c4\u8303\u662f\u6709\u5b9a\u4e49\u7684<\/strong>\u2014\u2014\u201c\u6ea2\u51fa\u540e\u7684\u6570\u4f1a\u4ee52^(8*sizeof(type))\u4f5c\u6a21\u8fd0\u7b97\u201d\uff0c\u4e5f\u5c31\u662f\u8bf4\uff0c\u5982\u679c\u4e00\u4e2aunsigned char\uff081\u5b57\u7b26\uff0c8bits\uff09\u6ea2\u51fa\u4e86\uff0c\u4f1a\u628a\u6ea2\u51fa\u7684\u503c\u4e0e256\u6c42\u6a21\u3002\u4f8b\u5982\uff1a<\/p>\n<pre class=\"EnlighterJSRAW\" data-enlighter-language=\"c\">unsigned char x = 0xff;\nprintf(\"%d\\n\", ++x);<\/pre>\n<p>\u4e0a\u9762\u7684\u4ee3\u7801\u4f1a\u8f93\u51fa\uff1a0 \uff08\u56e0\u4e3a0xff + 1\u662f256\uff0c\u4e0e2^8\u6c42\u6a21\u540e\u5c31\u662f0\uff09<\/p>\n<p><strong>\u5bf9\u4e8esigned\u6574\u578b\u7684\u6ea2\u51fa\uff0cC\u7684\u89c4\u8303\u5b9a\u4e49\u662f\u201cundefined behavior\u201d<\/strong>\uff0c\u4e5f\u5c31\u662f\u8bf4\uff0c\u7f16\u8bd1\u5668\u7231\u600e\u4e48\u5b9e\u73b0\u5c31\u600e\u4e48\u5b9e\u73b0\u3002\u5bf9\u4e8e\u5927\u591a\u6570\u7f16\u8bd1\u5668\u6765\u8bf4\uff0c\u7b97\u5f97\u5565\u5c31\u662f\u5565\u3002\u6bd4\u5982\uff1a<\/p>\n<pre class=\"EnlighterJSRAW\" data-enlighter-language=\"c\">signed char x =0x7f; \/\/\u6ce8\uff1a0xff\u5c31\u662f-1\u4e86\uff0c\u56e0\u4e3a\u6700\u9ad8\u4f4d\u662f1\u4e5f\u5c31\u662f\u8d1f\u6570\u4e86\nprintf(\"%d\\n\", ++x);<\/pre>\n<p>\u4e0a\u9762\u7684\u4ee3\u7801\u4f1a\u8f93\u51fa\uff1a-128\uff0c\u56e0\u4e3a0x7f + 0x01\u5f97\u52300x80\uff0c\u4e5f\u5c31\u662f\u4e8c\u8fdb\u5236\u76841000 0000\uff0c\u7b26\u53f7\u4f4d\u4e3a1\uff0c\u8d1f\u6570\uff0c\u540e\u9762\u4e3a\u51680\uff0c\u5c31\u662f\u8d1f\u7684\u6700\u5c0f\u6570\uff0c\u5373-128\u3002<\/p>\n<p><!--more--><\/p>\n<p>\u53e6\u5916\uff0c\u5343\u4e07\u522b\u4ee5\u4e3asigned\u6574\u578b\u6ea2\u51fa\u5c31\u662f\u8d1f\u6570\uff0c\u8fd9\u4e2a\u662f\u4e0d\u5b9a\u7684\u3002\u6bd4\u5982\uff1a<\/p>\n<pre class=\"EnlighterJSRAW\" data-enlighter-language=\"c\">signed char x = 0x7f;\nsigned char y = 0x05;\nsigned char r = x * y;\nprintf(\"%d\\n\", r);<\/pre>\n<p>\u4e0a\u9762\u7684\u4ee3\u7801\u4f1a\u8f93\u51fa\uff1a123<\/p>\n<p>\u76f8\u4fe1\u5bf9\u4e8e\u8fd9\u4e9b\u5927\u5bb6\u4e0d\u4f1a\u964c\u751f\u4e86\u3002<\/p>\n<h4><span class=\"ez-toc-section\" id=\"%E6%95%B4%E5%9E%8B%E6%BA%A2%E5%87%BA%E7%9A%84%E5%8D%B1%E5%AE%B3\"><\/span>\u6574\u578b\u6ea2\u51fa\u7684\u5371\u5bb3<span class=\"ez-toc-section-end\"><\/span><\/h4>\n<p>\u4e0b\u9762\u8bf4\u4e00\u4e0b\uff0c\u6574\u578b\u6ea2\u51fa\u7684\u5371\u5bb3\u3002<\/p>\n<h5><span class=\"ez-toc-section\" id=\"%E7%A4%BA%E4%BE%8B%E4%B8%80%EF%BC%9A%E6%95%B4%E5%BD%A2%E6%BA%A2%E5%87%BA%E5%AF%BC%E8%87%B4%E6%AD%BB%E5%BE%AA%E7%8E%AF\"><\/span>\u793a\u4f8b\u4e00\uff1a\u6574\u5f62\u6ea2\u51fa\u5bfc\u81f4\u6b7b\u5faa\u73af<span class=\"ez-toc-section-end\"><\/span><\/h5>\n<pre class=\"EnlighterJSRAW\" data-enlighter-language=\"c\"> ... ...\n... ...\nshort len = 0;\n... ...\nwhile(len&lt; MAX_LEN) {\n    len += readFromInput(fd, buf);\n    buf += len;\n}<\/pre>\n<p>\u4e0a\u9762\u8fd9\u6bb5\u4ee3\u7801\u53ef\u80fd\u662f\u5f88\u591a\u7a0b\u5e8f\u5458\u90fd\u559c\u6b22\u5199\u7684\u4ee3\u7801\uff08\u6211\u5728\u5f88\u591a\u4ee3\u7801\u91cc\u770b\u5230\u8fc7\u591a\u6b21\uff09\uff0c\u5176\u4e2d\u7684MAX_LEN \u53ef\u80fd\u4f1a\u662f\u4e2a\u6bd4\u8f83\u5927\u7684\u6574\u578b\uff0c\u6bd4\u598232767\uff0c\u6211\u4eec\u77e5\u9053short\u662f16bits\uff0c\u53d6\u503c\u8303\u56f4\u662f-32768 \u5230 32767 \u4e4b\u95f4\u3002\u4f46\u662f\uff0c\u4e0a\u9762\u7684while\u5faa\u73af\u4ee3\u7801\u6709\u53ef\u80fd\u4f1a\u9020\u6210\u6574\u578b\u6ea2\u51fa\uff0c\u800clen\u53c8\u662f\u4e2a\u6709\u7b26\u53f7\u7684\u6574\u578b\uff0c\u6240\u4ee5\u53ef\u80fd\u4f1a\u6210\u8d1f\u6570\uff0c\u5bfc\u81f4\u4e0d\u65ad\u5730\u6b7b\u5faa\u73af\u3002<\/p>\n<h5><span class=\"ez-toc-section\" id=\"%E7%A4%BA%E4%BE%8B%E4%BA%8C%EF%BC%9A%E6%95%B4%E5%BD%A2%E8%BD%AC%E5%9E%8B%E6%97%B6%E7%9A%84%E6%BA%A2%E5%87%BA\"><\/span>\u793a\u4f8b\u4e8c\uff1a\u6574\u5f62\u8f6c\u578b\u65f6\u7684\u6ea2\u51fa<span class=\"ez-toc-section-end\"><\/span><\/h5>\n<pre class=\"EnlighterJSRAW\" data-enlighter-language=\"c\">int copy_something(char *buf, int len)\n{\n    #define MAX_LEN 256\n    char mybuf[MAX_LEN];\n     ... ...\n     ... ...\n\n     if(len &gt; MAX_LEN){ \/\/ &lt;---- [1]\n         return -1;\n     }\n\n     return memcpy(mybuf, buf, len);\n}<\/pre>\n<p>\u4e0a\u9762\u8fd9\u4e2a\u4f8b\u5b50\u4e2d\uff0c\u8fd8\u662f[1]\u5904\u7684if\u8bed\u53e5\uff0c\u770b\u4e0a\u53bb\u6ca1\u6709\u4f1a\u95ee\u9898\uff0c\u4f46\u662flen\u662f\u4e2asigned int\uff0c\u800cmemcpy\u5219\u9700\u4e00\u4e2asize_t\u7684len\uff0c\u4e5f\u5c31\u662f\u4e00\u4e2aunsigned \u7c7b\u578b\u3002\u4e8e\u662f\uff0clen\u4f1a\u88ab\u63d0\u5347\u4e3aunsigned\uff0c\u6b64\u65f6\uff0c\u5982\u679c\u6211\u4eec\u7ed9len\u4f20\u4e00\u4e2a\u8d1f\u6570\uff0c\u4f1a\u901a\u8fc7\u4e86if\u7684\u68c0\u67e5\uff0c\u4f46\u5728memcpy\u91cc\u4f1a\u88ab\u63d0\u5347\u4e3a\u4e00\u4e2a\u6b63\u6570\uff0c\u4e8e\u662f\u6211\u4eec\u7684mybuf\u5c31\u662foverflow\u4e86\u3002\u8fd9\u4e2a\u4f1a\u5bfc\u81f4mybuf\u7f13\u51b2\u533a\u540e\u9762\u7684\u6570\u636e\u88ab\u91cd\u5199\u3002<\/p>\n<h5><span class=\"ez-toc-section\" id=\"%E7%A4%BA%E4%BE%8B%E4%B8%89%EF%BC%9A%E5%88%86%E9%85%8D%E5%86%85%E5%AD%98\"><\/span>\u793a\u4f8b\u4e09\uff1a\u5206\u914d\u5185\u5b58<span class=\"ez-toc-section-end\"><\/span><\/h5>\n<p>\u5173\u4e8e\u6574\u6570\u6ea2\u51fa\u5bfc\u81f4\u5806\u6ea2\u51fa\u7684\u5f88\u5178\u578b\u7684\u4f8b\u5b50\u662f\uff0cOpenSSH Challenge-Response SKEY\/BSD_AUTH \u8fdc\u7a0b\u7f13\u51b2\u533a\u6ea2\u51fa\u6f0f\u6d1e\u3002\u4e0b\u9762\u8fd9\u6bb5\u6709\u95ee\u9898\u7684\u4ee3\u7801\u6458\u81eaOpenSSH\u7684\u4ee3\u7801\u4e2d\u7684auth2-chall.c\u4e2d\u7684input_userauth_info_response() \u51fd\u6570:<\/p>\n<pre class=\"EnlighterJSRAW\" data-enlighter-language=\"c\">nresp = packet_get_int();\nif (nresp &gt; 0) {\n    response = xmalloc(nresp*sizeof(char*));\n    for (i = 0; i &lt; nresp; i++)\n        response[i] = packet_get_string(NULL);\n}<\/pre>\n<p>\u4e0a\u9762\u8fd9\u4e2a\u4ee3\u7801\u4e2d\uff0cnresp\u662fsize_t\u7c7b\u578b\uff08size_t\u4e00\u822c\u5c31\u662funsigned int\/long int\uff09\uff0c\u8fd9\u4e2a\u793a\u4f8b\u662f\u4e00\u4e2a\u89e3\u6570\u636e\u5305\u7684\u793a\u4f8b\uff0c\u4e00\u822c\u6765\u8bf4\uff0c\u6570\u636e\u5305\u4e2d\u90fd\u4f1a\u6709\u4e00\u4e2alen\uff0c\u7136\u540e\u540e\u9762\u662fdata\u3002\u5982\u679c\u6211\u4eec\u7cbe\u5fc3\u51c6\u5907\u4e00\u4e2alen\uff0c\u6bd4\u5982\uff1a1073741825\uff08\u572832\u4f4d\u7cfb\u7edf\u4e0a\uff0c\u6307\u9488\u53604\u4e2a\u5b57\u8282\uff0cunsigned int\u7684\u6700\u5927\u503c\u662f0xffffffff\uff0c\u6211\u4eec\u53ea\u8981\u63d0\u4f9b0xffffffff\/4 \u7684\u503c\u2014\u20140x40000000\uff0c\u8fd9\u91cc\u6211\u4eec\u8bbe\u7f6e\u4e860x4000000 + 1\uff09\uff0c nresp\u5c31\u4f1a\u8bfb\u5230\u8fd9\u4e2a\u503c\uff0c\u7136\u540enresp<em>sizeof(char<\/em>)\u5c31\u6210\u4e86 1073741825 * 4\uff0c\u4e8e\u662f\u6ea2\u51fa\uff0c\u7ed3\u679c\u6210\u4e3a\u4e86 0x100000004\uff0c\u7136\u540e\u6c42\u6a21\uff0c\u5f97\u52304\u3002\u4e8e\u662f\uff0cmalloc(4)\uff0c\u4e8e\u662f\u540e\u9762\u7684for\u5faa\u73af1073741825 \u6b21\uff0c\u5c31\u53ef\u4ee5\u5e72\u73af\u4e8b\u4e86\uff08\u7ecf\u8fc70x40000001\u7684\u5faa\u73af,\u7528\u6237\u7684\u6570\u636e\u65e9\u5df2\u8986\u76d6\u4e86xmalloc\u539f\u5148\u5206\u914d\u76844\u5b57\u8282\u7684\u7a7a\u95f4\u4ee5\u53ca\u540e\u9762\u7684\u6570\u636e\uff0c\u5305\u62ec\u7a0b\u5e8f\u4ee3\u7801\uff0c\u51fd\u6570\u6307\u9488\uff0c\u4e8e\u662f\u5c31\u53ef\u4ee5\u6539\u5199\u7a0b\u5e8f\u903b\u8f91\u3002\u5173\u4e8e\u66f4\u591a\u7684\u4e1c\u897f\uff0c\u4f60\u53ef\u4ee5\u770b\u4e00\u4e0b\u8fd9\u7bc7\u6587\u7ae0\u300a<a href=\"http:\/\/engj.org\/index.php\/ej\/article\/view\/112\/167\" target=\"_blank\" rel=\"noopener noreferrer\">Survey of Protections from Buffer-Overflow Attacks<\/a>\u300b\uff09\u3002<\/p>\n<h5><span class=\"ez-toc-section\" id=\"%E7%A4%BA%E4%BE%8B%E5%9B%9B%EF%BC%9A%E7%BC%93%E5%86%B2%E5%8C%BA%E6%BA%A2%E5%87%BA%E5%AF%BC%E8%87%B4%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98\"><\/span>\u793a\u4f8b\u56db\uff1a\u7f13\u51b2\u533a\u6ea2\u51fa\u5bfc\u81f4\u5b89\u5168\u95ee\u9898<span class=\"ez-toc-section-end\"><\/span><\/h5>\n<pre class=\"EnlighterJSRAW\" data-enlighter-language=\"c\">int func(char *buf1, unsigned int len1,\n         char *buf2, unsigned int len2 )\n{\n   char mybuf[256]; \n\n   if((len1 + len2) &gt; 256){    \/\/&lt;--- [1]\n       return -1;\n   } \n\n   memcpy(mybuf, buf1, len1);\n   memcpy(mybuf + len1, buf2, len2); \n\n   do_some_stuff(mybuf); \n\n   return 0;\n}<\/pre>\n<p>\u4e0a\u9762\u8fd9\u4e2a\u4f8b\u5b50\u672c\u6765\u662f\u60f3\u628abuf1\u548cbuf2\u7684\u5185\u5bb9copy\u5230mybuf\u91cc\uff0c\u5176\u4e2d\u6015len1 + len2\u8d85\u8fc7256 \u8fd8\u505a\u4e86\u5224\u65ad\uff0c\u4f46\u662f\uff0c\u5982\u679clen1+len2\u6ea2\u51fa\u4e86\uff0c\u6839\u636eunsigned\u7684\u7279\u6027\uff0c\u5176\u4f1a\u4e0e2^32\u6c42\u6a21\uff0c\u6240\u4ee5\uff0c\u57fa\u672c\u4e0a\u6765\u8bf4\uff0c\u4e0a\u9762\u4ee3\u7801\u4e2d\u7684[1]\u5904\u6709\u53ef\u80fd\u4e3a\u5047\u7684\u3002\uff08\u6ce8\uff1a\u901a\u5e38\u6765\u8bf4\uff0c\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u5982\u679c\u4f60\u5f00\u542f-O\u4ee3\u7801\u4f18\u5316\u9009\u9879\uff0c\u90a3\u4e2aif\u8bed\u53e5\u5757\u5c31\u5168\u90e8\u88ab\u548c\u8c10\u6389\u4e86\u2014\u2014\u88ab\u7f16\u8bd1\u5668\u7ed9\u5220\u9664\u4e86\uff09\u6bd4\u5982\uff0c\u4f60\u53ef\u4ee5\u6d4b\u8bd5\u4e00\u4e0b len1=0x104\uff0c len2 = 0xfffffffc \u7684\u60c5\u51b5\u3002<\/p>\n<h5><span class=\"ez-toc-section\" id=\"%E7%A4%BA%E4%BE%8B%E4%BA%94%EF%BC%9Asize_t_%E7%9A%84%E6%BA%A2%E5%87%BA\"><\/span>\u793a\u4f8b\u4e94\uff1asize_t \u7684\u6ea2\u51fa<span class=\"ez-toc-section-end\"><\/span><\/h5>\n<pre class=\"EnlighterJSRAW\" data-enlighter-language=\"c\">for (int i= strlen(s)-1; \u00a0i&gt;=0; i--) \u00a0{ ... }<\/pre>\n<pre class=\"EnlighterJSRAW\" data-enlighter-language=\"c\">for (int i=v.size()-1; i&gt;=0; i--) \u00a0{ ... }<\/pre>\n<p>\u4e0a\u9762\u8fd9\u4e24\u4e2a\u793a\u4f8b\u662f\u6211\u4eec\u7ecf\u5e38\u7528\u7684\u4ece\u5c3e\u90e8\u904d\u5386\u4e00\u4e2a\u6570\u7ec4\u7684for\u5faa\u73af\u3002\u7b2c\u4e00\u4e2a\u662f\u5b57\u7b26\u4e32\uff0c\u7b2c\u4e8c\u4e2a\u662fC++\u4e2d\u7684vector\u5bb9\u5668\u3002strlen()\u548cvector::size()\u8fd4\u56de\u7684\u90fd\u662f size_t\uff0csize_t\u572832\u4f4d\u7cfb\u7edf\u4e0b\u5c31\u662f\u4e00\u4e2aunsigned int\u3002\u4f60\u60f3\u60f3\uff0c\u5982\u679cstrlen(s)\u548cv.size() \u90fd\u662f0\u5462\uff1f\u8fd9\u4e2a\u5faa\u73af\u4f1a\u6210\u4e3a\u4e2a\u4ec0\u4e48\u60c5\u51b5\uff1f\u4e8e\u662fstrlen(s) &#8211; 1 \u548c v.size() &#8211; 1 \u90fd\u4e0d\u4f1a\u6210\u4e3a -1\uff0c\u800c\u662f\u6210\u4e3a\u4e86 (unsigned int)(-1)\uff0c\u4e00\u4e2a\u6b63\u7684\u6700\u5927\u6570\u3002\u5bfc\u81f4\u4f60\u7684\u7a0b\u5e8f\u8d8a\u754c\u8bbf\u95ee\u3002<\/p>\n<p>\u8fd9\u6837\u7684\u4f8b\u5b50\u6709\u5f88\u591a\u5f88\u591a\uff0c\u8fd9\u4e9b\u6574\u578b\u6ea2\u51fa\u7684\u95ee\u9898\u5982\u679c\u5728\u5173\u952e\u7684\u5730\u65b9\uff0c\u5c24\u5176\u662f\u5728\u642d\u914d\u6709\u7528\u6237\u8f93\u5165\u7684\u5730\u65b9\uff0c\u5982\u679c\u88ab\u9ed1\u5ba2\u5229\u7528\u4e86\uff0c\u5c31\u4f1a\u5bfc\u81f4\u5f88\u4e25\u91cd\u7684\u5b89\u5168\u95ee\u9898\u3002<\/p>\n<h4><span class=\"ez-toc-section\" id=\"%E5%85%B3%E4%BA%8E%E7%BC%96%E8%AF%91%E5%99%A8%E7%9A%84%E8%A1%8C%E4%B8%BA\"><\/span>\u5173\u4e8e\u7f16\u8bd1\u5668\u7684\u884c\u4e3a<span class=\"ez-toc-section-end\"><\/span><\/h4>\n<p>\u5728\u8c08\u4e00\u4e0b\u5982\u4f55\u6b63\u786e\u7684\u68c0\u67e5\u6574\u578b\u6ea2\u51fa\u4e4b\u524d\uff0c\u6211\u4eec\u8fd8\u8981\u6765\u5b66\u4e60\u4e00\u4e0b\u7f16\u8bd1\u5668\u7684\u4e00\u4e9b\u4e1c\u897f\u3002\u8bf7\u522b\u602a\u6211\u7f57\u55e6\u3002<\/p>\n<h5><span class=\"ez-toc-section\" id=\"%E7%BC%96%E8%AF%91%E5%99%A8%E4%BC%98%E5%8C%96\"><\/span>\u7f16\u8bd1\u5668\u4f18\u5316<span class=\"ez-toc-section-end\"><\/span><\/h5>\n<p>\u5982\u4f55\u68c0\u67e5\u6574\u578b\u6ea2\u51fa\u6216\u662f\u6574\u578b\u53d8\u91cf\u662f\u5426\u5408\u6cd5\u6709\u65f6\u5019\u662f\u4e00\u4ef6\u5f88\u9ebb\u70e6\u7684\u4e8b\u60c5\uff0c\u5c31\u50cf\u4e0a\u9762\u7684\u7b2c\u56db\u4e2a\u4f8b\u5b50\u4e00\u6837\uff0c\u7f16\u8bd1\u7684\u4f18\u5316\u53c2\u6570-O\/-O2\/-O3\u57fa\u672c\u4e0a\u4f1a\u5047\u8bbe\u4f60\u7684\u7a0b\u5e8f\u4e0d\u4f1a\u6709\u6574\u5f62\u6ea2\u51fa\u3002\u4f1a\u628a\u4f60\u7684\u4ee3\u7801\u4e2d\u68c0\u67e5\u6ea2\u51fa\u7684\u4ee3\u7801\u7ed9\u4f18\u5316\u6389\u3002<\/p>\n<p>\u5173\u4e8e\u7f16\u8bd1\u5668\u7684\u4f18\u5316\uff0c\u5728\u8fd9\u91cc\u518d\u4e3e\u4e2a\u4f8b\u5b50\uff0c\u5047\u8bbe\u6211\u4eec\u6709\u4e0b\u9762\u7684\u4ee3\u7801\uff08\u53c8\u662f\u4e00\u4e2a\u76f8\u5f53\u76f8\u5f53\u5e38\u89c1\u7684\u4ee3\u7801\uff09\uff1a<\/p>\n<pre class=\"EnlighterJSRAW\" data-enlighter-language=\"c\">int len;\nchar* data;\n\nif (data + len &lt; data){\n    printf(\"invalid len\\n\");\n    exit(-1);\n}\n<\/pre>\n<p>\u4e0a\u9762\u8fd9\u6bb5\u4ee3\u7801\u4e2d\uff0clen \u548c data \u914d\u5957\u4f7f\u7528\uff0c\u6211\u4eec\u5bb3\u6015len\u7684\u503c\u662f\u975e\u6cd5\u7684\uff0c\u6216\u662flen\u6ea2\u51fa\u4e86\uff0c\u4e8e\u662f\u6211\u4eec\u5199\u4e0b\u4e86if\u8bed\u53e5\u6765\u68c0\u67e5\u3002\u8fd9\u6bb5\u4ee3\u7801\u5728-O\u7684\u53c2\u6570\u4e0b\u6b63\u5e38\u3002\u4f46\u662f\u5728-O2\u7684\u7f16\u8bd1\u9009\u9879\u4e0b\uff0c\u6574\u4e2aif\u8bed\u53e5\u5757\u88ab\u4f18\u5316\u6389\u4e86\u3002<\/p>\n<p>\u4f60\u53ef\u4ee5\u5199\u4e2a\u5c0f\u7a0b\u5e8f\uff0c\u5728gcc\u4e0b\u7f16\u8bd1\uff08\u6211\u7684\u7248\u672c\u662f4.4.7\uff0c\u8bb0\u5f97\u52a0\u4e0a-O2\u548c-g\u53c2\u6570\uff09\uff0c\u7136\u540e\u7528gdb\u8c03\u8bd5\u65f6\uff0c\u7528disass \/m\u547d\u4fe1\u8f93\u51fa\u6c47\u7f16\uff0c\u4f60\u4f1a\u770b\u5230\u4e0b\u9762\u7684\u7ed3\u679c\uff08\u4f60\u53ef\u4ee5\u770b\u5230\u6574\u4e2aif\u8bed\u53e5\u5757\u6ca1\u6709\u4efb\u4f55\u7684\u6c47\u7f16\u4ee3\u7801\u2014\u2014\u76f4\u63a5\u88ab\u7f16\u8bd1\u5668\u548c\u8c10\u6389\u4e86\uff09\uff1a<\/p>\n<pre data-enlighter-language=\"shell\" class=\"EnlighterJSRAW\">7 int len = 10;\n8 char* data = (char *)malloc(len);\n0x00000000004004d4 &lt;+4&gt;: mov $0xa,%edi\n0x00000000004004d9 &lt;+9&gt;: callq 0x4003b8 &lt;malloc@plt&gt;\n\n9\n10 if (data + len &lt; data){\n11 printf(&quot;invalid len\\n&quot;);\n12 exit(-1);\n13 }\n14\n15 }\n0x00000000004004de &lt;+14&gt;: add $0x8,%rsp\n0x00000000004004e2 &lt;+18&gt;: retq\n<\/pre>\n<p>\u5bf9\u6b64\uff0c\u4f60\u9700\u8981\u628a\u4e0a\u9762 char* \u8f6c\u578b\u6210 uintptr_t \u6216\u662f size_t\uff0c\u8bf4\u767d\u4e86\u4e5f\u5c31\u662f\u628achar*\u8f6c\u6210unsigned\u7684\u6570\u636e\u7ed3\u6784\uff0cif\u8bed\u53e5\u5757\u5c31\u65e0\u6cd5\u88ab\u4f18\u5316\u4e86\u3002\u5982\u4e0b\u6240\u793a\uff1a<\/p>\n<pre class=\"EnlighterJSRAW\" data-enlighter-language=\"c\">if ((uintptr_t)data + len &lt; (uintptr_t)data){\n    ... ...\n}<\/pre>\n<p>\u5173\u4e8e\u8fd9\u4e2a\u4e8b\uff0c\u4f60\u53ef\u4ee5\u770b\u4e00\u4e0bC99\u7684\u89c4\u8303\u8bf4\u660e\u300a <a href=\"http:\/\/www.open-std.org\/JTC1\/SC22\/WG14\/www\/docs\/n1124.pdf\" target=\"_blank\" rel=\"noopener noreferrer\">ISO\/IEC 9899:1999 C specification<\/a> \u300b\u7b2c \u00a76.5.6 \u9875\uff0c\u7b2c8\u70b9\uff0c\u6211\u622a\u4e2a\u56fe\u5982\u4e0b\uff1a\uff08\u8fd9\u6bb5\u8bdd\u7684\u610f\u601d\u662f\u5b9a\u4e49\u4e86\u6307\u9488+\/-\u4e00\u4e2a\u6574\u578b\u7684\u884c\u4e3a\uff0c\u5982\u679c\u8d8a\u754c\u4e86\uff0c\u5219\u884c\u4e3a\u662fundefined\uff09<\/p>\n<p><img decoding=\"async\" loading=\"lazy\" class=\"aligncenter size-full wp-image-11469\" src=\"https:\/\/coolshell.cn\/wp-content\/uploads\/2014\/04\/c99.jpg\" alt=\"\" width=\"647\" height=\"310\" srcset=\"https:\/\/coolshell.cn\/wp-content\/uploads\/2014\/04\/c99.jpg 647w, https:\/\/coolshell.cn\/wp-content\/uploads\/2014\/04\/c99-300x144.jpg 300w, https:\/\/coolshell.cn\/wp-content\/uploads\/2014\/04\/c99-564x270.jpg 564w\" sizes=\"(max-width: 647px) 100vw, 647px\" \/><\/p>\n<p>\u6ce8\u610f\u4e0a\u9762\u6807\u7ea2\u7ebf\u7684\u5730\u65b9\uff0c\u8bf4\u5982\u679c\u6307\u9488\u6307\u5728\u6570\u7ec4\u8303\u56f4\u5185\u6ca1\u4e8b\uff0c\u5982\u679c\u8d8a\u754c\u4e86\u5c31\u662fundefined\uff0c\u4e5f\u5c31\u662f\u8bf4\u8fd9\u4e8b\u4ea4\u7ed9\u7f16\u8bd1\u5668\u5b9e\u73b0\u4e86\uff0c\u7f16\u8bd1\u5668\u60f3\u548b\u5e72\u548b\u5e72\uff0c\u90a3\u6015\u4f60\u60f3\u628a\u5176\u4f18\u5316\u6389\u4e5f\u53ef\u4ee5\u3002\u5728\u8fd9\u91cc\u8981\u91cd\u70b9\u8bf4\u4e00\u4e0b\uff0c<strong>C\u8bed\u8a00\u4e2d\u7684\u4e00\u4e2a\u5927\u6076\u9b54\u2014\u2014 Undefined! \u8fd9\u91cc\u90fd\u662f\u201c\u91ce\u517d\u51fa\u6ca1\u201d\u7684\u5730\u65b9\uff0c\u4f60\u4e00\u5b9a\u8981\u5c0f\u5fc3\u5c0f\u5fc3\u518d\u5c0f\u5fc3<\/strong>\u3002<\/p>\n<h5><span class=\"ez-toc-section\" id=\"%E8%8A%B1%E7%B5%AE%EF%BC%9A%E7%BC%96%E8%AF%91%E5%99%A8%E7%9A%84%E5%BD%A9%E8%9B%8B\"><\/span>\u82b1\u7d6e\uff1a\u7f16\u8bd1\u5668\u7684\u5f69\u86cb<span class=\"ez-toc-section-end\"><\/span><\/h5>\n<p>\u4e0a\u9762\u8bf4\u4e86\u6240\u8c13\u7684undefined\u884c\u4e3a\u5c31\u5168\u6743\u4ea4\u7ed9\u7f16\u8bd1\u5668\u5b9e\u73b0\uff0cgcc\u57281.17\u7248\u672c\u4e0b\u5bf9\u4e8eundefined\u7684\u884c\u4e3a\u8fd8\u73a9\u4e86\u4e2a\u5f69\u86cb\uff08<a href=\"http:\/\/en.wikipedia.org\/wiki\/Undefined_behavior#Compiler_easter_eggs\" target=\"_blank\" rel=\"noopener noreferrer\">\u53c2\u770bWikipedia<\/a>\uff09\u3002<\/p>\n<p>\u4e0b\u9762gcc 1.17\u7248\u672c\u4e0b\u7684\u906d\u9047undefined\u884c\u4e3a\u65f6\uff0cgcc\u5728unix\u53d1\u884c\u7248\u4e0b\u73a9\u7684\u5f69\u86cb\u7684\u6e90\u4ee3\u7801\u3002\u6211\u4eec\u53ef\u4ee5\u770b\u5230\uff0c\u5b83\u4f1a\u53bb\u5c1d\u8bd5\u53bb\u6267\u884c\u4e00\u4e9b\u6e38\u620f<a href=\"http:\/\/en.wikipedia.org\/wiki\/NetHack\">NetHack<\/a>\uff0c\u00a0<a href=\"http:\/\/en.wikipedia.org\/wiki\/Rogue_%28computer_game%29\">Rogue<\/a>\u00a0\u6216\u662fEmacs\u7684\u00a0<a href=\"http:\/\/en.wikipedia.org\/wiki\/Tower_of_Hanoi#Applications\">Towers of Hanoi<\/a>\uff0c\u5982\u679c\u627e\u4e0d\u5230\uff0c\u5c31\u8f93\u51fa\u4e00\u6761NB\u7684\u62a5\u9519\u3002<\/p>\n<pre class=\"EnlighterJSRAW\" data-enlighter-language=\"c\">execl(\"\/usr\/games\/hack\", \"#pragma\", 0); \/\/ try to run the game NetHack\nexecl(\"\/usr\/games\/rogue\", \"#pragma\", 0); \/\/ try to run the game Rogue\n\/\/ try to run the Tower's of Hanoi simulation in Emacs.\nexecl(\"\/usr\/new\/emacs\", \"-f\",\"hanoi\",\"9\",\"-kill\",0);\nexecl(\"\/usr\/local\/emacs\",\"-f\",\"hanoi\",\"9\",\"-kill\",0); \/\/ same as above\nfatal(\"You are in a maze of twisty compiler features, all different\");<\/pre>\n<h4><span class=\"ez-toc-section\" id=\"%E6%AD%A3%E7%A1%AE%E6%A3%80%E6%B5%8B%E6%95%B4%E5%9E%8B%E6%BA%A2%E5%87%BA\"><\/span>\u6b63\u786e\u68c0\u6d4b\u6574\u578b\u6ea2\u51fa<span class=\"ez-toc-section-end\"><\/span><\/h4>\n<p>\u5728\u770b\u8fc7\u7f16\u8bd1\u5668\u7684\u8fd9\u4e9b\u884c\u4e3a\u540e\uff0c\u4f60\u5e94\u8be5\u4f1a\u660e\u767d\u2014\u2014\u201c<strong>\u5728\u6574\u578b\u6ea2\u51fa\u4e4b\u524d\uff0c\u4e00\u5b9a\u8981\u505a\u68c0\u67e5\uff0c\u4e0d\u7136\uff0c\u5c31\u592a\u665a\u4e86<\/strong>\u201d\u3002<\/p>\n<p>\u6211\u4eec\u6765\u770b\u4e00\u6bb5\u4ee3\u7801\uff1a<\/p>\n<pre class=\"EnlighterJSRAW\" data-enlighter-language=\"c\"> void foo(int m, int n)\n{\n    size_t s = m + n;\n    .......\n}<\/pre>\n<p>\u4e0a\u9762\u8fd9\u6bb5\u4ee3\u7801\u6709\u4e24\u4e2a\u98ce\u9669\uff1a<strong>1\uff09\u6709\u7b26\u53f7\u8f6c\u65e0\u7b26\u53f7<\/strong>\uff0c<strong>2\uff09\u6574\u578b\u6ea2\u51fa<\/strong>\u3002\u8fd9\u4e24\u4e2a\u60c5\u51b5\u5728\u524d\u9762\u7684\u90a3\u4e9b\u793a\u4f8b\u4e2d\u4f60\u90fd\u5e94\u8be5\u770b\u5230\u4e86\u3002<strong>\u6240\u4ee5\uff0c\u4f60\u5343\u4e07\u4e0d\u8981\u628a\u4efb\u4f55\u68c0\u67e5\u7684\u4ee3\u7801\u5199\u5728 s = m + n \u8fd9\u6761\u8bed\u540d\u540e\u9762\uff0c\u4e0d\u7136\u5c31\u592a\u665a\u4e86<\/strong>\u3002undefined\u884c\u4e3a\u5c31\u4f1a\u51fa\u73b0\u4e86\u2014\u2014\u7528\u53e5\u7eaf\u6b63\u7684\u82f1\u6587\u8868\u8fbe\u5c31\u662f\u2014\u2014\u201cDragon is here\u201d\u2014\u2014\u4f60\u4ec0\u4e48\u4e5f\u63a7\u5236\u4e0d\u4f4f\u4e86\u3002\uff08\u6ce8\u610f\uff1a\u6709\u4e9b\u521d\u5b66\u8005\u4e5f\u8bb8\u4f1a\u4ee5\u4e3asize_t\u662f\u65e0\u7b26\u53f7\u7684\uff0c\u800c\u6839\u636e\u4f18\u5148\u7ea7 m \u548c n \u4f1a\u88ab\u63d0\u5347\u5230unsigned int\u3002\u5176\u5b9e\u4e0d\u662f\u8fd9\u6837\u7684\uff0cm \u548c n \u8fd8\u662fsigned int\uff0cm + n \u7684\u7ed3\u679c\u4e5f\u662fsigned int\uff0c\u7136\u540e\u518d\u628a\u8fd9\u4e2a\u7ed3\u679c\u8f6c\u6210unsigned int \u8d4b\u503c\u7ed9s\uff09<\/p>\n<p>\u6bd4\u5982\uff0c\u4e0b\u9762\u7684\u4ee3\u7801\u662f\u9519\u7684\uff1a<\/p>\n<pre class=\"EnlighterJSRAW\" data-enlighter-language=\"c\"> void foo(int m, int n)\n{\n\u00a0 \u00a0 size_t s = m + n;\n\u00a0 \u00a0 if ( m&gt;0 &amp;&amp; n&gt;0 &amp;&amp; (SIZE_MAX - m &lt; n) ){\n        \/\/error handling...\n    }\n}<\/pre>\n<p>\u4e0a\u9762\u7684\u4ee3\u7801\u4e2d\uff0c\u5927\u5bb6\u8981\u6ce8\u610f <strong>(SIZE_MAX &#8211; m &lt; n)<\/strong> \u8fd9\u4e2a\u5224\u65ad\uff0c\u4e3a\u4ec0\u4e48\u4e0d\u7528m + n &gt; SIZE_MAX\u5462\uff1f\u56e0\u4e3a\uff0c\u5982\u679c m + n \u6ea2\u51fa\u540e\uff0c\u5c31\u88ab\u622a\u65ad\u4e86\uff0c\u6240\u4ee5\u8868\u8fbe\u5f0f\u6052\u771f\uff0c\u4e5f\u5c31\u68c0\u6d4b\u4e0d\u51fa\u6765\u4e86\u3002\u53e6\u5916\uff0c\u8fd9\u4e2a\u8868\u8fbe\u5f0f\u4e2d\uff0cm\u548cn\u5206\u522b\u4f1a\u88ab\u63d0\u5347\u4e3aunsigned\u3002<\/p>\n<p>\u4f46\u662f\u4e0a\u9762\u7684\u4ee3\u7801\u662f\u9519\u7684\uff0c\u56e0\u4e3a\uff1a<\/p>\n<p style=\"padding-left: 30px;\">1\uff09\u68c0\u67e5\u7684\u592a\u665a\u4e86\uff0cif\u4e4b\u524d\u7f16\u8bd1\u5668\u7684undefined\u884c\u4e3a\u5c31\u5df2\u7ecf\u51fa\u6765\u4e86\uff08\u4f60\u4e0d\u77e5\u9053\u4ec0\u4e48\u4f1a\u53d1\u751f\uff09\u3002<\/p>\n<p style=\"padding-left: 30px;\">2\uff09\u5c31\u50cf\u524d\u9762\u8bf4\u7684\u4e00\u6837\uff0c(SIZE_MAX &#8211; m &lt; n) \u53ef\u80fd\u4f1a\u88ab\u7f16\u8bd1\u5668\u4f18\u5316\u6389\u3002<\/p>\n<p style=\"padding-left: 30px;\">3\uff09\u53e6\u5916\uff0cSIZE_MAX\u662fsize_t\u7684\u6700\u5927\u503c\uff0csize_t\u572864\u4f4d\u7cfb\u7edf\u4e0b\u662f64\u4f4d\u7684\uff0c\u4e25\u8c28\u70b9\u5e94\u8be5\u7528INT_MAX\u6216\u662fUINT_MAX<\/p>\n<p>\u00a0\u6240\u4ee5\uff0c\u6b63\u786e\u7684\u4ee3\u7801\u5e94\u8be5\u662f\u4e0b\u9762\u8fd9\u6837\uff1a<\/p>\n<pre class=\"EnlighterJSRAW\" data-enlighter-language=\"c\"> void foo(int m, int n)\n{\n\u00a0 \u00a0 size_t s = 0;\n\u00a0 \u00a0 if ( m&gt;0 &amp;&amp; n&gt;0 &amp;&amp; ( UINT_MAX - m &lt; n ) ){\n        \/\/error handling...\n        return;\n    }\n    s = (size_t)m + (size_t)n;\n}<\/pre>\n<p>\u5728\u300a<a href=\"https:\/\/developer.apple.com\/library\/ios\/documentation\/Security\/Conceptual\/SecureCodingGuide\/SecureCodingGuide.pdf\" target=\"_blank\" rel=\"noopener noreferrer\">\u82f9\u679c\u5b89\u5168\u7f16\u7801\u89c4\u8303<\/a>\u300b\uff08PDF\uff09\u4e2d\uff0c\u7b2c28\u9875\u7684\u4ee3\u7801\u4e2d\uff1a<\/p>\n<p><img decoding=\"async\" loading=\"lazy\" class=\"aligncenter size-full wp-image-11472\" src=\"https:\/\/coolshell.cn\/wp-content\/uploads\/2014\/04\/apple_security_code.jpg\" alt=\"\" width=\"300\" height=\"94\" \/><\/p>\n<p>\u5982\u679cn\u548cm\u90fd\u662fsigned int\uff0c\u90a3\u4e48\u8fd9\u6bb5\u4ee3\u7801\u662f\u9519\u7684\u3002\u6b63\u786e\u7684\u5e94\u8be5\u50cf\u4e0a\u9762\u7684\u90a3\u4e2a\u4f8b\u5b50\u4e00\u6837\uff0c\u81f3\u5c11\u8981\u5728n<em>m\u65f6\u8981\u628a n \u548c m \u7ed9 cast \u6210 size_t\u3002\u56e0\u4e3a\uff0cn<\/em>m\u53ef\u80fd\u5df2\u7ecf\u6ea2\u51fa\u4e86\uff0c\u5df2\u7ecfundefined\u4e86\uff0cundefined\u7684\u4ee3\u7801\u8f6c\u6210size_t\u5df2\u7ecf\u6ca1\u4ec0\u4e48\u610f\u4e49\u4e86\u3002\uff08\u5982\u679cm\u548cn\u662funsigned int\uff0c\u4e5f\u4f1a\u6ea2\u51fa\uff09\uff0c\u4e0a\u9762\u7684\u4ee3\u7801\u4ec5\u5728m\u548cn\u662fsize_t\u7684\u65f6\u5019\u624d\u6709\u6548\u3002<\/p>\n<p>\u4e0d\u7ba1\u600e\u4e48\u8bf4\uff0c\u300a<a href=\"https:\/\/developer.apple.com\/library\/ios\/documentation\/Security\/Conceptual\/SecureCodingGuide\/SecureCodingGuide.pdf\" target=\"_blank\" rel=\"noopener noreferrer\">\u82f9\u679c\u5b89\u5168\u7f16\u7801\u89c4\u8303<\/a>\u300b\u7edd\u5bf9\u503c\u5f97\u4f60\u53bb\u8bfb\u4e00\u8bfb\u3002<\/p>\n<h5><span class=\"ez-toc-section\" id=\"%E4%BA%8C%E5%88%86%E5%8F%96%E4%B8%AD%E6%90%9C%E7%B4%A2%E7%AE%97%E6%B3%95%E4%B8%AD%E7%9A%84%E6%BA%A2%E5%87%BA\"><\/span>\u4e8c\u5206\u53d6\u4e2d\u641c\u7d22\u7b97\u6cd5\u4e2d\u7684\u6ea2\u51fa<span class=\"ez-toc-section-end\"><\/span><\/h5>\n<p>\u6211\u4eec\u518d\u6765\u770b\u4e00\u4e2a\u4e8c\u5206\u53d6\u4e2d\u641c\u7d22\u7b97\u6cd5\uff08binary search\uff09\uff0c\u5927\u591a\u6570\u4eba\u90fd\u4f1a\u5199\u6210\u4e0b\u9762\u8fd9\u4e2a\u6837\u5b50\uff1a<\/p>\n<pre class=\"EnlighterJSRAW\" data-enlighter-language=\"c\">int binary_search(int a[], int len, int key)\n{\n    int low = 0; \n    int high = len - 1; \n\n    while ( low&lt;=high ) {\n        int mid = (low + high)\/2;\n        if (a[mid] == key) {\n            return mid;\n        }\n        if (key &lt; a[mid]) {\n            high = mid - 1;\n        }else{\n            low = mid + 1;\n        }\n    }\n    return -1;\n}<\/pre>\n<p>\u4e0a\u9762\u8fd9\u4e2a\u4ee3\u7801\u4e2d\uff0c\u4f60\u53ef\u80fd\u4f1a\u6709\u8fd9\u6837\u7684\u60f3\u6cd5\uff1a<\/p>\n<p>1\uff09 \u6211\u4eec\u5e94\u8be5\u7528size_t\u6765\u505alen, low, high, mid\u8fd9\u4e9b\u53d8\u91cf\u7684\u7c7b\u578b\u3002\u6ca1\u9519\uff0c\u5e94\u8be5\u662f\u8fd9\u6837\u7684\u3002\u4f46\u662f\u5982\u679c\u8fd9\u6837\uff0c\u4f60\u8981\u5c0f\u5fc3\u7b2c\u56db\u884c int high = len -1; \u5982\u679clen\u4e3a0\uff0c\u90a3\u4e48\u5c31\u201chigh\u5927\u53d1\u4e86\u201d\u3002<\/p>\n<p>2\uff09 \u65e0\u8bba\u4f60\u7528\u4e0d\u7528size_t\u3002\u6211\u4eec\u5728\u8ba1\u7b97mid = (low+high)\/2; \u7684\u65f6\u5019\uff0c(low + high) \u90fd\u53ef\u4ee5\u6ea2\u51fa\u3002\u6b63\u786e\u7684\u5199\u6cd5\u5e94\u8be5\u662f\uff1a<\/p>\n<pre class=\"EnlighterJSRAW\" data-enlighter-language=\"c\">int mid = low + (high - low)\/2;<\/pre>\n<h5><span class=\"ez-toc-section\" id=\"%E4%B8%8A%E6%BA%A2%E5%87%BA%E5%92%8C%E4%B8%8B%E6%BA%A2%E5%87%BA%E7%9A%84%E6%A3%80%E6%9F%A5\"><\/span>\u4e0a\u6ea2\u51fa\u548c\u4e0b\u6ea2\u51fa\u7684\u68c0\u67e5<span class=\"ez-toc-section-end\"><\/span><\/h5>\n<p>\u524d\u9762\u7684\u4ee3\u7801\u53ea\u5224\u65ad\u4e86\u6b63\u6570\u7684\u4e0a\u6ea2\u51faoverflow\uff0c\u6ca1\u6709\u5224\u65ad\u8d1f\u6570\u7684\u4e0b\u6ea2\u51faunderflow\u3002\u8ba9\u4eec\u6765\u770b\u770b\u600e\u4e48\u5224\u65ad\uff1a<\/p>\n<p>\u5bf9\u4e8e\u52a0\u6cd5\uff0c\u8fd8\u597d\u3002<\/p>\n<pre class=\"EnlighterJSRAW\" data-enlighter-language=\"c\">#include &lt;limits.h&gt;\n\nvoid f(signed int si_a, signed int si_b) {\n    signed int sum;\n    if (((si_b &gt; 0) &amp;&amp; (si_a &gt; (INT_MAX - si_b))) ||\n        ((si_b &lt; 0) &amp;&amp; (si_a &lt; (INT_MIN - si_b)))) {\n        \/* Handle error *\/\n        return;\n    }\n    sum = si_a + si_b;\n}<\/pre>\n<p>\u5bf9\u4e8e\u4e58\u6cd5\uff0c\u5c31\u4f1a\u5f88\u590d\u6742\uff08\u4e0b\u9762\u7684\u4ee3\u7801\u592a\u5938\u5f20\u4e86\uff09\uff1a<\/p>\n<pre class=\"EnlighterJSRAW\" data-enlighter-language=\"c\">void func(signed int si_a, signed int si_b)\n{\n  signed int result;\n  if (si_a &gt; 0) {  \/* si_a is positive *\/\n    if (si_b &gt; 0) {  \/* si_a and si_b are positive *\/\n      if (si_a &gt; (INT_MAX \/ si_b)) {\n        \/* Handle error *\/\n      }\n    } else { \/* si_a positive, si_b nonpositive *\/\n      if (si_b &lt; (INT_MIN \/ si_a)) {\n        \/* Handle error *\/\n      }\n    } \/* si_a positive, si_b nonpositive *\/\n  } else { \/* si_a is nonpositive *\/\n    if (si_b &gt; 0) { \/* si_a is nonpositive, si_b is positive *\/\n      if (si_a &lt; (INT_MIN \/ si_b)) {\n        \/* Handle error *\/\n      }\n    } else { \/* si_a and si_b are nonpositive *\/\n      if ( (si_a != 0) &amp;&amp; (si_b &lt; (INT_MAX \/ si_a))) {\n        \/* Handle error *\/\n      }\n    } \/* End if si_a and si_b are nonpositive *\/\n  } \/* End if si_a is nonpositive *\/\n\n  result = si_a * si_b;\n}<\/pre>\n<p>\u66f4\u591a\u7684\u9632\u6b62\u5728\u64cd\u4f5c\u4e2d\u6574\u578b\u6ea2\u51fa\u7684\u5b89\u5168\u4ee3\u7801\u53ef\u4ee5\u53c2\u770b\u300a<a href=\"https:\/\/www.securecoding.cert.org\/confluence\/display\/seccode\/INT32-C.+Ensure+that+operations+on+signed+integers+do+not+result+in+overflow\">INT32-C. Ensure that operations on signed integers do not result in overflow<\/a>\u300b<\/p>\n<h4><span class=\"ez-toc-section\" id=\"%E5%85%B6%E5%AE%83\"><\/span>\u5176\u5b83<span class=\"ez-toc-section-end\"><\/span><\/h4>\n<p>\u5bf9\u4e8eC++\u6765\u8bf4\uff0c\u4f60\u5e94\u8be5\u4f7f\u7528STL\u4e2d\u7684numeric_limits::max() \u6765\u68c0\u67e5\u6ea2\u51fa\u3002<\/p>\n<p>\u53e6\u5916\uff0c\u5fae\u8f6f\u7684SafeInt\u7c7b\u662f\u4e00\u4e2a\u53ef\u4ee5\u5e2e\u4f60\u8fdc\u7406\u4e0a\u9762\u8fd9\u4e9b\u5f88tricky\u7684\u7c7b\uff0c\u4e0b\u8f7d\u5730\u5740\uff1a<a href=\"http:\/\/safeint.codeplex.com\/\" target=\"_blank\" rel=\"noopener noreferrer\">http:\/\/safeint.codeplex.com\/<\/a><\/p>\n<p>\u5bf9\u4e8eJava \u6765\u8bf4\uff0c\u4e00\u79cd\u662f\u7528JDK 1.7\u4e2dMath\u5e93\u4e0b\u7684safe\u6253\u5934\u7684\u51fd\u6570\uff0c\u5982safeAdd()\u548csafeMultiply()\uff0c\u53e6\u4e00\u79cd\u7528\u66f4\u5927\u5c3a\u5bf8\u7684\u6570\u636e\u7c7b\u578b\uff0c\u6700\u5927\u53ef\u4ee5\u5230BigInteger\u3002<\/p>\n<p>\u53ef\u89c1\uff0c\u5199\u4e00\u4e2a\u5b89\u5168\u7684\u4ee3\u7801\u5e76\u4e0d\u5bb9\u6613\uff0c\u5c24\u5176\u5bf9\u4e8eC\/C++\u6765\u8bf4\u3002\u5bf9\u4e8e\u9ed1\u5ba2\u6765\u8bf4\uff0c\u4ed6\u4eec\u53ea\u9700\u8981\u641c\u4e00\u4e0b\u5f00\u6e90\u8f6f\u4ef6\u4e2d\u4ee3\u7801\u6709memcpy\/strcpy\u4e4b\u7c7b\u7684\u5730\u65b9\uff0c\u7136\u540e\u770b\u4e00\u770b\u5176\u5468\u8fb9\u7684\u4ee3\u7801\uff0c\u662f\u5426\u53ef\u4ee5\u901a\u8fc7\u7528\u6237\u7684\u8f93\u5165\u6765\u5f71\u54cd\uff0c\u5982\u679c\u6709\u7684\u8bdd\uff0c\u4f60\u5c31\u60e8\u4e86\u3002<\/p>\n<p><strong>\u53c2\u8003<\/strong>\uff1a<\/p>\n<ul>\n<li><a href=\"http:\/\/phrack.org\/issues\/60\/10.html\" target=\"_blank\" rel=\"noopener noreferrer\">Basic Integer Overflow<\/a><\/li>\n<\/ul>\n<ul>\n<li><a href=\"https:\/\/www.owasp.org\/index.php\/Integer_overflow\" target=\"_blank\" rel=\"noopener noreferrer\">OWASP\uff1aInteger overflow<\/a><\/li>\n<\/ul>\n<ul>\n<li><a href=\"https:\/\/www.kb.cert.org\/vuls\/id\/162289\" target=\"_blank\" rel=\"noopener noreferrer\">C compilers may silently discard some wraparound checks<\/a><\/li>\n<\/ul>\n<ul>\n<li><a href=\"https:\/\/developer.apple.com\/library\/ios\/documentation\/Security\/Conceptual\/SecureCodingGuide\/SecureCodingGuide.pdf\" target=\"_blank\" rel=\"noopener noreferrer\">Apple Secure Coding Guide<\/a><\/li>\n<\/ul>\n<ul>\n<li><a href=\"http:\/\/en.wikipedia.org\/wiki\/Undefined_behavior\" target=\"_blank\" rel=\"noopener noreferrer\">Wikipedia: Undefined Behavior<\/a><\/li>\n<\/ul>\n<ul>\n<li>\n<p id=\"title-text\" class=\"with-breadcrumbs\"><a href=\"https:\/\/www.securecoding.cert.org\/confluence\/display\/seccode\/INT32-C.+Ensure+that+operations+on+signed+integers+do+not+result+in+overflow\">INT32-C. Ensure that operations on signed integers do not result in overflow<\/a><\/p>\n<\/li>\n<\/ul>\n<p>\u6700\u540e\uff0c\u00a0\u4e0d\u597d\u610f\u601d\uff0c\u8fd9\u7bc7\u6587\u7ae0\u53ef\u80fd\u7f57\u55e6\u4e86\u4e00\u4e9b\uff0c\u5927\u5bb6\u89c1\u8c05\u3002<\/p>\n<p>\uff08\u5168\u6587\u5b8c\uff09<\/p>\n","raw":"","protected":false},"excerpt":{"rendered":"<p>\u6574\u578b\u6ea2\u51fa\u6709\u70b9\u8001\u751f\u5e38\u8c08\u4e86\uff0cbla, bla, bla&#8230; \u4f46\u4f3c\u4e4e\u6ca1\u6709\u5f15\u8d77\u591a\u5c11\u4eba\u7684\u91cd\u89c6\u3002\u6574\u578b\u6ea2\u51fa\u4f1a\u6709\u53ef\u80fd\u5bfc\u81f4\u7f13\u51b2\u533a\u6ea2\u51fa\uff0c\u7f13\u51b2\u533a\u6ea2\u51fa\u4f1a\u5bfc\u81f4\u5404\u79cd\u9ed1\u5ba2\u653b\u51fb\uff0c\u6bd4\u5982&#8230;<\/p>\n<p class=\"read-more\"><a class=\"btn btn-default\" href=\"https:\/\/coolshell.cn\/articles\/11466.html\"> Read More<span class=\"screen-reader-text\">  Read More<\/span><\/a><\/p>\n","protected":false},"author":2,"featured_media":0,"comment_status":"open","ping_status":"open","sticky":false,"template":"","format":"standard","meta":[],"categories":[5,23,3,6],"tags":[59,725,318],"series":[],"aioseo_notices":[],"views":109757,"post_thumbnail_image":"https:\/\/coolshell.cn\/wp-content\/uploads\/2014\/04\/c99.jpg","content_first_image":"https:\/\/coolshell.cn\/wp-content\/uploads\/2014\/04\/c99.jpg","post_medium_image_300":"https:\/\/coolshell.cn\/wp-content\/uploads\/2014\/04\/c99.jpg","post_thumbnail_image_624":"https:\/\/coolshell.cn\/wp-content\/uploads\/2014\/04\/c99.jpg","post_frist_image":"https:\/\/coolshell.cn\/wp-content\/uploads\/2014\/04\/c99.jpg","post_medium_image":"https:\/\/coolshell.cn\/wp-content\/uploads\/2014\/04\/c99.jpg","post_large_image":"https:\/\/coolshell.cn\/wp-content\/uploads\/2014\/04\/c99.jpg","post_full_image":"https:\/\/coolshell.cn\/wp-content\/uploads\/2014\/04\/c99.jpg","post_all_images":[{"imagesurl":"https:\/\/coolshell.cn\/wp-content\/uploads\/2014\/04\/c99.jpg","id":"image0"},{"imagesurl":"https:\/\/coolshell.cn\/wp-content\/uploads\/2014\/04\/apple_security_code.jpg","id":"image1"}],"videoAdId":"","listAd":"0","listAdId":"","listAdEvery":5,"total_comments":96,"category_name":"C\/C++\u8bed\u8a00","post_date":"2014-04-21","like_count":"0","praiseWord":"\u9f13\u52b1","excitationAd":"0","rewardedVideoAdId":"","detailAdId":"","detailAd":"0","enterpriseMinapp":"0","audios":[],"postImageUrl":"http:\/\/coolshell.cn\/wp-content\/uploads\/2016\/09\/coolshell-360x200.jpg","avatarurls":[],"related_posts":[],"pageviews":109758,"pageviews_wl":92052,"ratings_average":4,"ratings_total":204,"ratings_users":47,"next_post_id":11564,"next_post_title":"TCP \u7684\u90a3\u4e9b\u4e8b\u513f\uff08\u4e0a\uff09","previous_post_id":11454,"previous_post_title":"\u4eceLongAdder\u770b\u66f4\u9ad8\u6548\u7684\u65e0\u9501\u5b9e\u73b0"}