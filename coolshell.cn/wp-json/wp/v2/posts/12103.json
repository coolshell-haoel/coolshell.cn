{"id":12103,"date":"2014-11-21T00:48:27","date_gmt":"2014-11-20T16:48:27","guid":{"rendered":"http:\/\/coolshell.cn\/?p=12103"},"modified":"2016-12-25T10:54:57","modified_gmt":"2016-12-25T02:54:57","slug":"vfork-%e6%8c%82%e6%8e%89%e7%9a%84%e4%b8%80%e4%b8%aa%e9%97%ae%e9%a2%98","status":"publish","type":"post","link":"https:\/\/coolshell.cn\/articles\/12103.html","title":{"rendered":"vfork \u6302\u6389\u7684\u4e00\u4e2a\u95ee\u9898"},"content":{"rendered":"<p><img decoding=\"async\" loading=\"lazy\" class=\"alignright wp-image-12105\" src=\"https:\/\/coolshell.cn\/wp-content\/uploads\/2014\/11\/tux-fork-298x300.gif\" alt=\"tux-fork\" width=\"199\" height=\"200\" srcset=\"https:\/\/coolshell.cn\/wp-content\/uploads\/2014\/11\/tux-fork-298x300.gif 298w, https:\/\/coolshell.cn\/wp-content\/uploads\/2014\/11\/tux-fork-150x150.gif 150w, https:\/\/coolshell.cn\/wp-content\/uploads\/2014\/11\/tux-fork-200x200.gif 200w, https:\/\/coolshell.cn\/wp-content\/uploads\/2014\/11\/tux-fork-268x270.gif 268w\" sizes=\"(max-width: 199px) 100vw, 199px\" \/>\u5728\u77e5\u4e4e\u4e0a\uff0c\u6709\u4e2a\u4eba\u95ee\u4e86\u8fd9\u6837\u7684<a href=\"http:\/\/www.zhihu.com\/question\/26591968\" target=\"_blank\">\u4e00\u4e2a\u95ee\u9898<\/a>\u2014\u2014\u4e3a\u4ec0\u4e48vfork\u7684\u5b50\u8fdb\u7a0b\u91cc\u7528return\uff0c\u6574\u4e2a\u7a0b\u5e8f\u4f1a\u6302\u6389\uff0c\u800c\u4e14exit()\u4e0d\u4f1a\uff1f\u5e76\u7ed9\u51fa\u4e86\u5982\u4e0b\u7684\u4ee3\u7801\uff0c\u4e0b\u9762\u7684\u4ee3\u7801\u4e00\u8fd0\u884c\u5c31\u6302\u6389\u4e86\uff0c\u4f46\u5982\u679c\u628a\u5b50\u8fdb\u7a0b\u7684return\u6539\u6210exit(0)\u5c31\u6ca1\u4e8b\u3002<\/p>\n<p>\u6211\u53d7\u9080\u540e\u672c\u6765\u4e0d\u60f3\u56de\u7b54\u8fd9\u4e2a\u95ee\u9898\u7684\uff0c\u56e0\u4e3a\u8fd9\u4e2a\u95ee\u9898\u660e\u663e\u5c31\u662fRTFM\u7684\u4e8b\uff0c\u540e\u6765\uff0c\u53d1\u73b0\u8fd9\u4e2a\u95ee\u9898\u653e\u5728\u90a3\u91cc\u597d\u957f\u65f6\u95f4\uff0c\u800c\u6302\u5728\u4e0b\u9762\u7684\u51e0\u4e2a\u7b54\u6848\u53c8\u8dd1\u504f\u5f97\u6bd4\u8f83\u4e25\u91cd\uff0c\u6211\u89c9\u5f97\u53ef\u80fd\u6709\u4e9b\u670b\u53cb\u770b\u5230\u90a3\u6837\u7684\u7b54\u6848\u4f1a\u88ab\u8bef\u5bfc\uff0c\u6240\u4ee5\u5c31\u4e0a\u53bb\u56de\u7b54\u4e86\u4e00\u4e0b\u8fd9\u4e2a\u95ee\u9898\u3002<\/p>\n<p>\u4e0b\u9762\u6211\u628a\u95ee\u9898\u548c\u6211\u7684\u56de\u7b54\u53d1\u5e03\u5728\u8fd9\u91cc\uff0c\u4e5f\u4f9b\u66f4\u591a\u7684\u4eba\u67e5\u770b\u3002<\/p>\n<pre data-enlighter-language=\"c\" class=\"EnlighterJSRAW\">#include &lt;stdio.h&gt;\r\n#include &lt;stdlib.h&gt;\r\n#include &lt;unistd.h&gt;\r\nint main(void) {\r\n    int var;\r\n    var = 88;\r\n    if ((pid = vfork()) &lt; 0) {\r\n        printf(&quot;vfork error&quot;);\r\n        exit(-1);\r\n    } else if (pid == 0) { \/* \u5b50\u8fdb\u7a0b *\/\r\n        var++;\r\n        return 0;\r\n    }\r\n    printf(&quot;pid=%d, glob=%d, var=%d\\n&quot;, getpid(), glob, var);\r\n    return 0;\r\n}\r\n<\/pre>\n<p><!--more--><\/p>\n<h4><b>\u57fa\u7840\u77e5\u8bc6<\/b><\/h4>\n<p>\u9996\u5148\u8bf4\u4e00\u4e0bfork\u548cvfork\u7684\u5dee\u522b\uff1a<\/p>\n<ul>\n<li>fork \u662f \u521b\u5efa\u4e00\u4e2a\u5b50\u8fdb\u7a0b\uff0c\u5e76\u628a\u7236\u8fdb\u7a0b\u7684\u5185\u5b58\u6570\u636ecopy\u5230\u5b50\u8fdb\u7a0b\u4e2d\u3002<\/li>\n<li>vfork\u662f \u521b\u5efa\u4e00\u4e2a\u5b50\u8fdb\u7a0b\uff0c\u5e76\u548c\u7236\u8fdb\u7a0b\u7684\u5185\u5b58\u6570\u636eshare\u4e00\u8d77\u7528\u3002<\/li>\n<\/ul>\n<p>\u8fd9\u4e24\u4e2a\u7684\u5dee\u522b\u662f\uff0c\u4e00\u4e2a\u662fcopy\uff0c\u4e00\u4e2a\u662fshare\u3002\uff08\u5173\u4e8efork\uff0c\u53ef\u4ee5\u53c2\u770b\u9177\u58f3\u4e4b\u524d\u7684\u300a<a title=\"\u4e00\u4e2afork\u7684\u9762\u8bd5\u9898\" href=\"https:\/\/coolshell.cn\/articles\/7965.html\" target=\"_blank\">\u4e00\u9053fork\u7684\u9762\u8bd5\u9898<\/a>\u300b\uff09<\/p>\n<p>\u4f60 man vfork \u4e00\u4e0b\uff0c\u4f60\u53ef\u4ee5\u770b\u5230\uff0cvfork\u662f\u8fd9\u6837\u7684\u5de5\u4f5c\u7684\uff0c<\/p>\n<p style=\"padding-left: 30px;\">1\uff09\u4fdd\u8bc1\u5b50\u8fdb\u7a0b\u5148\u6267\u884c\u3002<br \/>\n2\uff09\u5f53\u5b50\u8fdb\u7a0b\u8c03\u7528exit()\u6216exec()\u540e\uff0c\u7236\u8fdb\u7a0b\u5f80\u4e0b\u6267\u884c\u3002<\/p>\n<p>\u90a3\u4e48\uff0c\u4e3a\u4ec0\u4e48\u8981\u5e72\u51fa\u4e00\u4e2avfork\u8fd9\u4e2a\u73a9\u610f\uff1f \u539f\u56e0\u5728man page\u4e5f\u8bb2\u5f97\u5f88\u6e05\u695a\u4e86\uff1a<\/p>\n<blockquote><p><strong>Historic Description<\/strong><\/p>\n<p>Under Linux, fork(2) is implemented using copy-on-write pages, so the only penalty incurred by fork(2) is the time and memory required to duplicate the parent\u2019s page tables, and to create a unique task structure for the child. <b>However, in the bad old days a fork(2) would require making <\/b><b>a complete copy of the caller\u2019s data space, often needlessly, since usually immediately afterwards an exec(3) is done. Thus, for greater efficiency, BSD introduced the vfork() system call, which did not fully copy the address space of the parent process, but borrowed the parent\u2019s mem<\/b><b>ory and thread of control until a call to execve(2) or an exit occurred.<\/b> The parent process was suspended while the child was using its resources. The use of vfork() was tricky: for example, not modifying data in the parent process depended on knowing which variables are held in a register.<\/p><\/blockquote>\n<p>\u610f\u601d\u662f\u8fd9\u6837\u7684\u2014\u2014 <b>\u8d77\u521d\u53ea\u6709fork\uff0c\u4f46\u662f\u5f88\u591a\u7a0b\u5e8f\u5728fork\u4e00\u4e2a\u5b50\u8fdb\u7a0b\u540e\u5c31exec\u4e00\u4e2a\u5916\u90e8\u7a0b\u5e8f\uff0c\u4e8e\u662ffork\u9700\u8981copy\u7236\u8fdb\u7a0b\u7684\u6570\u636e\u8fd9\u4e2a\u52a8\u4f5c\u5c31\u53d8\u5f97\u6beb\u65e0\u610f\u4e86\uff0c\u800c\u4e14\u8fd9\u6837\u5e72\u8fd8\u5f88\u91cd<\/b>\uff08\u6ce8\uff1a\u540e\u6765\uff0cfork\u505a\u4e86\u4f18\u5316\uff0c\u8be6\u89c1\u672c\u6587\u540e\u9762\uff09<b>\uff0c\u6240\u4ee5\uff0cBSD\u641e\u51fa\u4e86\u4e2a\u7236\u5b50\u8fdb\u7a0b\u5171\u4eab\u7684 vfork\uff0c\u8fd9\u6837\u6210\u672c\u6bd4\u8f83\u4f4e\u3002\u56e0\u6b64\uff0cvfork\u672c\u5c31\u662f\u4e3a\u4e86exec\u800c\u751f\u3002<\/b><\/p>\n<h4><b>\u4e3a\u4ec0\u4e48return\u4f1a\u6302\u6389\uff0cexit()\u4e0d\u4f1a\uff1f<\/b><\/h4>\n<p>\u4ece\u4e0a\u9762\u6211\u4eec\u77e5\u9053\uff0c<b>\u7ed3\u675f\u5b50\u8fdb\u7a0b\u7684\u8c03\u7528\u662fexit()\u800c\u4e0d\u662freturn\uff0c\u5982\u679c\u4f60\u5728vfork\u4e2dreturn\u4e86\uff0c\u90a3\u4e48\uff0c\u8fd9\u5c31\u610f\u5473main()\u51fd\u6570return\u4e86\uff0c\u6ce8\u610f\u56e0\u4e3a\u51fd\u6570\u6808\u7236\u5b50\u8fdb\u7a0b\u5171\u4eab\uff0c\u6240\u4ee5\u6574\u4e2a\u7a0b\u5e8f\u7684\u6808\u5c31\u8dea\u4e86\u3002<\/b><\/p>\n<p>\u5982\u679c\u4f60\u5728\u5b50\u8fdb\u7a0b\u4e2dreturn\uff0c\u90a3\u4e48\u57fa\u672c\u662f\u4e0b\u9762\u7684\u8fc7\u7a0b\uff1a<\/p>\n<p style=\"padding-left: 30px;\"><b>1\uff09\u5b50\u8fdb\u7a0b\u7684main() \u51fd\u6570 return\u4e86\uff0c\u4e8e\u662f\u7a0b\u5e8f\u7684\u51fd\u6570\u6808\u53d1\u751f\u4e86\u53d8\u5316\u3002<\/b><\/p>\n<p style=\"padding-left: 30px;\"><b>2\uff09\u800cmain()\u51fd\u6570return\u540e\uff0c\u901a\u5e38\u4f1a\u8c03\u7528 exit()\u6216\u76f8\u4f3c\u7684\u51fd\u6570<\/b>\uff08\u5982\uff1a_exit()\uff0cexitgroup()\uff09<\/p>\n<p style=\"padding-left: 30px;\"><b>3\uff09\u8fd9\u65f6\uff0c\u7236\u8fdb\u7a0b\u6536\u5230\u5b50\u8fdb\u7a0bexit()\uff0c\u5f00\u59cb\u4ecevfork\u8fd4\u56de\uff0c\u4f46\u662f\u5c3c\u739b\uff0c\u8001\u5b50\u7684\u6808\u90fd\u88ab\u4f60\u5b50\u8fdb\u7a0b\u7ed9return\u5e72\u5e9f\u6389\u4e86\uff0c\u4f60\u8ba9\u6211\u600e\u4e48\u6267\u884c\uff1f<\/b>\uff08\u6ce8\uff1a\u6808\u4f1a\u8fd4\u56de\u4e00\u4e2a\u8be1\u5f02\u4e00\u4e2a\u6808\u5730\u5740\uff0c\u5bf9\u4e8e\u67d0\u4e9b\u5185\u6838\u7248\u672c\u7684\u5b9e\u73b0\uff0c\u76f4\u63a5\u62a5\u201c\u6808\u9519\u8bef\u201d\u5c31\u7ed9\u8dea\u4e86\uff0c\u7136\u800c\uff0c\u5bf9\u4e8e\u67d0\u4e9b\u5185\u6838\u7248\u672c\u7684\u5b9e\u73b0\uff0c\u4e8e\u662f\u6709\u53ef\u80fd\u4f1a\u518d\u6b21\u8c03\u7528main()\uff0c\u4e8e\u662f\u8fdb\u5165\u4e86\u4e00\u4e2a\u65e0\u9650\u5faa\u73af\u7684\u7ed3\u679c\uff0c\u76f4\u5230vfork \u8c03\u7528\u8fd4\u56de error\uff09<\/p>\n<p>\u597d\u4e86\uff0c\u73b0\u5728\u518d\u56de\u5230 return \u548c exit\uff0creturn\u4f1a\u91ca\u653e\u5c40\u90e8\u53d8\u91cf\uff0c\u5e76\u5f39\u6808\uff0c\u56de\u5230\u4e0a\u7ea7\u51fd\u6570\u6267\u884c\u3002exit\u76f4\u63a5\u9000\u6389\u3002\u5982\u679c\u4f60\u7528c++ \u4f60\u5c31\u77e5\u9053\uff0creturn\u4f1a\u8c03\u7528\u5c40\u90e8\u5bf9\u8c61\u7684\u6790\u6784\u51fd\u6570\uff0cexit\u4e0d\u4f1a\u3002\uff08\u6ce8\uff1aexit\u4e0d\u662f\u7cfb\u7edf\u8c03\u7528\uff0c\u662fglibc\u5bf9\u7cfb\u7edf\u8c03\u7528 _exit()\u6216_exitgroup()\u7684\u5c01\u88c5\uff09<\/p>\n<p>\u53ef\u89c1\uff0c<b>\u5b50\u8fdb\u7a0b\u8c03\u7528exit() \u6ca1\u6709\u4fee\u6539\u51fd\u6570\u6808\uff0c\u6240\u4ee5\uff0c\u7236\u8fdb\u7a0b\u5f97\u4ee5\u987a\u5229\u6267\u884c<\/b>\u3002<\/p>\n<p><strong>\u4f46\u662f\uff01\u6ce8\u610f\uff01\u5982\u679c\u4f60\u8c03\u7528 exit() \u51fd\u6570\uff0c\u8fd8\u662f\u4f1a\u6709\u95ee\u9898\u7684\uff0c\u6b63\u786e\u7684\u65b9\u6cd5\u5e94\u8be5\u662f\u8c03\u7528 _exit() \u51fd\u6570\uff0c\u56e0\u4e3a exit() \u51fd\u6570 \u4f1a flush \u5e76 close \u6240\u6709\u7684 \u6807\u51c6 I\/O \uff0c\u8fd9\u6837\u4f1a\u5bfc\u81f4\u7236\u8fdb\u7a0b\u53d7\u5230\u5f71\u54cd\u3002\uff08\u8fd9\u4e2a\u60c5\u51b5\u5728fork\u4e0b\u4e5f\u4f1a\u53d7\u5230\u5f71\u54cd\uff0c\u4f1a\u5bfc\u81f4\u4e00\u4e9b\u88abbuffer\u7684\u6570\u636e\u88abflush\u4e24\u6b21\uff0c\u8fd9\u91cc\u53ef\u4ee5\u53c2\u770b\u300a<a href=\"https:\/\/coolshell.cn\/articles\/7965.html\" target=\"_blank\">\u4e00\u4e2afork\u7684\u9762\u8bd5\u9898<\/a>\u300b\uff09<\/strong><\/p>\n<h4>\u5173\u4e8efork\u7684\u4f18\u5316<\/h4>\n<p>\u5f88\u660e\u663e\uff0cfork\u592a\u91cd\uff0c\u800cvfork\u53c8\u592a\u5371\u9669\uff0c\u6240\u4ee5\uff0c\u5c31\u6709\u4eba\u5f00\u59cb\u4f18\u5316fork\u8fd9\u4e2a\u7cfb\u7edf\u8c03\u7528\u3002\u4f18\u5316\u7684\u6280\u672f\u7528\u5230\u4e86\u8457\u540d\u7684<b>\u5199\u65f6\u62f7\u8d1d\uff08COW\uff09<\/b>\u3002<\/p>\n<p>\u4e5f\u5c31\u662f\u8bf4\uff0c<strong>\u5bf9\u4e8efork\u540e\u5e76\u4e0d\u662f\u9a6c\u4e0a\u62f7\u8d1d\u5185\u5b58\uff0c\u800c\u662f\u53ea\u6709\u4f60\u5728\u9700\u8981\u6539\u53d8\u7684\u65f6\u5019\uff0c\u624d\u4f1a\u4ece\u7236\u8fdb\u7a0b\u4e2d\u62f7\u8d1d\u5230\u5b50\u8fdb\u7a0b\u4e2d\uff0c\u8fd9\u6837fork\u540e\u7acb\u9a6c\u6267\u884cexec\u7684\u6210\u672c\u5c31\u975e\u5e38\u5c0f\u4e86<\/strong>\u3002\u6240\u4ee5\uff0cLinux\u7684Man Page\u4e2d\u5e76\u4e0d\u9f13\u52b1\u4f7f\u7528vfork() \u2014\u2014<\/p>\n<blockquote><p>\u201c It is rather unfortunate that Linux revived this specter from the past. The BSD man page states: &#8220;This system call will be eliminated when proper system sharing mechanisms are implemented. Users should not depend on the memory sharing semantics of vfork() as it will, in that case, be made synonymous to fork(2).&#8221;\u201d<\/p><\/blockquote>\n<p>\u4e8e\u662f\uff0c\u4eceBSD4.4\u5f00\u59cb\uff0c\u4ed6\u4eec\u8ba9vfork\u548cfork\u53d8\u6210\u4e00\u6837\u7684\u4e86<\/p>\n<p>\u4f46\u5728\u540e\u6765\uff0cNetBSD 1.3 \u53c8\u628a\u4f20\u7edf\u7684vfork\u7ed9\u6361\u4e86\u56de\u6765\uff0c\u8bf4\u662fvfork\u7684\u6027\u80fd\u5728 Pentium Pro 200MHz \u7684\u673a\u5668\uff08\u8fd9\u673a\u5668\u597d\u53e4\u8463\u554a\uff09\u4e0a\u6709\u53ef\u4ee5\u63d0\u9ad8\u51e0\u79d2\u949f\u7684\u6027\u80fd\u3002\u8be6\u60c5\u89c1\u2014\u2014\u201c<a class=\" wrap external\" href=\"http:\/\/www.netbsd.org\/docs\/kernel\/vfork.html\" target=\"_blank\" rel=\"nofollow noreferrer\">NetBSD Documentation: Why implement traditional vfork()<i class=\"icon-external\"><\/i><\/a>\u201d<\/p>\n<p>\u4eca\u5929\u7684Linux\u4e0b\uff0cfork\u548cvfork\u8fd8\u662f\u5404\u662f\u5404\u7684\uff0c\u4e0d\u8fc7\uff0c\u8fd8\u662f\u5efa\u8bae\u4f60\u4e0d\u8981\u7528vfork\uff0c\u9664\u975e\u4f60\u975e\u5e38\u5173\u6ce8\u6027\u80fd\u3002<\/p>\n<p>\uff08\u5168\u6587\u5b8c\uff09<\/p>\n","raw":"","protected":false},"excerpt":{"rendered":"<p>\u5728\u77e5\u4e4e\u4e0a\uff0c\u6709\u4e2a\u4eba\u95ee\u4e86\u8fd9\u6837\u7684\u4e00\u4e2a\u95ee\u9898\u2014\u2014\u4e3a\u4ec0\u4e48vfork\u7684\u5b50\u8fdb\u7a0b\u91cc\u7528return\uff0c\u6574\u4e2a\u7a0b\u5e8f\u4f1a\u6302\u6389\uff0c\u800c\u4e14exit()\u4e0d\u4f1a\uff1f\u5e76\u7ed9\u51fa\u4e86\u5982\u4e0b\u7684\u4ee3\u7801\uff0c\u4e0b\u9762\u7684\u4ee3\u7801\u4e00\u8fd0\u884c\u5c31\u6302\u6389&#8230;<\/p>\n<p class=\"read-more\"><a class=\"btn btn-default\" href=\"https:\/\/coolshell.cn\/articles\/12103.html\"> Read More<span class=\"screen-reader-text\">  Read More<\/span><\/a><\/p>\n","protected":false},"author":2,"featured_media":0,"comment_status":"open","ping_status":"open","sticky":false,"template":"","format":"standard","meta":[],"categories":[5,20,18],"tags":[26,37,21,767],"series":[],"aioseo_notices":[],"views":48259,"post_thumbnail_image":"https:\/\/coolshell.cn\/wp-content\/uploads\/2014\/11\/tux-fork.gif","content_first_image":"https:\/\/coolshell.cn\/wp-content\/uploads\/2014\/11\/tux-fork.gif","post_medium_image_300":"https:\/\/coolshell.cn\/wp-content\/uploads\/2014\/11\/tux-fork.gif","post_thumbnail_image_624":"https:\/\/coolshell.cn\/wp-content\/uploads\/2014\/11\/tux-fork.gif","post_frist_image":"https:\/\/coolshell.cn\/wp-content\/uploads\/2014\/11\/tux-fork.gif","post_medium_image":"https:\/\/coolshell.cn\/wp-content\/uploads\/2014\/11\/tux-fork.gif","post_large_image":"https:\/\/coolshell.cn\/wp-content\/uploads\/2014\/11\/tux-fork.gif","post_full_image":"https:\/\/coolshell.cn\/wp-content\/uploads\/2014\/11\/tux-fork.gif","post_all_images":[{"imagesurl":"https:\/\/coolshell.cn\/wp-content\/uploads\/2014\/11\/tux-fork-298x300.gif","id":"image0"}],"videoAdId":"","listAd":"0","listAdId":"","listAdEvery":5,"total_comments":46,"category_name":"C\/C++\u8bed\u8a00","post_date":"2014-11-21","like_count":"0","praiseWord":"\u9f13\u52b1","excitationAd":"0","rewardedVideoAdId":"","detailAdId":"","detailAd":"0","enterpriseMinapp":"0","audios":[],"postImageUrl":"http:\/\/coolshell.cn\/wp-content\/uploads\/2016\/09\/coolshell-360x200.jpg","avatarurls":[],"related_posts":[{"ID":"22320","post_title":"eBPF \u4ecb\u7ecd"}],"pageviews":48260,"pageviews_wl":17068,"ratings_average":4,"ratings_total":236,"ratings_users":54,"next_post_id":17029,"next_post_title":"Docker\u57fa\u7840\u6280\u672f\uff1aLinux Namespace\uff08\u4e0b\uff09","previous_post_id":12052,"previous_post_title":"Leetcode \u7f16\u7a0b\u8bad\u7ec3"}