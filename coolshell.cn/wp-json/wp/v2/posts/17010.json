{"id":17010,"date":"2015-04-16T10:20:08","date_gmt":"2015-04-16T02:20:08","guid":{"rendered":"http:\/\/coolshell.cn\/?p=17010"},"modified":"2020-07-07T11:55:29","modified_gmt":"2020-07-07T03:55:29","slug":"docker%e5%9f%ba%e7%a1%80%e6%8a%80%e6%9c%af%ef%bc%9alinux-namespace%ef%bc%88%e4%b8%8a%ef%bc%89","status":"publish","type":"post","link":"https:\/\/coolshell.cn\/articles\/17010.html","title":{"rendered":"Docker\u57fa\u7840\u6280\u672f\uff1aLinux Namespace\uff08\u4e0a\uff09"},"content":{"rendered":"<p><img decoding=\"async\" loading=\"lazy\" class=\"alignright size-full wp-image-17085\" src=\"https:\/\/coolshell.cn\/wp-content\/uploads\/2015\/04\/isolation.jpg\" alt=\"isolation\" width=\"359\" height=\"237\" srcset=\"https:\/\/coolshell.cn\/wp-content\/uploads\/2015\/04\/isolation.jpg 359w, https:\/\/coolshell.cn\/wp-content\/uploads\/2015\/04\/isolation-300x198.jpg 300w\" sizes=\"(max-width: 359px) 100vw, 359px\" \/>\u65f6\u4e0b\u6700\u70ed\u7684\u6280\u672f\u83ab\u8fc7\u4e8eDocker\u4e86\uff0c\u5f88\u591a\u4eba\u90fd\u89c9\u5f97Docker\u662f\u4e2a\u65b0\u6280\u672f\uff0c\u5176\u5b9e\u4e0d\u7136\uff0cDocker\u9664\u4e86\u5176\u7f16\u7a0b\u8bed\u8a00\u7528go\u6bd4\u8f83\u65b0\u5916\uff0c\u5176\u5b9e\u5b83\u8fd8\u771f\u4e0d\u662f\u4e2a\u65b0\u4e1c\u897f\uff0c\u4e5f\u5c31\u662f\u4e2a\u65b0\u74f6\u88c5\u65e7\u9152\u7684\u4e1c\u897f\uff0c\u6240\u8c13\u7684The New &#8220;Old Stuff&#8221;\u3002Docker\u548cDocker\u884d\u751f\u7684\u4e1c\u897f\u7528\u5230\u4e86\u5f88\u591a\u5f88\u9177\u7684\u6280\u672f\uff0c\u6211\u4f1a\u7528\u51e0\u7bc7 \u6587\u7ae0\u6765\u628a\u8fd9\u4e9b\u6280\u672f\u7ed9\u5927\u5bb6\u505a\u4e2a\u4ecb\u7ecd\uff0c\u5e0c\u671b\u901a\u8fc7\u8fd9\u4e9b\u6587\u7ae0\u5927\u5bb6\u53ef\u4ee5\u81ea\u5df1\u6253\u9020\u4e00\u4e2a\u5c71\u5be8\u7248\u7684docker\u3002<\/p>\n<p>\u5f53\u7136\uff0c\u6587\u7ae0\u7684\u98ce\u683c\u4e00\u5b9a\u4f1a\u5c0a\u91cd\u65f6\u4e0b\u7684\u201c\u6d41\u884c\u201d\u2014\u2014<strong>\u6211\u4eec\u518d\u4e5f\u6ca1\u6709\u6574\u5757\u6574\u5757\u7684\u65f6\u95f4\u53bb\u770b\u4e66\u53bb\u4e13\u7814\uff0c\u800c\u6211\u4eec\u53ea\u6709\u770b\u5fae\u535a\u5fae\u4fe1\u90a3\u6837\u7684\u788e\u7247\u65f6\u95f4<\/strong>\uff08\u90a3\u6015\u6211\u4eec\u6709\u6574\u5757\u7684\u65f6\u95f4\uff0c\u4e5f\u88ab\u90a3\u4e9b\u5728\u624b\u673a\u4e0a\u7684APP\u788e\u7247\u5316\u4e86\uff09\u3002\u6240\u4ee5\uff0c\u8fd9\u4e9b\u6587\u7ae0\u7684\u98ce\u683c\u5fc5\u7136\u575a\u6301\u201c\u9a6c\u6876\u98ce\u683c\u201d\uff08\u5e0c\u671b\u7b80\u5355\u5230\u5360\u7528\u4f60\u62c9\u4e00\u6ce1\u5c4e\u5c31\u65f6\u95f4\uff0c\u800c\u4e14\u4f60\u8fd8\u4e0d\u7528\u52a8\u8111\u5b50\uff0c\u5e76\u80fd\u5b66\u5230\u4e9b\u4e1c\u897f\uff09<\/p>\n<p>\u5e9f\u8bdd\u5c11\u8bf4\uff0c\u6211\u4eec\u5f00\u59cb\u3002\u5148\u4eceLinux Namespace\u5f00\u59cb\u3002<\/p>\n<div id=\"ez-toc-container\" class=\"ez-toc-v2_0_48 counter-hierarchy ez-toc-counter ez-toc-grey ez-toc-container-direction\">\n<div class=\"ez-toc-title-container\">\n<p class=\"ez-toc-title\">\u76ee\u5f55<\/p>\n<span class=\"ez-toc-title-toggle\"><\/span><\/div>\n<nav><ul class='ez-toc-list ez-toc-list-level-1 ' ><li class='ez-toc-page-1 ez-toc-heading-level-4'><a class=\"ez-toc-link ez-toc-heading-1\" href=\"https:\/\/coolshell.cn\/articles\/17010.html\/#_%E7%AE%80%E4%BB%8B\" title=\"\u00a0\u7b80\u4ecb\">\u00a0\u7b80\u4ecb<\/a><\/li><li class='ez-toc-page-1 ez-toc-heading-level-4'><a class=\"ez-toc-link ez-toc-heading-2\" href=\"https:\/\/coolshell.cn\/articles\/17010.html\/#clone%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8\" title=\"clone()\u7cfb\u7edf\u8c03\u7528\">clone()\u7cfb\u7edf\u8c03\u7528<\/a><\/li><li class='ez-toc-page-1 ez-toc-heading-level-4'><a class=\"ez-toc-link ez-toc-heading-3\" href=\"https:\/\/coolshell.cn\/articles\/17010.html\/#UTS_Namespace\" title=\"UTS Namespace\">UTS Namespace<\/a><\/li><li class='ez-toc-page-1 ez-toc-heading-level-4'><a class=\"ez-toc-link ez-toc-heading-4\" href=\"https:\/\/coolshell.cn\/articles\/17010.html\/#IPC_Namespace\" title=\"IPC Namespace\">IPC Namespace<\/a><\/li><li class='ez-toc-page-1 ez-toc-heading-level-4'><a class=\"ez-toc-link ez-toc-heading-5\" href=\"https:\/\/coolshell.cn\/articles\/17010.html\/#PID_Namespace\" title=\"PID Namespace\">PID Namespace<\/a><\/li><li class='ez-toc-page-1 ez-toc-heading-level-4'><a class=\"ez-toc-link ez-toc-heading-6\" href=\"https:\/\/coolshell.cn\/articles\/17010.html\/#Mount_Namespace\" title=\"Mount Namespace\">Mount Namespace<\/a><\/li><li class='ez-toc-page-1 ez-toc-heading-level-4'><a class=\"ez-toc-link ez-toc-heading-7\" href=\"https:\/\/coolshell.cn\/articles\/17010.html\/#Docker%E7%9A%84_Mount_Namespace\" title=\"Docker\u7684 Mount Namespace\">Docker\u7684 Mount Namespace<\/a><\/li><\/ul><\/nav><\/div>\n<h4><span class=\"ez-toc-section\" id=\"_%E7%AE%80%E4%BB%8B\"><\/span>\u00a0\u7b80\u4ecb<span class=\"ez-toc-section-end\"><\/span><\/h4>\n<p>Linux Namespace\u662fLinux\u63d0\u4f9b\u7684\u4e00\u79cd\u5185\u6838\u7ea7\u522b\u73af\u5883\u9694\u79bb\u7684\u65b9\u6cd5\u3002\u4e0d\u77e5\u9053\u4f60\u662f\u5426\u8fd8\u8bb0\u5f97\u5f88\u65e9\u4ee5\u524d\u7684Unix\u6709\u4e00\u4e2a\u53ebchroot\u7684\u7cfb\u7edf\u8c03\u7528\uff08\u901a\u8fc7\u4fee\u6539\u6839\u76ee\u5f55\u628a\u7528\u6237jail\u5230\u4e00\u4e2a\u7279\u5b9a\u76ee\u5f55\u4e0b\uff09\uff0cchroot\u63d0\u4f9b\u4e86\u4e00\u79cd\u7b80\u5355\u7684\u9694\u79bb\u6a21\u5f0f\uff1achroot\u5185\u90e8\u7684\u6587\u4ef6\u7cfb\u7edf\u65e0\u6cd5\u8bbf\u95ee\u5916\u90e8\u7684\u5185\u5bb9\u3002Linux Namespace\u5728\u6b64\u57fa\u7840\u4e0a\uff0c\u63d0\u4f9b\u4e86\u5bf9UTS\u3001IPC\u3001mount\u3001PID\u3001network\u3001User\u7b49\u7684\u9694\u79bb\u673a\u5236\u3002<\/p>\n<p><!--more--><\/p>\n<p>\u4e3e\u4e2a\u4f8b\u5b50\uff0c\u6211\u4eec\u90fd\u77e5\u9053\uff0cLinux\u4e0b\u7684\u8d85\u7ea7\u7236\u4eb2\u8fdb\u7a0b\u7684PID\u662f1\uff0c\u6240\u4ee5\uff0c\u540cchroot\u4e00\u6837\uff0c\u5982\u679c\u6211\u4eec\u53ef\u4ee5\u628a\u7528\u6237\u7684\u8fdb\u7a0b\u7a7a\u95f4jail\u5230\u67d0\u4e2a\u8fdb\u7a0b\u5206\u652f\u4e0b\uff0c\u5e76\u50cfchroot\u90a3\u6837\u8ba9\u5176\u4e0b\u9762\u7684\u8fdb\u7a0b \u770b\u5230\u7684\u90a3\u4e2a\u8d85\u7ea7\u7236\u8fdb\u7a0b\u7684PID\u4e3a1\uff0c\u4e8e\u662f\u5c31\u53ef\u4ee5\u8fbe\u5230\u8d44\u6e90\u9694\u79bb\u7684\u6548\u679c\u4e86\uff08\u4e0d\u540c\u7684PID namespace\u4e2d\u7684\u8fdb\u7a0b\u65e0\u6cd5\u770b\u5230\u5f7c\u6b64\uff09<\/p>\n<p><b>Linux\u00a0Namespace \u6709\u5982\u4e0b\u79cd\u7c7b<\/b>\uff0c\u5b98\u65b9\u6587\u6863\u5728\u8fd9\u91cc\u300a<a href=\"http:\/\/lwn.net\/Articles\/531114\/\" target=\"_blank\" rel=\"noopener noreferrer\">Namespace in Operation<\/a>\u300b<\/p>\n<table width=\"100%\">\n<thead>\n<tr>\n<th>\u5206\u7c7b<\/th>\n<th>\u7cfb\u7edf\u8c03\u7528\u53c2\u6570<\/th>\n<th>\u76f8\u5173\u5185\u6838\u7248\u672c<\/th>\n<\/tr>\n<\/thead>\n<tbody>\n<tr>\n<td><b>Mount namespaces<\/b><\/td>\n<td>CLONE_NEWNS<\/td>\n<td><a href=\"http:\/\/lwn.net\/2001\/0301\/a\/namespaces.php3\" target=\"_blank\" rel=\"noopener noreferrer\">Linux 2.4.19<\/a><\/td>\n<\/tr>\n<tr>\n<td><b>UTS namespaces<\/b><\/td>\n<td>CLONE_NEWUTS<\/td>\n<td><a href=\"http:\/\/lwn.net\/Articles\/179345\/\" target=\"_blank\" rel=\"noopener noreferrer\">Linux 2.6.19<\/a><\/td>\n<\/tr>\n<tr>\n<td><b>IPC namespaces<\/b><\/td>\n<td>CLONE_NEWIPC<\/td>\n<td><a href=\"http:\/\/lwn.net\/Articles\/187274\/\" target=\"_blank\" rel=\"noopener noreferrer\">Linux 2.6.19<\/a><\/td>\n<\/tr>\n<tr>\n<td><b>PID namespaces<\/b><\/td>\n<td>CLONE_NEWPID<\/td>\n<td><a href=\"http:\/\/lwn.net\/Articles\/259217\/\" target=\"_blank\" rel=\"noopener noreferrer\">Linux 2.6.24<\/a><\/td>\n<\/tr>\n<tr>\n<td><b>Network namespaces<\/b><\/td>\n<td>CLONE_NEWNET<\/td>\n<td><a href=\"http:\/\/lwn.net\/Articles\/219794\/\" target=\"_blank\" rel=\"noopener noreferrer\">\u59cb\u4e8eLinux 2.6.24 \u5b8c\u6210\u4e8e Linux 2.6.29<\/a><\/td>\n<\/tr>\n<tr>\n<td><b>User namespaces<\/b><\/td>\n<td>CLONE_NEWUSER<\/td>\n<td><a href=\"http:\/\/lwn.net\/Articles\/528078\/\" target=\"_blank\" rel=\"noopener noreferrer\">\u59cb\u4e8e Linux 2.6.23 \u5b8c\u6210\u4e8e Linux 3.8)<\/a><\/td>\n<\/tr>\n<\/tbody>\n<\/table>\n<p>\u4e3b\u8981\u662f\u4e09\u4e2a\u7cfb\u7edf\u8c03\u7528<\/p>\n<ul>\n<li><b><code>clone<\/code><\/b><b>() <\/b>&#8211; \u5b9e\u73b0\u7ebf\u7a0b\u7684\u7cfb\u7edf\u8c03\u7528\uff0c\u7528\u6765\u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u8fdb\u7a0b\uff0c\u5e76\u53ef\u4ee5\u901a\u8fc7\u8bbe\u8ba1\u4e0a\u8ff0\u53c2\u6570\u8fbe\u5230\u9694\u79bb\u3002<\/li>\n<li><b><code>unshare<\/code><\/b><b>() <\/b>&#8211; \u4f7f\u67d0\u8fdb\u7a0b\u8131\u79bb\u67d0\u4e2anamespace<\/li>\n<li><b><code>setns<\/code><\/b><b>() <\/b>&#8211; \u628a\u67d0\u8fdb\u7a0b\u52a0\u5165\u5230\u67d0\u4e2anamespace<\/li>\n<\/ul>\n<p>unshare() \u548c setns() \u90fd\u6bd4\u8f83\u7b80\u5355\uff0c\u5927\u5bb6\u53ef\u4ee5\u81ea\u5df1man\uff0c\u6211\u8fd9\u91cc\u4e0d\u8bf4\u4e86\u3002<\/p>\n<p>\u4e0b\u9762\u8fd8\u662f\u8ba9\u6211\u4eec\u6765\u770b\u4e00\u4e9b\u793a\u4f8b\uff08\u4ee5\u4e0b\u7684\u6d4b\u8bd5\u7a0b\u5e8f\u6700\u597d\u5728Linux \u5185\u6838\u4e3a3.8\u4ee5\u4e0a\u7684\u7248\u672c\u4e2d\u8fd0\u884c\uff0c\u6211\u7528\u7684\u662fubuntu 14.04\uff09\u3002<\/p>\n<h4><span class=\"ez-toc-section\" id=\"clone%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8\"><\/span>clone()\u7cfb\u7edf\u8c03\u7528<span class=\"ez-toc-section-end\"><\/span><\/h4>\n<p>\u9996\u5148\uff0c\u6211\u4eec\u6765\u770b\u4e00\u4e0b\u4e00\u4e2a\u6700\u7b80\u5355\u7684clone()\u7cfb\u7edf\u8c03\u7528\u7684\u793a\u4f8b\uff0c\uff08\u540e\u9762\uff0c\u6211\u4eec\u7684\u7a0b\u5e8f\u90fd\u4f1a\u57fa\u4e8e\u8fd9\u4e2a\u7a0b\u5e8f\u505a\u4fee\u6539\uff09\uff1a<\/p>\n<pre class=\"EnlighterJSRAW\" data-enlighter-language=\"c\">#define _GNU_SOURCE\n#include &lt;sys\/types.h&gt;\n#include &lt;sys\/wait.h&gt;\n#include &lt;stdio.h&gt;\n#include &lt;sched.h&gt;\n#include &lt;signal.h&gt;\n#include &lt;unistd.h&gt;\n\n\/* \u5b9a\u4e49\u4e00\u4e2a\u7ed9 clone \u7528\u7684\u6808\uff0c\u6808\u5927\u5c0f1M *\/\n#define STACK_SIZE (1024 * 1024)\nstatic char container_stack[STACK_SIZE];\n\nchar* const container_args[] = {\n    \"\/bin\/bash\",\n    NULL\n};\n\nint container_main(void* arg)\n{\n    printf(\"Container - inside the container!\\n\");\n    \/* \u76f4\u63a5\u6267\u884c\u4e00\u4e2ashell\uff0c\u4ee5\u4fbf\u6211\u4eec\u89c2\u5bdf\u8fd9\u4e2a\u8fdb\u7a0b\u7a7a\u95f4\u91cc\u7684\u8d44\u6e90\u662f\u5426\u88ab\u9694\u79bb\u4e86 *\/\n    execv(container_args[0], container_args); \n    printf(\"Something's wrong!\\n\");\n    return 1;\n}\n\nint main()\n{\n    printf(\"Parent - start a container!\\n\");\n    \/* \u8c03\u7528clone\u51fd\u6570\uff0c\u5176\u4e2d\u4f20\u51fa\u4e00\u4e2a\u51fd\u6570\uff0c\u8fd8\u6709\u4e00\u4e2a\u6808\u7a7a\u95f4\u7684\uff08\u4e3a\u4ec0\u4e48\u4f20\u5c3e\u6307\u9488\uff0c\u56e0\u4e3a\u6808\u662f\u53cd\u7740\u7684\uff09 *\/\n    int container_pid = clone(container_main, container_stack+STACK_SIZE, SIGCHLD, NULL);\n    \/* \u7b49\u5f85\u5b50\u8fdb\u7a0b\u7ed3\u675f *\/\n    waitpid(container_pid, NULL, 0);\n    printf(\"Parent - container stopped!\\n\");\n    return 0;\n}<\/pre>\n<p>\u4ece\u4e0a\u9762\u7684\u7a0b\u5e8f\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u5230\uff0c\u8fd9\u548cpthread\u57fa\u672c\u4e0a\u662f\u4e00\u6837\u7684\u73a9\u6cd5\u3002\u4f46\u662f\uff0c\u5bf9\u4e8e\u4e0a\u9762\u7684\u7a0b\u5e8f\uff0c\u7236\u5b50\u8fdb\u7a0b\u7684\u8fdb\u7a0b\u7a7a\u95f4\u662f\u6ca1\u6709\u4ec0\u4e48\u5dee\u522b\u7684\uff0c\u7236\u8fdb\u7a0b\u80fd\u8bbf\u95ee\u5230\u7684\u5b50\u8fdb\u7a0b\u4e5f\u80fd\u3002<\/p>\n<p>\u4e0b\u9762\uff0c \u8ba9\u6211\u4eec\u6765\u770b\u51e0\u4e2a\u4f8b\u5b50\u770b\u770b\uff0cLinux\u7684Namespace\u662f\u4ec0\u4e48\u6837\u7684\u3002<\/p>\n<h4><span class=\"ez-toc-section\" id=\"UTS_Namespace\"><\/span>UTS Namespace<span class=\"ez-toc-section-end\"><\/span><\/h4>\n<p>\u4e0b\u9762\u7684\u4ee3\u7801\uff0c\u6211\u7565\u53bb\u4e86\u4e0a\u9762\u90a3\u4e9b\u5934\u6587\u4ef6\u548c\u6570\u636e\u7ed3\u6784\u7684\u5b9a\u4e49\uff0c\u53ea\u6709\u6700\u91cd\u8981\u7684\u90e8\u5206\u3002<\/p>\n<pre class=\"EnlighterJSRAW\" data-enlighter-language=\"c\" data-enlighter-highlight=\"4,14\">int container_main(void* arg)\n{\n    printf(\"Container - inside the container!\\n\");\n    sethostname(\"container\",10); \/* \u8bbe\u7f6ehostname *\/\n    execv(container_args[0], container_args);\n    printf(\"Something's wrong!\\n\");\n    return 1;\n}\n\nint main()\n{\n    printf(\"Parent - start a container!\\n\");\n    int container_pid = clone(container_main, container_stack+STACK_SIZE, \n            CLONE_NEWUTS | SIGCHLD, NULL); \/*\u542f\u7528CLONE_NEWUTS Namespace\u9694\u79bb *\/\n    waitpid(container_pid, NULL, 0);\n    printf(\"Parent - container stopped!\\n\");\n    return 0;\n}<\/pre>\n<pre>\u8fd0\u884c\u4e0a\u9762\u7684\u7a0b\u5e8f\u4f60\u4f1a\u53d1\u73b0\uff08\u9700\u8981root\u6743\u9650\uff09\uff0c\u5b50\u8fdb\u7a0b\u7684hostname\u53d8\u6210\u4e86 container\u3002<\/pre>\n<pre class=\"EnlighterJSRAW\" data-enlighter-language=\"shell\">hchen@ubuntu:~$ sudo .\/uts\nParent - start a container!\nContainer - inside the container!\nroot@container:~# hostname\ncontainer\nroot@container:~# uname -n\ncontainer<\/pre>\n<h4><span class=\"ez-toc-section\" id=\"IPC_Namespace\"><\/span>IPC Namespace<span class=\"ez-toc-section-end\"><\/span><\/h4>\n<p>IPC\u5168\u79f0 Inter-Process Communication\uff0c\u662fUnix\/Linux\u4e0b\u8fdb\u7a0b\u95f4\u901a\u4fe1\u7684\u4e00\u79cd\u65b9\u5f0f\uff0cIPC\u6709\u5171\u4eab\u5185\u5b58\u3001\u4fe1\u53f7\u91cf\u3001\u6d88\u606f\u961f\u5217\u7b49\u65b9\u6cd5\u3002\u6240\u4ee5\uff0c\u4e3a\u4e86\u9694\u79bb\uff0c\u6211\u4eec\u4e5f\u9700\u8981\u628aIPC\u7ed9\u9694\u79bb\u5f00\u6765\uff0c\u8fd9\u6837\uff0c\u53ea\u6709\u5728\u540c\u4e00\u4e2aNamespace\u4e0b\u7684\u8fdb\u7a0b\u624d\u80fd\u76f8\u4e92\u901a\u4fe1\u3002\u5982\u679c\u4f60\u719f\u6089IPC\u7684\u539f\u7406\u7684\u8bdd\uff0c\u4f60\u4f1a\u77e5\u9053\uff0cIPC\u9700\u8981\u6709\u4e00\u4e2a\u5168\u5c40\u7684ID\uff0c\u5373\u7136\u662f\u5168\u5c40\u7684\uff0c\u90a3\u4e48\u5c31\u610f\u5473\u7740\u6211\u4eec\u7684Namespace\u9700\u8981\u5bf9\u8fd9\u4e2aID\u9694\u79bb\uff0c\u4e0d\u80fd\u8ba9\u522b\u7684Namespace\u7684\u8fdb\u7a0b\u770b\u5230\u3002<\/p>\n<p>\u8981\u542f\u52a8IPC\u9694\u79bb\uff0c\u6211\u4eec\u53ea\u9700\u8981\u5728\u8c03\u7528clone\u65f6\u52a0\u4e0aCLONE_NEWIPC\u53c2\u6570\u5c31\u53ef\u4ee5\u4e86\u3002<\/p>\n<pre class=\"EnlighterJSRAW\" data-enlighter-language=\"c\">int container_pid = clone(container_main, container_stack+STACK_SIZE, \n            CLONE_NEWUTS | CLONE_NEWIPC | SIGCHLD, NULL);<\/pre>\n<p>\u9996\u5148\uff0c\u6211\u4eec\u5148\u521b\u5efa\u4e00\u4e2aIPC\u7684Queue\uff08\u5982\u4e0b\u6240\u793a\uff0c\u5168\u5c40\u7684Queue ID\u662f0\uff09<\/p>\n<pre class=\"EnlighterJSRAW\" data-enlighter-language=\"shell\">hchen@ubuntu:~$ ipcmk -Q \nMessage queue id: 0\n\nhchen@ubuntu:~$ ipcs -q\n------ Message Queues --------\nkey        msqid      owner      perms      used-bytes   messages    \n0xd0d56eb2 0          hchen      644        0            0<\/pre>\n<p>\u5982\u679c\u6211\u4eec\u8fd0\u884c\u6ca1\u6709CLONE_NEWIPC\u7684\u7a0b\u5e8f\uff0c\u6211\u4eec\u4f1a\u770b\u5230\uff0c\u5728\u5b50\u8fdb\u7a0b\u4e2d\u8fd8\u662f\u80fd\u770b\u5230\u8fd9\u4e2a\u5168\u542f\u7684IPC Queue\u3002<\/p>\n<pre class=\"EnlighterJSRAW\" data-enlighter-language=\"shell\">hchen@ubuntu:~$ sudo .\/uts \nParent - start a container!\nContainer - inside the container!\n\nroot@container:~# ipcs -q\n\n------ Message Queues --------\nkey        msqid      owner      perms      used-bytes   messages    \n0xd0d56eb2 0          hchen      644        0            0<\/pre>\n<p>\u4f46\u662f\uff0c\u5982\u679c\u6211\u4eec\u8fd0\u884c\u52a0\u4e0a\u4e86CLONE_NEWIPC\u7684\u7a0b\u5e8f\uff0c\u6211\u4eec\u5c31\u4f1a\u4e0b\u9762\u7684\u7ed3\u679c\uff1a<\/p>\n<pre class=\"EnlighterJSRAW\" data-enlighter-language=\"shell\">root@ubuntu:~$ sudo.\/ipc\nParent - start a container!\nContainer - inside the container!\n\nroot@container:~\/linux_namespace# ipcs -q\n\n------ Message Queues --------\nkey        msqid      owner      perms      used-bytes   messages<\/pre>\n<p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230IPC\u5df2\u7ecf\u88ab\u9694\u79bb\u4e86\u3002<\/p>\n<h4><span class=\"ez-toc-section\" id=\"PID_Namespace\"><\/span>PID Namespace<span class=\"ez-toc-section-end\"><\/span><\/h4>\n<p>\u6211\u4eec\u7ee7\u7eed\u4fee\u6539\u4e0a\u9762\u7684\u7a0b\u5e8f\uff1a<\/p>\n<pre class=\"EnlighterJSRAW\" data-enlighter-language=\"c\" data-enlighter-highlight=\"4,16\">\nint container_main(void* arg)\n{\n    \/* \u67e5\u770b\u5b50\u8fdb\u7a0b\u7684PID\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u5176\u8f93\u51fa\u5b50\u8fdb\u7a0b\u7684 pid \u4e3a 1 *\/\n    printf(\"Container [%5d] - inside the container!\\n\", getpid());\n    sethostname(\"container\",10);\n    execv(container_args[0], container_args);\n    printf(\"Something's wrong!\\n\");\n    return 1;\n}\n\nint main()\n{\n    printf(\"Parent [%5d] - start a container!\\n\", getpid());\n    \/*\u542f\u7528PID namespace - CLONE_NEWPID*\/\n    int container_pid = clone(container_main, container_stack+STACK_SIZE, \n            CLONE_NEWUTS | CLONE_NEWPID | SIGCHLD, NULL); \n    waitpid(container_pid, NULL, 0);\n    printf(\"Parent - container stopped!\\n\");\n    return 0;\n}<\/pre>\n<p>\u8fd0\u884c\u7ed3\u679c\u5982\u4e0b\uff08\u6211\u4eec\u53ef\u4ee5\u770b\u5230\uff0c\u5b50\u8fdb\u7a0b\u7684pid\u662f1\u4e86\uff09\uff1a<\/p>\n<pre class=\"EnlighterJSRAW\" data-enlighter-language=\"shell\">\nhchen@ubuntu:~$ sudo .\/pid\nParent [ 3474] - start a container!\nContainer [ 1] - inside the container!\nroot@container:~# echo $$\n1<\/pre>\n<p>\u4f60\u53ef\u80fd\u4f1a\u95ee\uff0cPID\u4e3a1\u6709\u4e2a\u6bdb\u7528\u554a\uff1f\u6211\u4eec\u77e5\u9053\uff0c\u5728\u4f20\u7edf\u7684UNIX\u7cfb\u7edf\u4e2d\uff0cPID\u4e3a1\u7684\u8fdb\u7a0b\u662finit\uff0c\u5730\u4f4d\u975e\u5e38\u7279\u6b8a\u3002\u4ed6\u4f5c\u4e3a\u6240\u6709\u8fdb\u7a0b\u7684\u7236\u8fdb\u7a0b\uff0c\u6709\u5f88\u591a\u7279\u6743\uff08\u6bd4\u5982\uff1a\u5c4f\u853d\u4fe1\u53f7\u7b49\uff09\uff0c\u53e6\u5916\uff0c\u5176\u8fd8\u4f1a\u4e3a\u68c0\u67e5\u6240\u6709\u8fdb\u7a0b\u7684\u72b6\u6001\uff0c\u6211\u4eec\u77e5\u9053\uff0c\u5982\u679c\u67d0\u4e2a\u5b50\u8fdb\u7a0b\u8131\u79bb\u4e86\u7236\u8fdb\u7a0b\uff08\u7236\u8fdb\u7a0b\u6ca1\u6709wait\u5b83\uff09\uff0c\u90a3\u4e48init\u5c31\u4f1a\u8d1f\u8d23\u56de\u6536\u8d44\u6e90\u5e76\u7ed3\u675f\u8fd9\u4e2a\u5b50\u8fdb\u7a0b\u3002\u6240\u4ee5\uff0c\u8981\u505a\u5230\u8fdb\u7a0b\u7a7a\u95f4\u7684\u9694\u79bb\uff0c\u9996\u5148\u8981\u521b\u5efa\u51faPID\u4e3a1\u7684\u8fdb\u7a0b\uff0c\u6700\u597d\u5c31\u50cfchroot\u90a3\u6837\uff0c\u628a\u5b50\u8fdb\u7a0b\u7684PID\u5728\u5bb9\u5668\u5185\u53d8\u62101\u3002<\/p>\n<p><strong>\u4f46\u662f\uff0c\u6211\u4eec\u4f1a\u53d1\u73b0\uff0c\u5728\u5b50\u8fdb\u7a0b\u7684shell\u91cc\u8f93\u5165ps,top\u7b49\u547d\u4ee4\uff0c\u6211\u4eec\u8fd8\u662f\u53ef\u4ee5\u770b\u5f97\u5230\u6240\u6709\u8fdb\u7a0b<\/strong>\u3002\u8bf4\u660e\u5e76\u6ca1\u6709\u5b8c\u5168\u9694\u79bb\u3002\u8fd9\u662f\u56e0\u4e3a\uff0c\u50cfps, top\u8fd9\u4e9b\u547d\u4ee4\u4f1a\u53bb\u8bfb\/proc\u6587\u4ef6\u7cfb\u7edf\uff0c\u6240\u4ee5\uff0c\u56e0\u4e3a\/proc\u6587\u4ef6\u7cfb\u7edf\u5728\u7236\u8fdb\u7a0b\u548c\u5b50\u8fdb\u7a0b\u90fd\u662f\u4e00\u6837\u7684\uff0c\u6240\u4ee5\u8fd9\u4e9b\u547d\u4ee4\u663e\u793a\u7684\u4e1c\u897f\u90fd\u662f\u4e00\u6837\u7684\u3002<\/p>\n<p>\u6240\u4ee5\uff0c\u6211\u4eec\u8fd8\u9700\u8981\u5bf9\u6587\u4ef6\u7cfb\u7edf\u8fdb\u884c\u9694\u79bb\u3002<\/p>\n<h4><span class=\"ez-toc-section\" id=\"Mount_Namespace\"><\/span>Mount Namespace<span class=\"ez-toc-section-end\"><\/span><\/h4>\n<p>\u4e0b\u9762\u7684\u4f8b\u7a0b\u4e2d\uff0c\u6211\u4eec\u5728\u542f\u7528\u4e86mount namespace\u5e76\u5728\u5b50\u8fdb\u7a0b\u4e2d\u91cd\u65b0mount\u4e86\/proc\u6587\u4ef6\u7cfb\u7edf\u3002<\/p>\n<pre class=\"EnlighterJSRAW\" data-enlighter-language=\"c\" data-enlighter-highlight=\"6,17\">int container_main(void* arg)\n{\n    printf(\"Container [%5d] - inside the container!\\n\", getpid());\n    sethostname(\"container\",10);\n    \/* \u91cd\u65b0mount proc\u6587\u4ef6\u7cfb\u7edf\u5230 \/proc\u4e0b *\/\n    system(\"mount -t proc proc \/proc\");\n    execv(container_args[0], container_args);\n    printf(\"Something's wrong!\\n\");\n    return 1;\n}\n\nint main()\n{\n    printf(\"Parent [%5d] - start a container!\\n\", getpid());\n    \/* \u542f\u7528Mount Namespace - \u589e\u52a0CLONE_NEWNS\u53c2\u6570 *\/\n    int container_pid = clone(container_main, container_stack+STACK_SIZE, \n            CLONE_NEWUTS | CLONE_NEWPID | CLONE_NEWNS | SIGCHLD, NULL);\n    waitpid(container_pid, NULL, 0);\n    printf(\"Parent - container stopped!\\n\");\n    return 0;\n}<\/pre>\n<p>\u8fd0\u884c\u7ed3\u679c\u5982\u4e0b\uff1a<\/p>\n<pre class=\"EnlighterJSRAW\" data-enlighter-language=\"shell\">\nhchen@ubuntu:~$ sudo .\/pid.mnt\nParent [ 3502] - start a container!\nContainer [    1] - inside the container!\nroot@container:~# ps -elf \nF S UID        PID  PPID  C PRI  NI ADDR SZ WCHAN  STIME TTY          TIME CMD\n4 S root         1     0  0  80   0 -  6917 wait   19:55 pts\/2    00:00:00 \/bin\/bash\n0 R root        14     1  0  80   0 -  5671 -      19:56 pts\/2    00:00:00 ps -elf\n<\/pre>\n<p>\u4e0a\u9762\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u53ea\u6709\u4e24\u4e2a\u8fdb\u7a0b \uff0c\u800c\u4e14pid=1\u7684\u8fdb\u7a0b\u662f\u6211\u4eec\u7684\/bin\/bash\u3002\u6211\u4eec\u8fd8\u53ef\u4ee5\u770b\u5230\/proc\u76ee\u5f55\u4e0b\u4e5f\u5e72\u51c0\u4e86\u5f88\u591a\uff1a<\/p>\n<pre class=\"EnlighterJSRAW\" data-enlighter-language=\"shell\">\nroot@container:~# ls \/proc\n1          dma          key-users   net            sysvipc\n16         driver       kmsg        pagetypeinfo   timer_list\nacpi       execdomains  kpagecount  partitions     timer_stats\nasound     fb           kpageflags  sched_debug    tty\nbuddyinfo  filesystems  loadavg     schedstat      uptime\nbus        fs           locks       scsi           version\ncgroups    interrupts   mdstat      self           version_signature\ncmdline    iomem        meminfo     slabinfo       vmallocinfo\nconsoles   ioports      misc        softirqs       vmstat\ncpuinfo    irq          modules     stat           zoneinfo\ncrypto     kallsyms     mounts      swaps\ndevices    kcore        mpt         sys\ndiskstats  keys         mtrr        sysrq-trigger\n<\/pre>\n<p>\u4e0b\u56fe\uff0c\u6211\u4eec\u4e5f\u53ef\u4ee5\u770b\u5230\u5728\u5b50\u8fdb\u7a0b\u4e2d\u7684top\u547d\u4ee4\u53ea\u770b\u5f97\u5230\u4e24\u4e2a\u8fdb\u7a0b\u4e86\u3002<\/p>\n<p><img decoding=\"async\" loading=\"lazy\" class=\"aligncenter size-full wp-image-17020\" src=\"https:\/\/coolshell.cn\/wp-content\/uploads\/2015\/04\/mount.namespace.jpg\" alt=\"\" width=\"570\" height=\"300\" srcset=\"https:\/\/coolshell.cn\/wp-content\/uploads\/2015\/04\/mount.namespace.jpg 740w, https:\/\/coolshell.cn\/wp-content\/uploads\/2015\/04\/mount.namespace-300x158.jpg 300w\" sizes=\"(max-width: 570px) 100vw, 570px\" \/><\/p>\n<p>\u8fd9\u91cc\uff0c\u591a\u8bf4\u4e00\u4e0b\u3002\u5728\u901a\u8fc7CLONE_NEWNS\u521b\u5efamount namespace\u540e\uff0c\u7236\u8fdb\u7a0b\u4f1a\u628a\u81ea\u5df1\u7684\u6587\u4ef6\u7ed3\u6784\u590d\u5236\u7ed9\u5b50\u8fdb\u7a0b\u4e2d\u3002\u800c\u5b50\u8fdb\u7a0b\u4e2d\u65b0\u7684namespace\u4e2d\u7684\u6240\u6709mount\u64cd\u4f5c\u90fd\u53ea\u5f71\u54cd\u81ea\u8eab\u7684\u6587\u4ef6\u7cfb\u7edf\uff0c\u800c\u4e0d\u5bf9\u5916\u754c\u4ea7\u751f\u4efb\u4f55\u5f71\u54cd\u3002\u8fd9\u6837\u53ef\u4ee5\u505a\u5230\u6bd4\u8f83\u4e25\u683c\u5730\u9694\u79bb\u3002<\/p>\n<p><!--\u53e6\u5916\uff0c\u5982\u679c\u4f60\u719f\u6089mount\u547d\u4ee4\uff0c\u4f60\u4f1a\u77e5\u9053\uff0cmount\u547d\u4ee4\u6709\u4ee5\u4e0b\u8fd9\u4e9b\u53c2\u6570\uff1a\n\n\n<ul>\n\n\n<ol>--make-shared \uff1a \u5171\u4eab\u65b9\u5f0f\u7684mount\uff0c\u4e3b\u8981\u662f\u4e3a\u4e86\u6587\u4ef6\u7684\u5171\u4eab\u548c\u955c\u50cf\u3002<\/ol>\n\n\n\n\n<ol>--make-slave \uff1a \u8fd9\u79cdmount\u65b9\u5f0f\u66f4\u5927\u7684\u610f\u4e49\u662f\u4e3a\u4e86\u201c\u53ea\u8bfb\u201d\u7684\u573a\u666f\uff0c\u4e5f\u5c31\u662f\u4ece\u52a8\u5f0f\u7684mount\u3002<\/ol>\n\n\n\n\n<ol>--make-private\uff1a\u8fd9\u79cdmount\u65b9\u5f0f\u4e3b\u8981\u5c31\u662f\u4e3a\u4e86\u9694\u79bb\u3002\u5982proc\u6587\u4ef6\u7cfb\u7edf\u3002<\/ol>\n\n\n\n\n<ol>--make-unbindable\uff1a\u6807\u8bb0\u4e3a\u4e0d\u53ef\u7ed1\u5b9a\u3002<\/ol>\n\n\n<\/ul>\n\n\n--><\/p>\n<p>\u4f60\u53ef\u80fd\u4f1a\u95ee\uff0c\u6211\u4eec\u662f\u4e0d\u662f\u8fd8\u6709\u522b\u7684\u4e00\u4e9b\u6587\u4ef6\u7cfb\u7edf\u4e5f\u9700\u8981\u8fd9\u6837mount? \u662f\u7684\u3002<\/p>\n<h4><span class=\"ez-toc-section\" id=\"Docker%E7%9A%84_Mount_Namespace\"><\/span>Docker\u7684 Mount Namespace<span class=\"ez-toc-section-end\"><\/span><\/h4>\n<p>\u4e0b\u9762\u6211\u5c06\u5411\u6f14\u793a\u4e00\u4e2a\u201c\u5c71\u5be8\u955c\u50cf\u201d\uff0c\u5176\u6a21\u4eff\u4e86Docker\u7684Mount Namespace\u3002<\/p>\n<p>\u9996\u5148\uff0c\u6211\u4eec\u9700\u8981\u4e00\u4e2arootfs\uff0c\u4e5f\u5c31\u662f\u6211\u4eec\u9700\u8981\u628a\u6211\u4eec\u8981\u505a\u7684\u955c\u50cf\u4e2d\u7684\u90a3\u4e9b\u547d\u4ee4\u4ec0\u4e48\u7684copy\u5230\u4e00\u4e2arootfs\u7684\u76ee\u5f55\u4e0b\uff0c\u6211\u4eec\u6a21\u4effLinux\u6784\u5efa\u5982\u4e0b\u7684\u76ee\u5f55\uff1a<\/p>\n<pre class=\"EnlighterJSRAW\" data-enlighter-language=\"shell\">hchen@ubuntu:~\/rootfs$ ls\nbin  dev  etc  home  lib  lib64  mnt  opt  proc  root  run  sbin  sys  tmp  usr  var<\/pre>\n<p>\u7136\u540e\uff0c\u6211\u4eec\u628a\u4e00\u4e9b\u6211\u4eec\u9700\u8981\u7684\u547d\u4ee4copy\u5230 rootfs\/bin\u76ee\u5f55\u4e2d\uff08sh\u547d\u4ee4\u5fc5\u9700\u8981copy\u8fdb\u53bb\uff0c\u4e0d\u7136\u6211\u4eec\u65e0\u6cd5 chroot \uff09<\/p>\n<pre class=\"EnlighterJSRAW\" data-enlighter-language=\"shell\">\nhchen@ubuntu:~\/rootfs$ ls .\/bin .\/usr\/bin\n \n.\/bin:\nbash   chown  gzip      less  mount       netstat  rm     tabs  tee      top       tty\ncat    cp     hostname  ln    mountpoint  ping     sed    tac   test     touch     umount\nchgrp  echo   ip        ls    mv          ps       sh     tail  timeout  tr        uname\nchmod  grep   kill      more  nc          pwd      sleep  tar   toe      truncate  which\n\n.\/usr\/bin:\nawk  env  groups  head  id  mesg  sort  strace  tail  top  uniq  vi  wc  xargs\n<\/pre>\n<p>\u6ce8\uff1a\u4f60\u53ef\u4ee5\u4f7f\u7528ldd\u547d\u4ee4\u628a\u8fd9\u4e9b\u547d\u4ee4\u76f8\u5173\u7684\u90a3\u4e9bso\u6587\u4ef6copy\u5230\u5bf9\u5e94\u7684\u76ee\u5f55\uff1a<\/p>\n<pre class=\"EnlighterJSRAW\" data-enlighter-language=\"shell\">\nhchen@ubuntu:~\/rootfs\/bin$ ldd bash\n  linux-vdso.so.1 =>  (0x00007fffd33fc000)\n  libtinfo.so.5 => \/lib\/x86_64-linux-gnu\/libtinfo.so.5 (0x00007f4bd42c2000)\n  libdl.so.2 => \/lib\/x86_64-linux-gnu\/libdl.so.2 (0x00007f4bd40be000)\n  libc.so.6 => \/lib\/x86_64-linux-gnu\/libc.so.6 (0x00007f4bd3cf8000)\n  \/lib64\/ld-linux-x86-64.so.2 (0x00007f4bd4504000)\n<\/pre>\n<p>\u4e0b\u9762\u662f\u6211\u7684rootfs\u4e2d\u7684\u4e00\u4e9bso\u6587\u4ef6\uff1a<\/p>\n<pre class=\"EnlighterJSRAW\" data-enlighter-language=\"shell\">\nhchen@ubuntu:~\/rootfs$ ls .\/lib64 .\/lib\/x86_64-linux-gnu\/\n\n.\/lib64:\nld-linux-x86-64.so.2\n\n.\/lib\/x86_64-linux-gnu\/:\nlibacl.so.1      libmemusage.so         libnss_files-2.19.so    libpython3.4m.so.1\nlibacl.so.1.1.0  libmount.so.1          libnss_files.so.2       libpython3.4m.so.1.0\nlibattr.so.1     libmount.so.1.1.0      libnss_hesiod-2.19.so   libresolv-2.19.so\nlibblkid.so.1    libm.so.6              libnss_hesiod.so.2      libresolv.so.2\nlibc-2.19.so     libncurses.so.5        libnss_nis-2.19.so      libselinux.so.1\nlibcap.a         libncurses.so.5.9      libnss_nisplus-2.19.so  libtinfo.so.5\nlibcap.so        libncursesw.so.5       libnss_nisplus.so.2     libtinfo.so.5.9\nlibcap.so.2      libncursesw.so.5.9     libnss_nis.so.2         libutil-2.19.so\nlibcap.so.2.24   libnsl-2.19.so         libpcre.so.3            libutil.so.1\nlibc.so.6        libnsl.so.1            libprocps.so.3          libuuid.so.1\nlibdl-2.19.so    libnss_compat-2.19.so  libpthread-2.19.so      libz.so.1\nlibdl.so.2       libnss_compat.so.2     libpthread.so.0\nlibgpm.so.2      libnss_dns-2.19.so     libpython2.7.so.1\nlibm-2.19.so     libnss_dns.so.2        libpython2.7.so.1.0\n<\/pre>\n<p>\u5305\u62ec\u8fd9\u4e9b\u547d\u4ee4\u4f9d\u8d56\u7684\u4e00\u4e9b\u914d\u7f6e\u6587\u4ef6\uff1a<\/p>\n<pre class=\"EnlighterJSRAW\" data-enlighter-language=\"shell\">\nhchen@ubuntu:~\/rootfs$ ls .\/etc\nbash.bashrc  group  hostname  hosts  ld.so.cache  nsswitch.conf  passwd  profile  \nresolv.conf  shadow\n<\/pre>\n<p>\u4f60\u73b0\u5728\u4f1a\u8bf4\uff0c\u6211\u9760\uff0c\u6709\u4e9b\u914d\u7f6e\u6211\u5e0c\u671b\u662f\u5728\u5bb9\u5668\u8d77\u52a8\u65f6\u7ed9\u4ed6\u8bbe\u7f6e\u7684\uff0c\u800c\u4e0d\u662fhard code\u5728\u955c\u50cf\u4e2d\u7684\u3002\u6bd4\u5982\uff1a\/etc\/hosts\uff0c\/etc\/hostname\uff0c\u8fd8\u6709DNS\u7684\/etc\/resolv.conf\u6587\u4ef6\u3002\u597d\u7684\u3002\u90a3\u6211\u4eec\u5728rootfs\u5916\u9762\uff0c\u6211\u4eec\u518d\u521b\u5efa\u4e00\u4e2aconf\u76ee\u5f55\uff0c\u628a\u8fd9\u4e9b\u6587\u4ef6\u653e\u5230\u8fd9\u4e2a\u76ee\u5f55\u4e2d\u3002<\/p>\n<pre class=\"EnlighterJSRAW\" data-enlighter-language=\"shell\">hchen@ubuntu:~$ ls .\/conf\nhostname     hosts     resolv.conf<\/pre>\n<p>\u8fd9\u6837\uff0c\u6211\u4eec\u7684\u7236\u8fdb\u7a0b\u5c31\u53ef\u4ee5\u52a8\u6001\u5730\u8bbe\u7f6e\u5bb9\u5668\u9700\u8981\u7684\u8fd9\u4e9b\u6587\u4ef6\u7684\u914d\u7f6e\uff0c \u7136\u540e\u518d\u628a\u4ed6\u4eecmount\u8fdb\u5bb9\u5668\uff0c\u8fd9\u6837\uff0c\u5bb9\u5668\u7684\u955c\u50cf\u4e2d\u7684\u914d\u7f6e\u5c31\u6bd4\u8f83\u7075\u6d3b\u4e86\u3002<\/p>\n<p>\u597d\u4e86\uff0c\u7ec8\u4e8e\u5230\u4e86\u6211\u4eec\u7684\u7a0b\u5e8f\u3002<\/p>\n<pre class=\"EnlighterJSRAW\" data-enlighter-language=\"c\">\n#define _GNU_SOURCE\n#include <sys\/types.h>\n#include <sys\/wait.h>\n#include <sys\/mount.h>\n#include <stdio.h>\n#include <sched.h>\n#include <signal.h>\n#include <unistd.h>\n\n#define STACK_SIZE (1024 * 1024)\n\nstatic char container_stack[STACK_SIZE];\nchar* const container_args[] = {\n    \"\/bin\/bash\",\n    \"-l\",\n    NULL\n};\n\nint container_main(void* arg)\n{\n    printf(\"Container [%5d] - inside the container!\\n\", getpid());\n\n    \/\/set hostname\n    sethostname(\"container\",10);\n\n    \/\/remount \"\/proc\" to make sure the \"top\" and \"ps\" show container's information\n    if (mount(\"proc\", \"rootfs\/proc\", \"proc\", 0, NULL) !=0 ) {\n        perror(\"proc\");\n    }\n    if (mount(\"sysfs\", \"rootfs\/sys\", \"sysfs\", 0, NULL)!=0) {\n        perror(\"sys\");\n    }\n    if (mount(\"none\", \"rootfs\/tmp\", \"tmpfs\", 0, NULL)!=0) {\n        perror(\"tmp\");\n    }\n    if (mount(\"udev\", \"rootfs\/dev\", \"devtmpfs\", 0, NULL)!=0) {\n        perror(\"dev\");\n    }\n    if (mount(\"devpts\", \"rootfs\/dev\/pts\", \"devpts\", 0, NULL)!=0) {\n        perror(\"dev\/pts\");\n    }\n    if (mount(\"shm\", \"rootfs\/dev\/shm\", \"tmpfs\", 0, NULL)!=0) {\n        perror(\"dev\/shm\");\n    }\n    if (mount(\"tmpfs\", \"rootfs\/run\", \"tmpfs\", 0, NULL)!=0) {\n        perror(\"run\");\n    }\n    \/* \n     * \u6a21\u4effDocker\u7684\u4ece\u5916\u5411\u5bb9\u5668\u91ccmount\u76f8\u5173\u7684\u914d\u7f6e\u6587\u4ef6 \n     * \u4f60\u53ef\u4ee5\u67e5\u770b\uff1a\/var\/lib\/docker\/containers\/<container_id>\/\u76ee\u5f55\uff0c\n     * \u4f60\u4f1a\u770b\u5230docker\u7684\u8fd9\u4e9b\u6587\u4ef6\u7684\u3002\n     *\/\n    if (mount(\"conf\/hosts\", \"rootfs\/etc\/hosts\", \"none\", MS_BIND, NULL)!=0 ||\n          mount(\"conf\/hostname\", \"rootfs\/etc\/hostname\", \"none\", MS_BIND, NULL)!=0 ||\n          mount(\"conf\/resolv.conf\", \"rootfs\/etc\/resolv.conf\", \"none\", MS_BIND, NULL)!=0 ) {\n        perror(\"conf\");\n    }\n    \/* \u6a21\u4effdocker run\u547d\u4ee4\u4e2d\u7684 -v, --volume=[] \u53c2\u6570\u5e72\u7684\u4e8b *\/\n    if (mount(\"\/tmp\/t1\", \"rootfs\/mnt\", \"none\", MS_BIND, NULL)!=0) {\n        perror(\"mnt\");\n    }\n\n    \/* chroot \u9694\u79bb\u76ee\u5f55 *\/\n    if ( chdir(\".\/rootfs\") != 0 || chroot(\".\/\") != 0 ){\n        perror(\"chdir\/chroot\");\n    }\n\n    execv(container_args[0], container_args);\n    perror(\"exec\");\n    printf(\"Something's wrong!\\n\");\n    return 1;\n}\n\nint main()\n{\n    printf(\"Parent [%5d] - start a container!\\n\", getpid());\n    int container_pid = clone(container_main, container_stack+STACK_SIZE, \n            CLONE_NEWUTS | CLONE_NEWIPC | CLONE_NEWPID | CLONE_NEWNS | SIGCHLD, NULL);\n    waitpid(container_pid, NULL, 0);\n    printf(\"Parent - container stopped!\\n\");\n    return 0;\n}\n<\/pre>\n<p>sudo\u8fd0\u884c\u4e0a\u9762\u7684\u7a0b\u5e8f\uff0c\u4f60\u4f1a\u770b\u5230\u4e0b\u9762\u7684\u6302\u8f7d\u4fe1\u606f\u4ee5\u53ca\u4e00\u4e2a\u6240\u8c13\u7684\u201c\u955c\u50cf\u201d\uff1a<\/p>\n<pre class=\"EnlighterJSRAW\" data-enlighter-language=\"shell\">\nhchen@ubuntu:~$ sudo .\/mount \nParent [ 4517] - start a container!\nContainer [    1] - inside the container!\nroot@container:\/# mount\nproc on \/proc type proc (rw,relatime)\nsysfs on \/sys type sysfs (rw,relatime)\nnone on \/tmp type tmpfs (rw,relatime)\nudev on \/dev type devtmpfs (rw,relatime,size=493976k,nr_inodes=123494,mode=755)\ndevpts on \/dev\/pts type devpts (rw,relatime,mode=600,ptmxmode=000)\ntmpfs on \/run type tmpfs (rw,relatime)\n\/dev\/disk\/by-uuid\/18086e3b-d805-4515-9e91-7efb2fe5c0e2 on \/etc\/hosts type ext4 (rw,relatime,errors=remount-ro,data=ordered)\n\/dev\/disk\/by-uuid\/18086e3b-d805-4515-9e91-7efb2fe5c0e2 on \/etc\/hostname type ext4 (rw,relatime,errors=remount-ro,data=ordered)\n\/dev\/disk\/by-uuid\/18086e3b-d805-4515-9e91-7efb2fe5c0e2 on \/etc\/resolv.conf type ext4 (rw,relatime,errors=remount-ro,data=ordered)\n\nroot@container:\/# ls \/bin \/usr\/bin\n\/bin:\nbash   chmod  echo  hostname  less  more  mv   ping  rm   sleep  tail  test    top   truncate  uname\ncat    chown  grep  ip        ln    mount  nc   ps    sed  tabs   tar   timeout  touch  tty     which\nchgrp  cp     gzip  kill      ls    mountpoint  netstat  pwd   sh   tac    tee   toe    tr   umount\n\n\/usr\/bin:\nawk  env  groups  head  id  mesg  sort  strace  tail  top  uniq  vi  wc  xargs\n<\/pre>\n<p>\u5173\u4e8e\u5982\u4f55\u505a\u4e00\u4e2achroot\u7684\u76ee\u5f55\uff0c\u8fd9\u91cc\u6709\u4e2a\u5de5\u5177\u53eb<a href=\"https:\/\/wiki.ubuntu.com\/DebootstrapChroot\" target=\"_blank\" rel=\"noopener noreferrer\">DebootstrapChroot<\/a>\uff0c\u4f60\u53ef\u4ee5\u987a\u7740\u94fe\u63a5\u53bb\u770b\u770b\uff08\u82f1\u6587\u7684\u54e6\uff09<\/p>\n<p>\u63a5\u4e0b\u6765\u7684\u4e8b\u60c5\uff0c\u4f60\u53ef\u4ee5\u81ea\u5df1\u73a9\u4e86\uff0c\u6211\u76f8\u4fe1\u4f60\u7684\u60f3\u50cf\u529b \u3002\uff1a\uff09<\/p>\n<p>\u5728\u4e0b\u4e00\u7bc7\uff0c\u6211\u5c06\u5411\u4f60\u4ecb\u7ecdUser Namespace\u3001Network Namespace\u4ee5\u53caNamespace\u7684\u5176\u5b83\u4e1c\u897f\u3002<\/p>\n<p align=\"center\"><strong> <a title=\"Docker\u57fa\u7840\u6280\u672f\uff1aLinux Namespace\uff08\u4e0b\uff09\" href=\"https:\/\/coolshell.cn\/articles\/17029.html\" target=\"_blank\" rel=\"noopener noreferrer\"> &lt;&lt;&lt;&lt; Docker\u57fa\u7840\u6280\u672f\uff1aLinux Namespace\uff08\u4e0b\uff09&gt;&gt;&gt;&gt; <\/a><\/strong><\/p>\n<p>\uff08\u4e0a\u7bc7\u5b8c\uff0c<a title=\"Docker\u57fa\u7840\u6280\u672f\uff1aLinux Namespace\uff08\u4e0b\uff09\" href=\"https:\/\/coolshell.cn\/articles\/17029.html\" target=\"_blank\" rel=\"noopener noreferrer\">\u8bf7\u53c2\u770b\u4e0b\u7bc7<\/a>\uff09<\/p>\n","raw":"","protected":false},"excerpt":{"rendered":"<p>\u65f6\u4e0b\u6700\u70ed\u7684\u6280\u672f\u83ab\u8fc7\u4e8eDocker\u4e86\uff0c\u5f88\u591a\u4eba\u90fd\u89c9\u5f97Docker\u662f\u4e2a\u65b0\u6280\u672f\uff0c\u5176\u5b9e\u4e0d\u7136\uff0cDocker\u9664\u4e86\u5176\u7f16\u7a0b\u8bed\u8a00\u7528go\u6bd4\u8f83\u65b0\u5916\uff0c\u5176\u5b9e\u5b83\u8fd8\u771f\u4e0d\u662f\u4e2a\u65b0\u4e1c\u897f\uff0c\u4e5f\u5c31\u662f\u4e2a\u65b0\u74f6&#8230;<\/p>\n<p class=\"read-more\"><a class=\"btn btn-default\" href=\"https:\/\/coolshell.cn\/articles\/17010.html\"> Read More<span class=\"screen-reader-text\">  Read More<\/span><\/a><\/p>\n","protected":false},"author":2,"featured_media":0,"comment_status":"open","ping_status":"open","sticky":false,"template":"","format":"standard","meta":[],"categories":[20],"tags":[781,37,783,782],"series":[],"aioseo_notices":[],"views":242091,"post_thumbnail_image":"https:\/\/coolshell.cn\/wp-content\/uploads\/2015\/04\/isolation.jpg","content_first_image":"https:\/\/coolshell.cn\/wp-content\/uploads\/2015\/04\/isolation.jpg","post_medium_image_300":"https:\/\/coolshell.cn\/wp-content\/uploads\/2015\/04\/isolation.jpg","post_thumbnail_image_624":"https:\/\/coolshell.cn\/wp-content\/uploads\/2015\/04\/isolation.jpg","post_frist_image":"https:\/\/coolshell.cn\/wp-content\/uploads\/2015\/04\/isolation.jpg","post_medium_image":"https:\/\/coolshell.cn\/wp-content\/uploads\/2015\/04\/isolation.jpg","post_large_image":"https:\/\/coolshell.cn\/wp-content\/uploads\/2015\/04\/isolation.jpg","post_full_image":"https:\/\/coolshell.cn\/wp-content\/uploads\/2015\/04\/isolation.jpg","post_all_images":[{"imagesurl":"https:\/\/coolshell.cn\/wp-content\/uploads\/2015\/04\/isolation.jpg","id":"image0"},{"imagesurl":"https:\/\/coolshell.cn\/wp-content\/uploads\/2015\/04\/mount.namespace.jpg","id":"image1"}],"videoAdId":"","listAd":"0","listAdId":"","listAdEvery":5,"total_comments":113,"category_name":"Unix\/Linux","post_date":"2015-04-16","like_count":"0","praiseWord":"\u9f13\u52b1","excitationAd":"0","rewardedVideoAdId":"","detailAdId":"","detailAd":"0","enterpriseMinapp":"0","audios":[],"postImageUrl":"http:\/\/coolshell.cn\/wp-content\/uploads\/2016\/09\/coolshell-360x200.jpg","avatarurls":[],"related_posts":[{"ID":"22320","post_title":"eBPF \u4ecb\u7ecd"}],"pageviews":242092,"pageviews_wl":155152,"ratings_average":4,"ratings_total":487,"ratings_users":107,"next_post_id":17049,"next_post_title":"Docker\u57fa\u7840\u6280\u672f\uff1aLinux CGroup","previous_post_id":17029,"previous_post_title":"Docker\u57fa\u7840\u6280\u672f\uff1aLinux Namespace\uff08\u4e0b\uff09"}