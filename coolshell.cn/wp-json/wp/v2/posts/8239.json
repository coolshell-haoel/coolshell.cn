{"id":8239,"date":"2012-09-07T08:26:55","date_gmt":"2012-09-07T00:26:55","guid":{"rendered":"http:\/\/coolshell.cn\/?p=8239"},"modified":"2020-07-06T18:11:27","modified_gmt":"2020-07-06T10:11:27","slug":"%e6%97%a0%e9%94%81%e9%98%9f%e5%88%97%e7%9a%84%e5%ae%9e%e7%8e%b0","status":"publish","type":"post","link":"https:\/\/coolshell.cn\/articles\/8239.html","title":{"rendered":"\u65e0\u9501\u961f\u5217\u7684\u5b9e\u73b0"},"content":{"rendered":"<p style=\"text-align: center;\"><strong><em>\u2014\u2014\u2014\u2014\u6ce8\uff1a\u672c\u6587\u4e8e2019\u5e7411\u67084\u65e5\u66f4\u65b0\u2014\u2014\u2014\u2014<\/em><\/strong><\/p>\n<p>\u5173\u4e8e\u65e0\u9501\u961f\u5217\u7684\u5b9e\u73b0\uff0c\u7f51\u4e0a\u6709\u5f88\u591a\u6587\u7ae0\uff0c\u867d\u7136\u672c\u6587\u53ef\u80fd\u548c\u90a3\u4e9b\u6587\u7ae0\u6709\u6240\u91cd\u590d\uff0c\u4f46\u662f\u6211\u8fd8\u662f\u60f3\u4ee5\u6211\u81ea\u5df1\u7684\u65b9\u5f0f\u628a\u8fd9\u4e9b\u6587\u7ae0\u4e2d\u7684\u91cd\u8981\u7684\u77e5\u8bc6\u70b9\u4e32\u8d77\u6765\u548c\u5927\u5bb6\u8bb2\u4e00\u8bb2\u8fd9\u4e2a\u6280\u672f\u3002\u4e0b\u9762\u5f00\u59cb\u6b63\u6587\u3002<\/p>\n<div id=\"ez-toc-container\" class=\"ez-toc-v2_0_48 counter-hierarchy ez-toc-counter ez-toc-grey ez-toc-container-direction\">\n<div class=\"ez-toc-title-container\">\n<p class=\"ez-toc-title\">\u76ee\u5f55<\/p>\n<span class=\"ez-toc-title-toggle\"><\/span><\/div>\n<nav><ul class='ez-toc-list ez-toc-list-level-1 ' ><li class='ez-toc-page-1 ez-toc-heading-level-4'><a class=\"ez-toc-link ez-toc-heading-1\" href=\"https:\/\/coolshell.cn\/articles\/8239.html\/#%E5%85%B3%E4%BA%8ECAS%E7%AD%89%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C\" title=\"\u5173\u4e8eCAS\u7b49\u539f\u5b50\u64cd\u4f5c\">\u5173\u4e8eCAS\u7b49\u539f\u5b50\u64cd\u4f5c<\/a><\/li><li class='ez-toc-page-1 ez-toc-heading-level-4'><a class=\"ez-toc-link ez-toc-heading-2\" href=\"https:\/\/coolshell.cn\/articles\/8239.html\/#%E6%97%A0%E9%94%81%E9%98%9F%E5%88%97%E7%9A%84%E9%93%BE%E8%A1%A8%E5%AE%9E%E7%8E%B0\" title=\"\u65e0\u9501\u961f\u5217\u7684\u94fe\u8868\u5b9e\u73b0\">\u65e0\u9501\u961f\u5217\u7684\u94fe\u8868\u5b9e\u73b0<\/a><\/li><li class='ez-toc-page-1 ez-toc-heading-level-4'><a class=\"ez-toc-link ez-toc-heading-3\" href=\"https:\/\/coolshell.cn\/articles\/8239.html\/#CAS%E7%9A%84ABA%E9%97%AE%E9%A2%98\" title=\"CAS\u7684ABA\u95ee\u9898\">CAS\u7684ABA\u95ee\u9898<\/a><\/li><li class='ez-toc-page-1 ez-toc-heading-level-4'><a class=\"ez-toc-link ez-toc-heading-4\" href=\"https:\/\/coolshell.cn\/articles\/8239.html\/#%E8%A7%A3%E5%86%B3ABA%E7%9A%84%E9%97%AE%E9%A2%98\" title=\"\u89e3\u51b3ABA\u7684\u95ee\u9898\">\u89e3\u51b3ABA\u7684\u95ee\u9898<\/a><\/li><li class='ez-toc-page-1 ez-toc-heading-level-4'><a class=\"ez-toc-link ez-toc-heading-5\" href=\"https:\/\/coolshell.cn\/articles\/8239.html\/#%E7%94%A8%E6%95%B0%E7%BB%84%E5%AE%9E%E7%8E%B0%E6%97%A0%E9%94%81%E9%98%9F%E5%88%97\" title=\"\u7528\u6570\u7ec4\u5b9e\u73b0\u65e0\u9501\u961f\u5217\">\u7528\u6570\u7ec4\u5b9e\u73b0\u65e0\u9501\u961f\u5217<\/a><\/li><li class='ez-toc-page-1 ez-toc-heading-level-4'><a class=\"ez-toc-link ez-toc-heading-6\" href=\"https:\/\/coolshell.cn\/articles\/8239.html\/#_%E5%B0%8F%E7%BB%93\" title=\"\u00a0\u5c0f\u7ed3\">\u00a0\u5c0f\u7ed3<\/a><\/li><\/ul><\/nav><\/div>\n<h4><span class=\"ez-toc-section\" id=\"%E5%85%B3%E4%BA%8ECAS%E7%AD%89%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C\"><\/span>\u5173\u4e8eCAS\u7b49\u539f\u5b50\u64cd\u4f5c<span class=\"ez-toc-section-end\"><\/span><\/h4>\n<p><img decoding=\"async\" loading=\"lazy\" class=\"alignright size-full wp-image-8245\" title=\"lock free bicycle\" src=\"https:\/\/coolshell.cn\/wp-content\/uploads\/2012\/09\/lock_free_bicycle.jpg\" alt=\"\" width=\"350\" height=\"261\" srcset=\"https:\/\/coolshell.cn\/wp-content\/uploads\/2012\/09\/lock_free_bicycle.jpg 350w, https:\/\/coolshell.cn\/wp-content\/uploads\/2012\/09\/lock_free_bicycle-300x224.jpg 300w\" sizes=\"(max-width: 350px) 100vw, 350px\" \/>\u5728\u5f00\u59cb\u8bf4\u65e0\u9501\u961f\u5217\u4e4b\u524d\uff0c\u6211\u4eec\u9700\u8981\u77e5\u9053\u4e00\u4e2a\u5f88\u91cd\u8981\u7684\u6280\u672f\u5c31\u662fCAS\u64cd\u4f5c\u2014\u2014Compare &amp; Set\uff0c\u6216\u662f Compare &amp; Swap\uff0c<strong>\u73b0\u5728\u51e0\u4e4e\u6240\u6709\u7684CPU\u6307\u4ee4\u90fd\u652f\u6301CAS\u7684\u539f\u5b50\u64cd\u4f5c\uff0cX86\u4e0b\u5bf9\u5e94\u7684\u662f\u00a0<span style=\"color: #ff0000;\">CMPXCHG\u00a0<\/span>\u6c47\u7f16\u6307\u4ee4\u3002<\/strong>\u6709\u4e86\u8fd9\u4e2a\u539f\u5b50\u64cd\u4f5c\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u7528\u5176\u6765\u5b9e\u73b0\u5404\u79cd\u65e0\u9501\uff08lock free\uff09\u7684\u6570\u636e\u7ed3\u6784\u3002<\/p>\n<p>\u8fd9\u4e2a\u64cd\u4f5c\u7528C\u8bed\u8a00\u6765\u63cf\u8ff0\u5c31\u662f\u4e0b\u9762\u8fd9\u4e2a\u6837\u5b50\uff1a\uff08\u4ee3\u7801\u6765\u81ea<a href=\"http:\/\/en.wikipedia.org\/wiki\/Compare-and-swap\" target=\"_blank\" rel=\"noopener noreferrer\">Wikipedia\u7684Compare And Swap<\/a>\u8bcd\u6761\uff09\u610f\u601d\u5c31\u662f\u8bf4\uff0c\u770b\u4e00\u770b\u5185\u5b58<code>*reg<\/code>\u91cc\u7684\u503c\u662f\u4e0d\u662f<code>oldval<\/code>\uff0c\u5982\u679c\u662f\u7684\u8bdd\uff0c\u5219\u5bf9\u5176\u8d4b\u503c<code>newval<\/code>\u3002<\/p>\n<pre class=\"EnlighterJSRAW\" data-enlighter-language=\"c\">\nint compare_and_swap (int* reg, int oldval, int newval)\n{\n  int old_reg_val = *reg;\n  if (old_reg_val == oldval) {\n     *reg = newval;\n  }\n  return old_reg_val;\n}\n<\/pre>\n<p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\uff0c<code>old_reg_val<\/code> \u603b\u662f\u8fd4\u56de\uff0c\u4e8e\u662f\uff0c\u6211\u4eec\u53ef\u4ee5\u5728 <code>compare_and_swap<\/code> \u64cd\u4f5c\u4e4b\u540e\u5bf9\u5176\u8fdb\u884c\u6d4b\u8bd5\uff0c\u4ee5\u67e5\u770b\u5b83\u662f\u5426\u4e0e <code>oldval<\/code>\u76f8\u5339\u914d\uff0c\u56e0\u4e3a\u5b83\u53ef\u80fd\u6709\u6240\u4e0d\u540c\uff0c\u8fd9\u610f\u5473\u7740\u53e6\u4e00\u4e2a\u5e76\u53d1\u7ebf\u7a0b\u5df2\u6210\u529f\u5730\u7ade\u4e89\u5230\u00a0<code>compare_and_swap<\/code>\u00a0\u5e76\u6210\u529f\u5c06 <code>reg<\/code> \u503c\u4ece <code>oldval<\/code> \u66f4\u6539\u4e3a\u522b\u7684\u503c\u4e86\u3002<\/p>\n<p>\u8fd9\u4e2a\u64cd\u4f5c\u53ef\u4ee5\u53d8\u79cd\u4e3a\u8fd4\u56debool\u503c\u7684\u5f62\u5f0f\uff08\u8fd4\u56de bool\u503c\u7684\u597d\u5904\u5728\u4e8e\uff0c\u53ef\u4ee5\u8c03\u7528\u8005\u77e5\u9053\u6709\u6ca1\u6709\u66f4\u65b0\u6210\u529f\uff09\uff1a<\/p>\n<pre class=\"EnlighterJSRAW\" data-enlighter-language=\"c\">bool compare_and_swap (int *addr, int oldval, int newval)\n{\n  if ( *addr != oldval ) {\n      return false;\n  }\n  *addr = newval;\n  return true;\n}<\/pre>\n<p>\u4e0eCAS\u76f8\u4f3c\u7684\u8fd8\u6709\u4e0b\u9762\u7684\u539f\u5b50\u64cd\u4f5c\uff1a\uff08\u8fd9\u4e9b\u4e1c\u897f\u5927\u5bb6\u81ea\u5df1\u770bWikipedia\uff0c\u4e5f\u6ca1\u4ec0\u4e48\u590d\u6742\u7684\uff09<\/p>\n<ul>\n<li><a href=\"http:\/\/en.wikipedia.org\/wiki\/Fetch-and-add\" target=\"_blank\" rel=\"noopener noreferrer\">Fetch And Add<\/a>\uff0c\u4e00\u822c\u7528\u6765\u5bf9\u53d8\u91cf\u505a +1 \u7684\u539f\u5b50\u64cd\u4f5c<\/li>\n<li><a title=\"Test-and-set\" href=\"http:\/\/en.wikipedia.org\/wiki\/Test-and-set\">Test-and-set<\/a>\uff0c\u5199\u503c\u5230\u67d0\u4e2a\u5185\u5b58\u4f4d\u7f6e\u5e76\u4f20\u56de\u5176\u65e7\u503c\u3002\u6c47\u7f16\u6307\u4ee4BST<\/li>\n<li><a title=\"Test and Test-and-set\" href=\"http:\/\/en.wikipedia.org\/wiki\/Test_and_Test-and-set\">Test and Test-and-set<\/a>\uff0c\u7528\u6765\u4f4e\u4f4eTest-and-Set\u7684\u8d44\u6e90\u4e89\u593a\u60c5\u51b5<\/li>\n<\/ul>\n<p><strong>\u6ce8\uff1a<\/strong>\u5728\u5b9e\u9645\u7684C\/C++\u7a0b\u5e8f\u4e2d\uff0cCAS\u7684\u5404\u79cd\u5b9e\u73b0\u7248\u672c\u5982\u4e0b\uff1a<\/p>\n<p><!--more--><\/p>\n<p><strong>1\uff09GCC\u7684CAS<\/strong><\/p>\n<p style=\"padding-left: 30px;\">GCC4.1+\u7248\u672c\u4e2d\u652f\u6301CAS\u7684\u539f\u5b50\u64cd\u4f5c\uff08\u5b8c\u6574\u7684\u539f\u5b50\u64cd\u4f5c\u53ef\u53c2\u770b<a href=\"http:\/\/gcc.gnu.org\/onlinedocs\/gcc-4.1.1\/gcc\/Atomic-Builtins.html\" target=\"_blank\" rel=\"noopener noreferrer\"> GCC Atomic Builtins<\/a>\uff09<\/p>\n<pre class=\"EnlighterJSRAW\" data-enlighter-language=\"c\">bool __sync_bool_compare_and_swap (type *ptr, type oldval type newval, ...)\ntype __sync_val_compare_and_swap (type *ptr, type oldval type newval, ...)<\/pre>\n<p><strong>2\uff09Windows\u7684CAS<\/strong><\/p>\n<p style=\"padding-left: 30px;\">\u5728Windows\u4e0b\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684Windows API\u6765\u5b8c\u6210CAS\uff1a\uff08\u5b8c\u6574\u7684Windows\u539f\u5b50\u64cd\u4f5c\u53ef\u53c2\u770bMSDN\u7684<a href=\"http:\/\/msdn.microsoft.com\/en-us\/library\/windows\/desktop\/ms686360(v=vs.85).aspx#interlocked_functions\" target=\"_blank\" rel=\"noopener noreferrer\">InterLocked Functions<\/a>\uff09<\/p>\n<pre class=\"EnlighterJSRAW\" data-enlighter-language=\"c\"> InterlockedCompareExchange\u00a0(\u00a0__inout LONG volatile *Target,\n                                 __in LONG Exchange,\n                                 __in LONG Comperand);<\/pre>\n<p><strong>3) C++11\u4e2d\u7684CAS<\/strong><\/p>\n<p style=\"padding-left: 30px;\">C++11\u4e2d\u7684STL\u4e2d\u7684atomic\u7c7b\u7684\u51fd\u6570\u53ef\u4ee5\u8ba9\u4f60\u8de8\u5e73\u53f0\u3002\uff08\u5b8c\u6574\u7684C++11\u7684\u539f\u5b50\u64cd\u4f5c\u53ef\u53c2\u770b <a href=\"http:\/\/en.cppreference.com\/w\/cpp\/atomic\" target=\"_blank\" rel=\"noopener noreferrer\">Atomic Operation Library<\/a>\uff09<\/p>\n<pre class=\"EnlighterJSRAW\" data-enlighter-language=\"c\">template&lt; class T &gt;\nbool atomic_compare_exchange_weak( std::atomic* obj,\n                                   T* expected, T desired );\ntemplate&lt; class T &gt;\nbool atomic_compare_exchange_weak( volatile std::atomic* obj,\n                                   T* expected, T desired );\n<\/pre>\n<h4><span class=\"ez-toc-section\" id=\"%E6%97%A0%E9%94%81%E9%98%9F%E5%88%97%E7%9A%84%E9%93%BE%E8%A1%A8%E5%AE%9E%E7%8E%B0\"><\/span>\u65e0\u9501\u961f\u5217\u7684\u94fe\u8868\u5b9e\u73b0<span class=\"ez-toc-section-end\"><\/span><\/h4>\n<p>\u4e0b\u9762\u7684\u4ee3\u7801\u4e3b\u8981\u53c2\u8003\u4e8e\u4e24\u7bc7\u8bba\u6587\uff1a<\/p>\n<ul>\n<li>John D. Valois 1994\u5e7410\u6708\u5728\u62c9\u65af\u7ef4\u52a0\u65af\u7684\u5e76\u884c\u548c\u5206\u5e03\u7cfb\u7edf\u7cfb\u7edf\u56fd\u9645\u5927\u4f1a\u4e0a\u7684\u4e00\u7bc7\u8bba\u6587\u2014\u2014\u300a<a href=\"http:\/\/citeseerx.ist.psu.edu\/viewdoc\/download?doi=10.1.1.53.8674&amp;rep=rep1&amp;type=pdf\" target=\"_blank\" rel=\"noopener noreferrer\">Implementing Lock-Free Queues<\/a>\u300b<\/li>\n<li>\u7f8e\u56fd\u7ebd\u7ea6\u7f57\u5207\u65af\u7279\u5927\u5b66 Maged M. Michael \u548c Michael L. Scott \u57281996\u5e743\u6708\u53d1\u8868\u7684\u4e00\u7bc7\u8bba\u6587 \u300a<a href=\"https:\/\/www.cs.rochester.edu\/u\/scott\/papers\/1996_PODC_queues.pdf\" target=\"_blank\" rel=\"noopener noreferrer\">Simple, Fast, and Practical Non-Blocking and Blocking ConcurrentQueue Algorithms<\/a>\u300b<\/li>\n<\/ul>\n<p>\uff08\u6ce8\uff1a\u4e0b\u9762\u7684\u4ee3\u7801\u5e76\u4e0d\u5b8c\u5168\u4e0e\u8fd9\u7bc7\u8bba\u6587\u76f8\u540c\uff09<\/p>\n<p>\u521d\u59cb\u5316\u4e00\u4e2a\u961f\u5217\u7684\u4ee3\u7801\u5f88\u7b80\uff0c\u521d\u59cb\u5316\u4e00\u4e2adummy\u7ed3\u70b9\uff08\u6ce8\uff1a\u5728\u94fe\u8868\u64cd\u4f5c\u4e2d\uff0c\u4f7f\u7528\u4e00\u4e2adummy\u7ed3\u70b9\uff0c\u53ef\u4ee5\u5c11\u6389\u5f88\u591a\u8fb9\u754c\u6761\u4ef6\u7684\u5224\u65ad\uff09\uff0c\u5982\u4e0b\u6240\u793a\uff1a<\/p>\n<pre class=\"EnlighterJSRAW\" data-enlighter-language=\"c\">\nInitQueue(Q)\n{\n    node = new node()\n    node-&gt;next = NULL;\n    Q-&gt;head = Q-&gt;tail = node;\n}\n<\/pre>\n<p>\u6211\u4eec\u5148\u6765\u770b\u4e00\u4e0b\u8fdb\u961f\u5217\u7528CAS\u5b9e\u73b0\u7684\u65b9\u5f0f\uff0c\u57fa\u672c\u4e0a\u6765\u8bf4\u5c31\u662f\u94fe\u8868\u7684\u4e24\u6b65\u64cd\u4f5c\uff1a<\/p>\n<ol>\n<li>\u7b2c\u4e00\u6b65\uff0c\u628atail\u6307\u9488\u7684next\u6307\u5411\u8981\u52a0\u5165\u7684\u7ed3\u70b9\u3002 <code>tail-&gt;next = p;<\/code><\/li>\n<li>\u7b2c\u4e8c\u6b65\uff0c\u628atail\u6307\u9488\u79fb\u5230\u961f\u5c3e\u3002 <code>tail = p;<\/code><\/li>\n<\/ol>\n<pre class=\"EnlighterJSRAW\" data-enlighter-language=\"c\">\nEnQueue(Q, data) \/\/\u8fdb\u961f\u5217\n{\n    \/\/\u51c6\u5907\u65b0\u52a0\u5165\u7684\u7ed3\u70b9\u6570\u636e\n    n = new node();\n    n-&gt;value = data;\n    n-&gt;next = NULL;\n\n    do {\n        p = Q-&gt;tail; \/\/\u53d6\u94fe\u8868\u5c3e\u6307\u9488\u7684\u5feb\u7167\n    } while( CAS(p-&gt;next, NULL, n) != TRUE); \n    \/\/while\u6761\u4ef6\u6ce8\u91ca\uff1a\u5982\u679c\u6ca1\u6709\u628a\u7ed3\u70b9\u94fe\u5728\u5c3e\u6307\u9488\u4e0a\uff0c\u518d\u8bd5\n\n    CAS(Q-&gt;tail, p, n); \/\/\u7f6e\u5c3e\u7ed3\u70b9 tail = n;\n}<\/pre>\n<p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\uff0c\u7a0b\u5e8f\u4e2d\u7684\u90a3\u4e2a do-while \u7684 Retry-Loop \u4e2d\u7684 CAS \u64cd\u4f5c\uff1a\u5982\u679c <code>p-&gt;next<\/code> \u662f <code>NULL<\/code>\uff0c\u90a3\u4e48\uff0c\u628a\u65b0\u7ed3\u70b9 <code>n<\/code> \u52a0\u5230\u961f\u5c3e\u3002\u5982\u679c\u4e0d\u6210\u529f\uff0c\u5219\u91cd\u65b0\u518d\u6765\u4e00\u6b21\uff01<\/p>\n<p>\u5c31\u662f\u8bf4\uff0c\u5f88\u6709\u53ef\u80fd\u6211\u5728\u51c6\u5907\u5728\u961f\u5217\u5c3e\u52a0\u5165\u7ed3\u70b9\u65f6\uff0c\u522b\u7684\u7ebf\u7a0b\u5df2\u7ecf\u52a0\u6210\u529f\u4e86\uff0c\u4e8e\u662ftail\u6307\u9488\u5c31\u53d8\u4e86\uff0c\u4e8e\u662f\u6211\u7684CAS\u8fd4\u56de\u4e86false\uff0c\u4e8e\u662f\u7a0b\u5e8f\u518d\u8bd5\uff0c\u76f4\u5230\u8bd5\u6210\u529f\u4e3a\u6b62\u3002\u8fd9\u4e2a\u5f88\u50cf\u6211\u4eec\u7684\u62a2\u7535\u8bdd\u70ed\u7ebf\u7684\u4e0d\u505c\u91cd\u64ad\u7684\u60c5\u51b5\u3002<\/p>\n<p>\u4f46\u662f\u4f60\u4f1a\u770b\u5230\uff0c\u4e3a\u4ec0\u4e48\u6211\u4eec\u7684\u201c\u7f6e\u5c3e\u7ed3\u70b9\u201d\u7684\u64cd\u4f5c\uff08\u7b2c13\u884c\uff09\u4e0d\u5224\u65ad\u662f\u5426\u6210\u529f\uff0c\u56e0\u4e3a\uff1a<\/p>\n<ol>\n<li>\u5982\u679c\u6709\u4e00\u4e2a\u7ebf\u7a0bT1\uff0c\u5b83\u7684while\u4e2d\u7684CAS\u5982\u679c\u6210\u529f\u7684\u8bdd\uff0c\u90a3\u4e48\u5176\u5b83\u6240\u6709\u7684 \u968f\u540e\u7ebf\u7a0b\u7684CAS\u90fd\u4f1a\u5931\u8d25\uff0c\u7136\u540e\u5c31\u4f1a\u518d\u5faa\u73af\uff0c<\/li>\n<li>\u6b64\u65f6\uff0c\u5982\u679cT1 \u7ebf\u7a0b\u8fd8\u6ca1\u6709\u66f4\u65b0tail\u6307\u9488\uff0c\u5176\u5b83\u7684\u7ebf\u7a0b\u7ee7\u7eed\u5931\u8d25\uff0c\u56e0\u4e3a<code>tail-&gt;next<\/code>\u4e0d\u662fNULL\u4e86\u3002<\/li>\n<li>\u76f4\u5230T1\u7ebf\u7a0b\u66f4\u65b0\u5b8c <code>tail<\/code> \u6307\u9488\uff0c\u4e8e\u662f\u5176\u5b83\u7684\u7ebf\u7a0b\u4e2d\u7684\u67d0\u4e2a\u7ebf\u7a0b\u5c31\u53ef\u4ee5\u5f97\u5230\u65b0\u7684 <code>tail<\/code> \u6307\u9488\uff0c\u7ee7\u7eed\u5f80\u4e0b\u8d70\u4e86\u3002<\/li>\n<li>\u6240\u4ee5\uff0c\u53ea\u8981\u7ebf\u7a0b\u80fd\u4ece while \u5faa\u73af\u4e2d\u9000\u51fa\u6765\uff0c\u610f\u5473\u7740\uff0c\u5b83\u5df2\u7ecf\u201c\u72ec\u5360\u201d\u4e86\uff0c<code>tail<\/code> \u6307\u9488\u5fc5\u7136\u53ef\u4ee5\u88ab\u66f4\u65b0\u3002<\/li>\n<\/ol>\n<p>\u8fd9\u91cc\u6709\u4e00\u4e2a\u6f5c\u5728\u7684\u95ee\u9898\u2014\u2014<strong>\u5982\u679cT1\u7ebf\u7a0b\u5728\u7528CAS\u66f4\u65b0tail\u6307\u9488\u7684\u4e4b\u524d\uff0c\u7ebf\u7a0b\u505c\u6389\u6216\u662f\u6302\u6389\u4e86\uff0c\u90a3\u4e48\u5176\u5b83\u7ebf\u7a0b\u5c31\u8fdb\u5165\u6b7b\u5faa\u73af\u4e86<\/strong>\u3002\u4e0b\u9762\u662f\u6539\u826f\u7248\u7684EnQueue()<\/p>\n<pre class=\"EnlighterJSRAW\" data-enlighter-language=\"c\" data-enlighter-highlight=\"10,11\">EnQueue(Q, data) \/\/\u8fdb\u961f\u5217\u6539\u826f\u7248 v1\n{\n    n = new node();\n    n-&gt;value = data;\n    n-&gt;next = NULL;\n\n    p = Q-&gt;tail;\n    oldp = p\n    do {\n        while (p-&gt;next != NULL)\n            p = p-&gt;next;\n    } while( CAS(p.next, NULL, n) != TRUE); \/\/\u5982\u679c\u6ca1\u6709\u628a\u7ed3\u70b9\u94fe\u5728\u5c3e\u4e0a\uff0c\u518d\u8bd5\n\n    CAS(Q-&gt;tail, oldp, n); \/\/\u7f6e\u5c3e\u7ed3\u70b9\n}<\/pre>\n<p>\u6211\u4eec\u8ba9\u6bcf\u4e2a\u7ebf\u7a0b\uff0c\u81ea\u5df1fetch \u6307\u9488 <code>p<\/code> \u5230\u94fe\u8868\u5c3e\u3002\u4f46\u662f\u8fd9\u6837\u7684fetch\u4f1a\u5f88\u5f71\u54cd\u6027\u80fd\u3002\u800c\u4e14\uff0c\u5982\u679c\u4e00\u4e2a\u7ebf\u7a0b\u4e0d\u65ad\u7684EnQueue\uff0c\u4f1a\u5bfc\u81f4\u6240\u6709\u7684\u5176\u5b83\u7ebf\u7a0b\u90fd\u53bb fetch \u4ed6\u4eec\u7684 <code>p<\/code> \u6307\u9488\u5230\u961f\u5c3e\uff0c\u80fd\u4e0d\u80fd\u4e0d\u8981\u6240\u6709\u7684\u7ebf\u7a0b\u90fd\u5e72\u540c\u4e00\u4e2a\u4e8b\uff1f\u8fd9\u6837\u53ef\u4ee5\u8282\u7701\u6574\u4f53\u7684\u65f6\u95f4\uff1f<\/p>\n<p>\u6bd4\u5982\uff1a\u76f4\u63a5 fetch <code>Q-&gt;tail<\/code> \u5230\u961f\u5c3e\uff1f\u56e0\u4e3a\uff0c\u6240\u6709\u7684\u7ebf\u7a0b\u90fd\u5171\u4eab\u7740 Q-&gt;tail\uff0c\u6240\u4ee5\uff0c\u4e00\u65e6\u6709\u4eba\u52a8\u4e86\u5b83\u540e\uff0c\u76f8\u5f53\u4e8e\u5176\u5b83\u7684\u7ebf\u7a0b\u4e5f\u8ddf\u7740\u52a8\u4e86\uff0c\u4e8e\u662f\uff0c\u6211\u4eec\u7684\u4ee3\u7801\u53ef\u4ee5\u6539\u8fdb\u6210\u5982\u4e0b\u7684\u5b9e\u73b0\uff1a<\/p>\n<pre class=\"EnlighterJSRAW\" data-enlighter-language=\"c\">\nEnQueue(Q, data) \/\/\u8fdb\u961f\u5217\u6539\u826f\u7248 v2 \n{\n    n = new node();\n    n-&gt;value = data;\n    n-&gt;next = NULL;\n\n    while(TRUE) {\n        \/\/\u5148\u53d6\u4e00\u4e0b\u5c3e\u6307\u9488\u548c\u5c3e\u6307\u9488\u7684next\n        tail = Q-&gt;tail;\n        next = tail-&gt;next;\n\n        \/\/\u5982\u679c\u5c3e\u6307\u9488\u5df2\u7ecf\u88ab\u79fb\u52a8\u4e86\uff0c\u5219\u91cd\u65b0\u5f00\u59cb\n        if ( tail != Q-&gt;tail ) continue;\n\n        \/\/\u5982\u679c\u5c3e\u6307\u9488\u7684 next \u4e0d\u4e3aNULL\uff0c\u5219 fetch \u5168\u5c40\u5c3e\u6307\u9488\u5230next\n        if ( next != NULL ) {\n            CAS(Q-&gt;tail, tail, next);\n            continue;\n        }\n\n        \/\/\u5982\u679c\u52a0\u5165\u7ed3\u70b9\u6210\u529f\uff0c\u5219\u9000\u51fa\n        if ( CAS(tail-&gt;next, next, n) == TRUE ) break;\n    }\n    CAS(Q-&gt;tail, tail, n); \/\/\u7f6e\u5c3e\u7ed3\u70b9\n}\n<\/pre>\n<p>\u4e0a\u8ff0\u7684\u4ee3\u7801\u8fd8\u662f\u5f88\u6e05\u695a\u7684\uff0c\u76f8\u4fe1\u4f60\u4e00\u5b9a\u80fd\u770b\u61c2\uff0c\u800c\u4e14\uff0c\u8fd9\u4e5f\u662f Java \u4e2d\u7684 <code>ConcurrentLinkedQueue<\/code> \u7684\u5b9e\u73b0\u903b\u8f91\uff0c\u5f53\u7136\uff0c\u6211\u4e0a\u9762\u7684\u8fd9\u4e2a\u7248\u672c\u6bd4 Java \u7684\u597d\u4e00\u70b9\uff0c\u56e0\u4e3a\u6ca1\u6709 if \u5d4c\u5957\uff0c\u563f\u563f\u3002<\/p>\n<p>\u597d\u4e86\uff0c\u6211\u4eec\u89e3\u51b3\u4e86EnQueue\uff0c\u6211\u4eec\u518d\u6765\u770b\u770bDeQueue\u7684\u4ee3\u7801\uff1a\uff08\u5f88\u7b80\u5355\uff0c\u6211\u5c31\u4e0d\u89e3\u91ca\u4e86\uff09<\/p>\n<pre class=\"EnlighterJSRAW\" data-enlighter-language=\"c\">\nDeQueue(Q) \/\/\u51fa\u961f\u5217\n{\n    do{\n        p = Q-&gt;head;\n        if (p-&gt;next == NULL){\n            return ERR_EMPTY_QUEUE;\n        }\n    while( CAS(Q-&gt;head, p, p-&gt;next) != TRUE );\n    return p-&gt;next-&gt;value;\n}<\/pre>\n<p><strong>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\uff0cDeQueue\u7684\u4ee3\u7801\u64cd\u4f5c\u7684\u662f <code>head-&gt;next<\/code>\uff0c\u800c\u4e0d\u662f <code>head<\/code> \u672c\u8eab\u3002\u8fd9\u6837\u8003\u8651\u662f\u56e0\u4e3a\u4e00\u4e2a\u8fb9\u754c\u6761\u4ef6\uff0c\u6211\u4eec\u9700\u8981\u4e00\u4e2adummy\u7684\u5934\u6307\u9488\u6765\u89e3\u51b3\u94fe\u8868\u4e2d\u5982\u679c\u53ea\u6709\u4e00\u4e2a\u5143\u7d20\uff0c<code>head<\/code> \u548c <code>tail<\/code> \u90fd\u6307\u5411\u540c\u4e00\u4e2a\u7ed3\u70b9\u7684\u95ee\u9898\uff0c\u8fd9\u6837 <code>EnQueue<\/code> \u548c <code>DeQueue<\/code> \u8981\u4e92\u76f8\u6392\u65a5\u4e86<\/strong>\u3002<\/p>\n<p>\u4f46\u662f\uff0c\u5982\u679c <code>head<\/code> \u548c <code>tail<\/code> \u90fd\u6307\u5411\u540c\u4e00\u4e2a\u7ed3\u70b9\uff0c\u8fd9\u610f\u5473\u7740\u961f\u5217\u4e3a\u7a7a\uff0c\u5e94\u8be5\u8fd4\u56de <code>ERR_EMPTY_QUEUE<\/code>\uff0c\u4f46\u662f\uff0c\u5728\u5224\u65ad <code>p-&gt;next == NULL<\/code> \u65f6\uff0c\u53e6\u5916\u4e00\u4e2aEnQueue\u64cd\u4f5c\u505a\u4e86\u4e00\u534a\uff0c\u6b64\u65f6\u7684 p-&gt;next \u4e0d\u4e3a NULL\u4e86\uff0c\u4f46\u662f tail \u6307\u9488\u8fd8\u5dee\u6700\u540e\u4e00\u6b65\uff0c\u6ca1\u6709\u66f4\u65b0\u5230\u65b0\u52a0\u7684\u7ed3\u70b9\uff0c\u8fd9\u4e2a\u65f6\u5019\u5c31\u4f1a\u51fa\u73b0\uff0c\u5728 EnQueue \u5e76\u6ca1\u6709\u5b8c\u6210\u7684\u65f6\u5019\uff0c DeQueue \u5df2\u7ecf\u628a\u65b0\u589e\u52a0\u7684\u7ed3\u70b9\u7ed9\u53d6\u8d70\u4e86\uff0c\u6b64\u65f6\uff0c\u961f\u5217\u4e3a\u7a7a\uff0c\u4f46\u662f\uff0chead \u4e0e tail \u5e76\u6ca1\u6709\u6307\u5411\u540c\u4e00\u4e2a\u7ed3\u70b9\u3002\u5982\u4e0b\u6240\u793a\uff1a<\/p>\n<p><img decoding=\"async\" loading=\"lazy\" class=\"aligncenter wp-image-20047\" src=\"https:\/\/coolshell.cn\/wp-content\/uploads\/2012\/09\/lock.free_.queue_-224x300.png\" alt=\"\" width=\"400\" height=\"537\" srcset=\"https:\/\/coolshell.cn\/wp-content\/uploads\/2012\/09\/lock.free_.queue_-224x300.png 224w, https:\/\/coolshell.cn\/wp-content\/uploads\/2012\/09\/lock.free_.queue_-201x270.png 201w, https:\/\/coolshell.cn\/wp-content\/uploads\/2012\/09\/lock.free_.queue_.png 706w\" sizes=\"(max-width: 400px) 100vw, 400px\" \/><\/p>\n<p>\u867d\u7136\uff0cEnQueue\u7684\u51fd\u6570\u4f1a\u628a tail \u6307\u9488\u7f6e\u5bf9\uff0c\u4f46\u662f\uff0c\u8fd9\u79cd\u60c5\u51b5\u53ef\u80fd\u8fd8\u662f\u4f1a\u5bfc\u81f4\u4e00\u4e9b\u5e76\u53d1\u95ee\u9898\uff0c\u6240\u4ee5\uff0c\u4e25\u8c28\u6765\u8bf4\uff0c\u6211\u4eec\u9700\u8981\u907f\u514d\u8fd9\u79cd\u60c5\u51b5\u3002\u4e8e\u662f\uff0c\u6211\u4eec\u9700\u8981\u52a0\u5165\u66f4\u591a\u7684\u5224\u65ad\u6761\u4ef6\uff0c\u8fd8\u786e\u4fdd\u8fd9\u4e2a\u95ee\u9898\u3002\u4e0b\u9762\u662f\u76f8\u5173\u7684\u6539\u8fdb\u4ee3\u7801\uff1a<\/p>\n<pre class=\"EnlighterJSRAW\" data-enlighter-language=\"c\">\nDeQueue(Q) \/\/\u51fa\u961f\u5217\uff0c\u6539\u8fdb\u7248\n{\n    while(TRUE) {\n        \/\/\u53d6\u51fa\u5934\u6307\u9488\uff0c\u5c3e\u6307\u9488\uff0c\u548c\u7b2c\u4e00\u4e2a\u5143\u7d20\u7684\u6307\u9488\n        head = Q-&gt;head;\n        tail = Q-&gt;tail;\n        next = head-&gt;next;\n\n        \/\/ Q-&gt;head \u6307\u9488\u5df2\u79fb\u52a8\uff0c\u91cd\u65b0\u53d6 head\u6307\u9488\n        if ( head != Q-&gt;head ) continue;\n        \n        \/\/ \u5982\u679c\u662f\u7a7a\u961f\u5217\n        if ( head == tail &amp;&amp; next == NULL ) {\n            return ERR_EMPTY_QUEUE;\n        }\n        \n        \/\/\u5982\u679c tail \u6307\u9488\u843d\u540e\u4e86\n        if ( head == tail &amp;&amp; next == NULL ) {\n            CAS(Q-&gt;tail, tail, next);\n            continue;\n        }\n\n        \/\/\u79fb\u52a8 head \u6307\u9488\u6210\u529f\u540e\uff0c\u53d6\u51fa\u6570\u636e\n        if ( CAS( Q-&gt;head, head, next) == TRUE){\n            value = next-&gt;value;\n            break;\n        }\n    }\n    free(head); \/\/\u91ca\u653e\u8001\u7684dummy\u7ed3\u70b9\n    return value;\n}<\/pre>\n<p>\u4e0a\u9762\u8fd9\u6bb5\u4ee3\u7801\u7684\u903b\u8f91\u548c Java \u7684 <code>ConcurrentLinkedQueue<\/code> \u7684 <code>poll<\/code> \u65b9\u6cd5\u5f88\u4e00\u81f4\u4e86\u3002\u4e5f\u662f\u300a<a href=\"https:\/\/www.cs.rochester.edu\/u\/scott\/papers\/1996_PODC_queues.pdf\" target=\"_blank\" rel=\"noopener noreferrer\">Simple, Fast, and Practical Non-Blocking and Blocking ConcurrentQueue Algorithms<\/a>\u300b\u8fd9\u7bc7\u8bba\u6587\u4e2d\u7684\u5b9e\u73b0\u3002<\/p>\n<h4><span class=\"ez-toc-section\" id=\"CAS%E7%9A%84ABA%E9%97%AE%E9%A2%98\"><\/span>CAS\u7684ABA\u95ee\u9898<span class=\"ez-toc-section-end\"><\/span><\/h4>\n<p>\u6240\u8c13ABA\uff08<a href=\"http:\/\/en.wikipedia.org\/wiki\/ABA_problem\" target=\"_blank\" rel=\"noopener noreferrer\">\u89c1\u7ef4\u57fa\u767e\u79d1\u7684ABA\u8bcd\u6761<\/a>\uff09\uff0c\u95ee\u9898\u57fa\u672c\u662f\u8fd9\u4e2a\u6837\u5b50\uff1a<\/p>\n<ol>\n<li>\u8fdb\u7a0bP1\u5728\u5171\u4eab\u53d8\u91cf\u4e2d\u8bfb\u5230\u503c\u4e3aA<\/li>\n<li>P1\u88ab\u62a2\u5360\u4e86\uff0c\u8fdb\u7a0bP2\u6267\u884c<\/li>\n<li>P2\u628a\u5171\u4eab\u53d8\u91cf\u91cc\u7684\u503c\u4eceA\u6539\u6210\u4e86B\uff0c\u518d\u6539\u56de\u5230A\uff0c\u6b64\u65f6\u88abP1\u62a2\u5360\u3002<\/li>\n<li>P1\u56de\u6765\u770b\u5230\u5171\u4eab\u53d8\u91cf\u91cc\u7684\u503c\u6ca1\u6709\u88ab\u6539\u53d8\uff0c\u4e8e\u662f\u7ee7\u7eed\u6267\u884c\u3002<\/li>\n<\/ol>\n<p>\u867d\u7136P1\u4ee5\u4e3a\u53d8\u91cf\u503c\u6ca1\u6709\u6539\u53d8\uff0c\u7ee7\u7eed\u6267\u884c\u4e86\uff0c\u4f46\u662f\u8fd9\u4e2a\u4f1a\u5f15\u53d1\u4e00\u4e9b\u6f5c\u5728\u7684\u95ee\u9898\u3002<strong>ABA\u95ee\u9898\u6700\u5bb9\u6613\u53d1\u751f\u5728lock free \u7684\u7b97\u6cd5\u4e2d\u7684\uff0cCAS\u9996\u5f53\u5176\u51b2\uff0c\u56e0\u4e3aCAS\u5224\u65ad\u7684\u662f\u6307\u9488\u7684\u503c\u3002\u5f88\u660e\u663e\uff0c\u503c\u662f\u5f88\u5bb9\u6613\u53c8\u53d8\u6210\u539f\u6837\u7684\u3002<\/strong><\/p>\n<p>\u6bd4\u5982\u4e0a\u8ff0\u7684DeQueue()\u51fd\u6570\uff0c\u56e0\u4e3a\u6211\u4eec\u8981\u8ba9head\u548ctail\u5206\u5f00\uff0c\u6240\u4ee5\u6211\u4eec\u5f15\u5165\u4e86\u4e00\u4e2adummy\u6307\u9488\u7ed9head\uff0c\u5f53\u6211\u4eec\u505aCAS\u7684\u4e4b\u524d\uff0c\u5982\u679chead\u7684\u90a3\u5757\u5185\u5b58\u88ab\u56de\u6536\u5e76\u88ab\u91cd\u7528\u4e86\uff0c\u800c\u91cd\u7528\u7684\u5185\u5b58\u53c8\u88abEnQueue()\u8fdb\u6765\u4e86\uff0c\u8fd9\u4f1a\u6709\u5f88\u5927\u7684\u95ee\u9898\u3002\uff08<strong>\u5185\u5b58\u7ba1\u7406\u4e2d\u91cd\u7528\u5185\u5b58\u57fa\u672c\u4e0a\u662f\u4e00\u79cd\u5f88\u5e38\u89c1\u7684\u884c\u4e3a<\/strong>\uff09<\/p>\n<p>\u8fd9\u4e2a\u4f8b\u5b50\u4f60\u53ef\u80fd\u6ca1\u6709\u770b\u61c2\uff0c\u7ef4\u57fa\u767e\u79d1\u4e0a\u7ed9\u4e86\u4e00\u4e2a\u6d3b\u751f\u751f\u7684\u4f8b\u5b50\u2014\u2014<\/p>\n<blockquote><p>\u4f60\u62ff\u7740\u4e00\u4e2a\u88c5\u6ee1\u94b1\u7684\u624b\u63d0\u7bb1\u5728\u98de\u673a\u573a\uff0c\u6b64\u65f6\u8fc7\u6765\u4e86\u4e00\u4e2a\u706b\u8fa3\u6027\u611f\u7684\u7f8e\u5973\uff0c\u7136\u540e\u5979\u5f88\u6696\u6627\u5730\u6311\u9017\u7740\u4f60\uff0c\u5e76\u8d81\u4f60\u4e0d\u6ce8\u610f\u7684\u65f6\u5019\uff0c\u628a\u7528\u4e00\u4e2a\u4e00\u6a21\u4e00\u6837\u7684\u624b\u63d0\u7bb1\u548c\u4f60\u90a3\u88c5\u6ee1\u94b1\u7684\u7bb1\u5b50\u8c03\u4e86\u4e2a\u5305\uff0c\u7136\u540e\u5c31\u79bb\u5f00\u4e86\uff0c\u4f60\u770b\u5230\u4f60\u7684\u624b\u63d0\u7bb1\u8fd8\u5728\u90a3\uff0c\u4e8e\u662f\u5c31\u63d0\u7740\u624b\u63d0\u7bb1\u53bb\u8d76\u98de\u673a\u53bb\u4e86\u3002<\/p><\/blockquote>\n<p>\u8fd9\u5c31\u662fABA\u7684\u95ee\u9898\u3002<\/p>\n<h4><span class=\"ez-toc-section\" id=\"%E8%A7%A3%E5%86%B3ABA%E7%9A%84%E9%97%AE%E9%A2%98\"><\/span>\u89e3\u51b3ABA\u7684\u95ee\u9898<span class=\"ez-toc-section-end\"><\/span><\/h4>\n<p>\u7ef4\u57fa\u767e\u79d1\u4e0a\u7ed9\u4e86\u4e00\u4e2a\u89e3\u2014\u2014\u4f7f\u7528double-CAS\uff08\u53cc\u4fdd\u9669\u7684CAS\uff09\uff0c\u4f8b\u5982\uff0c\u572832\u4f4d\u7cfb\u7edf\u4e0a\uff0c\u6211\u4eec\u8981\u68c0\u67e564\u4f4d\u7684\u5185\u5bb9<\/p>\n<p style=\"padding-left: 30px;\">1\uff09\u4e00\u6b21\u7528CAS\u68c0\u67e5\u53cc\u500d\u957f\u5ea6\u7684\u503c\uff0c\u524d\u534a\u90e8\u662f\u503c\uff0c\u540e\u534a\u90e8\u5206\u662f\u4e00\u4e2a\u8ba1\u6570\u5668\u3002<\/p>\n<p style=\"padding-left: 30px;\">2\uff09\u53ea\u6709\u8fd9\u4e24\u4e2a\u90fd\u4e00\u6837\uff0c\u624d\u7b97\u901a\u8fc7\u68c0\u67e5\uff0c\u8981\u5427\u8d4b\u65b0\u7684\u503c\u3002\u5e76\u628a\u8ba1\u6570\u5668\u7d2f\u52a01\u3002<\/p>\n<p>\u8fd9\u6837\u4e00\u6765\uff0cABA\u53d1\u751f\u65f6\uff0c\u867d\u7136\u503c\u4e00\u6837\uff0c\u4f46\u662f\u8ba1\u6570\u5668\u5c31\u4e0d\u4e00\u6837\uff08\u4f46\u662f\u572832\u4f4d\u7684\u7cfb\u7edf\u4e0a\uff0c\u8fd9\u4e2a\u8ba1\u6570\u5668\u4f1a\u6ea2\u51fa\u56de\u6765\u53c8\u4ece1\u5f00\u59cb\u7684\uff0c\u8fd9\u8fd8\u662f\u4f1a\u6709ABA\u7684\u95ee\u9898\uff09<\/p>\n<p>\u5f53\u7136\uff0c\u6211\u4eec\u8fd9\u4e2a\u961f\u5217\u7684\u95ee\u9898\u5c31\u662f\u4e0d\u60f3\u8ba9\u90a3\u4e2a\u5185\u5b58\u91cd\u7528\uff0c\u8fd9\u6837\u660e\u786e\u7684\u4e1a\u52a1\u95ee\u9898\u6bd4\u8f83\u597d\u89e3\u51b3\uff0c\u8bba\u6587\u300a<a href=\"http:\/\/citeseerx.ist.psu.edu\/viewdoc\/download?doi=10.1.1.53.8674&amp;rep=rep1&amp;type=pdf\" target=\"_blank\" rel=\"noopener noreferrer\">Implementing Lock-Free Queues<\/a>\u300b\u7ed9\u51fa\u4e00\u8fd9\u4e48\u4e00\u4e2a\u65b9\u6cd5\u2014\u2014<strong>\u4f7f\u7528\u7ed3\u70b9\u5185\u5b58\u5f15\u7528\u8ba1\u6570refcnt<\/strong>\uff01\uff08\u8bba\u6587\u300a<a href=\"https:\/\/www.cs.rochester.edu\/u\/scott\/papers\/1996_PODC_queues.pdf\" target=\"_blank\" rel=\"noopener noreferrer\">Simple, Fast, and Practical Non-Blocking and Blocking ConcurrentQueue Algorithms<\/a>\u300b\u4e2d\u7684\u5b9e\u73b0\u65b9\u6cd5\u4e5f\u57fa\u672c\u4e0a\u662f\u4e00\u6837\u7684\uff0c\u7528\u5230\u7684\u662f\u589e\u52a0\u4e00\u4e2a\u8ba1\u6570\uff0c\u53ef\u4ee5\u7406\u89e3\u4e3a\u7248\u672c\u53f7\uff09<\/p>\n<p>\uff09<\/p>\n<pre class=\"EnlighterJSRAW\" data-enlighter-language=\"c\" data-enlighter-highlight=\"9,14\">SafeRead(q)\n{\n    loop:\n        p = q-&gt;next;\n        if (p == NULL){\n            return p;\n        }\n\n        Fetch&amp;Add(p-&gt;refcnt, 1);\n\n        if (p == q-&gt;next){\n            return p;\n        }else{\n            Release(p);\n        }\n    goto loop;\n}<\/pre>\n<p>\u5176\u4e2d\u7684 Fetch&amp;Add\u548cRelease\u5206\u662f\u662f\u52a0\u5f15\u7528\u8ba1\u6570\u548c\u51cf\u5f15\u7528\u8ba1\u6570\uff0c\u90fd\u662f\u539f\u5b50\u64cd\u4f5c\uff0c\u8fd9\u6837\u5c31\u53ef\u4ee5\u963b\u6b62\u5185\u5b58\u88ab\u56de\u6536\u4e86\u3002<\/p>\n<h4><span class=\"ez-toc-section\" id=\"%E7%94%A8%E6%95%B0%E7%BB%84%E5%AE%9E%E7%8E%B0%E6%97%A0%E9%94%81%E9%98%9F%E5%88%97\"><\/span>\u7528\u6570\u7ec4\u5b9e\u73b0\u65e0\u9501\u961f\u5217<span class=\"ez-toc-section-end\"><\/span><\/h4>\n<p>\u672c\u5b9e\u73b0\u6765\u81ea\u8bba\u6587\u300a<a href=\"http:\/\/citeseerx.ist.psu.edu\/viewdoc\/download?doi=10.1.1.53.8674&amp;rep=rep1&amp;type=pdf\" target=\"_blank\" rel=\"noopener noreferrer\">Implementing Lock-Free Queues<\/a>\u300b<\/p>\n<p>\u4f7f\u7528\u6570\u7ec4\u6765\u5b9e\u73b0\u961f\u5217\u662f\u5f88\u5e38\u89c1\u7684\u65b9\u6cd5\uff0c\u56e0\u4e3a\u6ca1\u6709\u5185\u5b58\u7684\u5206\u90e8\u548c\u91ca\u653e\uff0c\u4e00\u5207\u90fd\u4f1a\u53d8\u5f97\u7b80\u5355\uff0c\u5b9e\u73b0\u7684\u601d\u8def\u5982\u4e0b\uff1a<\/p>\n<p style=\"padding-left: 30px;\">1\uff09\u6570\u7ec4\u961f\u5217\u5e94\u8be5\u662f\u4e00\u4e2aring buffer\u5f62\u5f0f\u7684\u6570\u7ec4\uff08\u73af\u5f62\u6570\u7ec4\uff09<\/p>\n<p style=\"padding-left: 30px;\">2\uff09\u6570\u7ec4\u7684\u5143\u7d20\u5e94\u8be5\u6709\u4e09\u4e2a\u53ef\u80fd\u7684\u503c\uff1aHEAD\uff0cTAIL\uff0cEMPTY\uff08\u5f53\u7136\uff0c\u8fd8\u6709\u5b9e\u9645\u7684\u6570\u636e\uff09<\/p>\n<p style=\"padding-left: 30px;\">3\uff09\u6570\u7ec4\u4e00\u5f00\u59cb\u5168\u90e8\u521d\u59cb\u5316\u6210EMPTY\uff0c\u6709\u4e24\u4e2a\u76f8\u90bb\u7684\u5143\u7d20\u8981\u521d\u59cb\u5316\u6210HEAD\u548cTAIL\uff0c\u8fd9\u4ee3\u8868\u7a7a\u961f\u5217\u3002<\/p>\n<p style=\"padding-left: 30px;\">4\uff09EnQueue\u64cd\u4f5c\u3002\u5047\u8bbe\u6570\u636ex\u8981\u5165\u961f\u5217\uff0c\u5b9a\u4f4dTAIL\u7684\u4f4d\u7f6e\uff0c\u4f7f\u7528double-CAS\u65b9\u6cd5\u628a(TAIL, EMPTY) \u66f4\u65b0\u6210 (x, TAIL)\u3002\u9700\u8981\u6ce8\u610f\uff0c\u5982\u679c\u627e\u4e0d\u5230(TAIL, EMPTY)\uff0c\u5219\u8bf4\u660e\u961f\u5217\u6ee1\u4e86\u3002<\/p>\n<p style=\"padding-left: 30px;\">5\uff09DeQueue\u64cd\u4f5c\u3002\u5b9a\u4f4dHEAD\u7684\u4f4d\u7f6e\uff0c\u628a(HEAD, x)\u66f4\u65b0\u6210(EMPTY, HEAD)\uff0c\u5e76\u628ax\u8fd4\u56de\u3002\u540c\u6837\u9700\u8981\u6ce8\u610f\uff0c\u5982\u679cx\u662fTAIL\uff0c\u5219\u8bf4\u660e\u961f\u5217\u4e3a\u7a7a\u3002<\/p>\n<p>\u7b97\u6cd5\u7684\u4e00\u4e2a\u5173\u952e\u662f\u2014\u2014\u5982\u4f55\u5b9a\u4f4dHEAD\u6216TAIL\uff1f<\/p>\n<p style=\"padding-left: 30px;\">1\uff09\u6211\u4eec\u53ef\u4ee5\u58f0\u660e\u4e24\u4e2a\u8ba1\u6570\u5668\uff0c\u4e00\u4e2a\u7528\u6765\u8ba1\u6570EnQueue\u7684\u6b21\u6570\uff0c\u4e00\u4e2a\u7528\u6765\u8ba1\u6570DeQueue\u7684\u6b21\u6570\u3002<\/p>\n<p style=\"padding-left: 30px;\">2\uff09\u8fd9\u4e24\u4e2a\u8ba1\u7b97\u5668\u4f7f\u7528\u4f7f\u7528Fetch&amp;ADD\u6765\u8fdb\u884c\u539f\u5b50\u7d2f\u52a0\uff0c\u5728EnQueue\u6216DeQueue\u5b8c\u6210\u7684\u65f6\u5019\u7d2f\u52a0\u5c31\u597d\u4e86\u3002<\/p>\n<p style=\"padding-left: 30px;\">3\uff09\u7d2f\u52a0\u540e\u6c42\u4e2a\u6a21\u4ec0\u4e48\u7684\u5c31\u53ef\u4ee5\u77e5\u9053TAIL\u548cHEAD\u7684\u4f4d\u7f6e\u4e86\u3002<\/p>\n<p>\u5982\u4e0b\u56fe\u6240\u793a\uff1a<\/p>\n<p><img decoding=\"async\" loading=\"lazy\" class=\"aligncenter size-full wp-image-8240\" title=\"Lock-Free Queue(Array)\" src=\"https:\/\/coolshell.cn\/wp-content\/uploads\/2012\/09\/lock-free-array.jpg\" alt=\"\" width=\"477\" height=\"215\" srcset=\"https:\/\/coolshell.cn\/wp-content\/uploads\/2012\/09\/lock-free-array.jpg 477w, https:\/\/coolshell.cn\/wp-content\/uploads\/2012\/09\/lock-free-array-300x135.jpg 300w\" sizes=\"(max-width: 477px) 100vw, 477px\" \/><\/p>\n<h4 style=\"text-align: left;\"><span class=\"ez-toc-section\" id=\"_%E5%B0%8F%E7%BB%93\"><\/span>\u00a0\u5c0f\u7ed3<span class=\"ez-toc-section-end\"><\/span><\/h4>\n<p style=\"text-align: left;\">\u4ee5\u4e0a\u57fa\u672c\u4e0a\u5c31\u662f\u6240\u6709\u7684\u65e0\u9501\u961f\u5217\u7684\u6280\u672f\u7ec6\u8282\uff0c\u8fd9\u4e9b\u6280\u672f\u90fd\u53ef\u4ee5\u7528\u5728\u5176\u5b83\u7684\u65e0\u9501\u6570\u636e\u7ed3\u6784\u4e0a\u3002<\/p>\n<p style=\"text-align: left; padding-left: 30px;\">1\uff09\u65e0\u9501\u961f\u5217\u4e3b\u8981\u662f\u901a\u8fc7CAS\u3001FAA\u8fd9\u4e9b\u539f\u5b50\u64cd\u4f5c\uff0c\u548cRetry-Loop\u5b9e\u73b0\u3002<\/p>\n<p style=\"text-align: left; padding-left: 30px;\">2\uff09\u5bf9\u4e8eRetry-Loop\uff0c\u6211\u4e2a\u4eba\u611f\u89c9\u5176\u5b9e\u548c\u9501\u4ec0\u4e48\u4ec0\u4e48\u4e24\u6837\u3002\u53ea\u662f\u8fd9\u79cd\u201c\u9501\u201d\u7684\u7c92\u5ea6\u53d8\u5c0f\u4e86\uff0c\u4e3b\u8981\u662f\u201c\u9501\u201dHEAD\u548cTAIL\u8fd9\u4e24\u4e2a\u5173\u952e\u8d44\u6e90\u3002\u800c\u4e0d\u662f\u6574\u4e2a\u6570\u636e\u7ed3\u6784\u3002<\/p>\n<p style=\"text-align: left;\">\u8fd8\u6709\u4e00\u4e9b\u548cLock Free\u7684\u6587\u7ae0\u4f60\u53ef\u4ee5\u53bb\u770b\u770b\uff1a<\/p>\n<ul>\n<li>Code Project \u4e0a\u7684\u96c4\u6587 \u300a<a href=\"http:\/\/www.codeproject.com\/Articles\/153898\/Yet-another-implementation-of-a-lock-free-circular\" target=\"_blank\" rel=\"noopener noreferrer\">Yet another implementation of a lock-free circular array queue<\/a>\u300b<\/li>\n<li>Herb Sutter\u7684\u300a<a href=\"http:\/\/www.drdobbs.com\/parallel\/writing-lock-free-code-a-corrected-queue\/210604448?pgno=1\" target=\"_blank\" rel=\"noopener noreferrer\">Writing Lock-Free Code: A Corrected Queue<\/a>\u300b&#8211; \u7528C++11\u7684std::atomic\u6a21\u677f\u3002<\/li>\n<li>IBM developerWorks\u7684\u300a<a href=\"http:\/\/www.ibm.com\/developerworks\/cn\/aix\/library\/au-multithreaded_structures2\/index.html\" target=\"_blank\" rel=\"noopener noreferrer\">\u8bbe\u8ba1\u4e0d\u4f7f\u7528\u4e92\u65a5\u9501\u7684\u5e76\u53d1\u6570\u636e\u7ed3\u6784<\/a>\u300b<\/li>\n<\/ul>\n<div>\u3010<strong>\u6ce8\uff1a\u6211\u914d\u4e86\u4e00\u5f20look-free\u7684\u81ea\u884c\u8f66\uff0c\u5bd3\u610f\u4e3a\u2014\u2014\u5982\u679c\u4e0d\u7528\u4e13\u95e8\u7684\u8f66\u9501\uff0c\u90a3\u4e48\u81ea\u884c\u5f97\u81ea\u5df1\u9501\u81ea\u5df1\uff01<\/strong>\u3011<\/div>\n<p style=\"text-align: left;\">\u00a0\uff08\u5168\u6587\u5b8c\uff09<\/p>\n<p><audio style=\"display: none;\" controls=\"controls\"><\/audio><\/p>\n<p><audio style=\"display: none;\" controls=\"controls\"><\/audio><\/p>\n<p><audio style=\"display: none;\" controls=\"controls\"><\/audio><\/p>\n","raw":"","protected":false},"excerpt":{"rendered":"<p>\u2014\u2014\u2014\u2014\u6ce8\uff1a\u672c\u6587\u4e8e2019\u5e7411\u67084\u65e5\u66f4\u65b0\u2014\u2014\u2014\u2014 \u5173\u4e8e\u65e0\u9501\u961f\u5217\u7684\u5b9e\u73b0\uff0c\u7f51\u4e0a\u6709\u5f88\u591a\u6587\u7ae0\uff0c\u867d\u7136\u672c\u6587\u53ef\u80fd\u548c\u90a3\u4e9b\u6587\u7ae0\u6709\u6240\u91cd\u590d\uff0c\u4f46\u662f\u6211\u8fd8\u662f\u60f3\u4ee5\u6211\u81ea\u5df1\u7684\u65b9\u5f0f\u628a\u8fd9\u4e9b\u6587\u7ae0\u4e2d\u7684&#8230;<\/p>\n<p class=\"read-more\"><a class=\"btn btn-default\" href=\"https:\/\/coolshell.cn\/articles\/8239.html\"> Read More<span class=\"screen-reader-text\">  Read More<\/span><\/a><\/p>\n","protected":false},"author":2,"featured_media":0,"comment_status":"open","ping_status":"open","sticky":false,"template":"","format":"standard","meta":[],"categories":[5,23],"tags":[76,59,120,642],"series":[],"aioseo_notices":[],"views":274635,"post_thumbnail_image":"https:\/\/coolshell.cn\/wp-content\/uploads\/2012\/09\/lock_free_bicycle.jpg","content_first_image":"https:\/\/coolshell.cn\/wp-content\/uploads\/2012\/09\/lock_free_bicycle.jpg","post_medium_image_300":"https:\/\/coolshell.cn\/wp-content\/uploads\/2012\/09\/lock_free_bicycle.jpg","post_thumbnail_image_624":"https:\/\/coolshell.cn\/wp-content\/uploads\/2012\/09\/lock_free_bicycle.jpg","post_frist_image":"https:\/\/coolshell.cn\/wp-content\/uploads\/2012\/09\/lock_free_bicycle.jpg","post_medium_image":"https:\/\/coolshell.cn\/wp-content\/uploads\/2012\/09\/lock_free_bicycle.jpg","post_large_image":"https:\/\/coolshell.cn\/wp-content\/uploads\/2012\/09\/lock_free_bicycle.jpg","post_full_image":"https:\/\/coolshell.cn\/wp-content\/uploads\/2012\/09\/lock_free_bicycle.jpg","post_all_images":[{"imagesurl":"https:\/\/coolshell.cn\/wp-content\/uploads\/2012\/09\/lock_free_bicycle.jpg","id":"image0"},{"imagesurl":"https:\/\/coolshell.cn\/wp-content\/uploads\/2012\/09\/lock.free_.queue_-224x300.png","id":"image1"},{"imagesurl":"https:\/\/coolshell.cn\/wp-content\/uploads\/2012\/09\/lock-free-array.jpg","id":"image2"}],"videoAdId":"","listAd":"0","listAdId":"","listAdEvery":5,"total_comments":241,"category_name":"C\/C++\u8bed\u8a00","post_date":"2012-09-07","like_count":"0","praiseWord":"\u9f13\u52b1","excitationAd":"0","rewardedVideoAdId":"","detailAdId":"","detailAd":"0","enterpriseMinapp":"0","audios":[{"style":"display: none;","controls":"controls"},{"style":"display: none;","controls":"controls"},{"style":"display: none;","controls":"controls"}],"postImageUrl":"http:\/\/coolshell.cn\/wp-content\/uploads\/2016\/09\/coolshell-360x200.jpg","avatarurls":[],"related_posts":[],"pageviews":274636,"pageviews_wl":196198,"ratings_average":4,"ratings_total":223,"ratings_users":53,"next_post_id":8309,"next_post_title":"C\/C++\u8bed\u8a00\u4e2d\u95ed\u5305\u7684\u63a2\u7a76\u53ca\u6bd4\u8f83","previous_post_id":8052,"previous_post_title":"K Nearest Neighbor \u7b97\u6cd5"}