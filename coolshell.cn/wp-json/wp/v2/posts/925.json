{"id":925,"date":"2009-05-27T23:02:14","date_gmt":"2009-05-27T15:02:14","guid":{"rendered":"http:\/\/coolshell.cn\/?p=925"},"modified":"2009-05-27T23:02:14","modified_gmt":"2009-05-27T15:02:14","slug":"%e5%a6%82%e4%bd%95%e6%af%94%e8%be%83%e4%b8%a4%e4%b8%aa%e6%95%b0%e6%8d%ae%e8%a1%a8","status":"publish","type":"post","link":"https:\/\/coolshell.cn\/articles\/925.html","title":{"rendered":"\u5982\u4f55\u6bd4\u8f83\u4e24\u4e2a\u6570\u636e\u8868"},"content":{"rendered":"<p>\u6709\u4e9b\u65f6\u5019\uff0c\u6211\u4eec\u53ef\u80fd\u60f3\u8981\u6bd4\u8f83\u4e00\u4e0b\u4e24\u4e2a\u6570\u636e\u8868\uff0c\u4ee5\u627e\u5230\u5176\u4e2d\u4e0d\u540c\u7684\u6570\u636e\u3002\u6bd4\u5982\uff0c\u5728\u8fdb\u884c\u6570\u636e\u79fb\u690d\u7684\u65f6\u5019\uff0c\u6216\u662f\u5728\u5408\u5e76\u6570\u636e\u7684\u65f6\u5019\uff0c\u6216\u662f\u5728\u6bd4\u5bf9\u9a8c\u8bc1\u6570\u636e\u7684\u65f6\u5019\u3002\u5f53\u7136\u6bd4\u8f83\u4e24\u4e2a\u8868\uff0c\u9700\u8981\u8fd9\u4e24\u4e2a\u8868\u7ed3\u6784\u662f\u4e00\u6837\u7684\u3002<\/p>\n<p>\u6211\u4eec\u5148\u5047\u8bbe\u4e00\u4e0b\u6709\u5982\u4e0b\u8868\u7ed3\u6784\uff1a<\/p>\n<pre data-enlighter-language=\"sql\" class=\"EnlighterJSRAW\">\r\nCREATE TABLE jajal\r\n(\r\n\u00a0   user_id integer NOT NULL,\r\n\u00a0   first_name character varying(255),\r\n\u00a0   last_name character varying(255),\r\n\u00a0   grade character(1),\r\n\u00a0   CONSTRAINT jajal_pkey PRIMARY KEY (user_id)\r\n)\r\n<\/pre>\n<p><!--more--><br \/>\n\u7136\u540e\uff0c\u6211\u4eec\u6709\u4e24\u5f20\u8868\u2014\u2014jajal\u548cjajal_copy\uff0c\u5176\u5185\u5bb9\u5982\u4e0b\uff1a<\/p>\n<div id=\"ez-toc-container\" class=\"ez-toc-v2_0_48 counter-hierarchy ez-toc-counter ez-toc-grey ez-toc-container-direction\">\n<div class=\"ez-toc-title-container\">\n<p class=\"ez-toc-title\">\u76ee\u5f55<\/p>\n<span class=\"ez-toc-title-toggle\"><\/span><\/div>\n<nav><ul class='ez-toc-list ez-toc-list-level-1 ' ><li class='ez-toc-page-1 ez-toc-heading-level-4'><a class=\"ez-toc-link ez-toc-heading-1\" href=\"https:\/\/coolshell.cn\/articles\/925.html\/#_jajal\" title=\"\u00a0jajal\">\u00a0jajal<\/a><\/li><li class='ez-toc-page-1 ez-toc-heading-level-4'><a class=\"ez-toc-link ez-toc-heading-2\" href=\"https:\/\/coolshell.cn\/articles\/925.html\/#jajal_copy\" title=\"jajal_copy\">jajal_copy<\/a><\/li><li class='ez-toc-page-1 ez-toc-heading-level-4'><a class=\"ez-toc-link ez-toc-heading-3\" href=\"https:\/\/coolshell.cn\/articles\/925.html\/#%E4%BD%BF%E7%94%A8FULL_OUTER_JOIN\" title=\"\u4f7f\u7528FULL OUTER JOIN\">\u4f7f\u7528FULL OUTER JOIN<\/a><\/li><li class='ez-toc-page-1 ez-toc-heading-level-4'><a class=\"ez-toc-link ez-toc-heading-4\" href=\"https:\/\/coolshell.cn\/articles\/925.html\/#%E4%BD%BF%E7%94%A8NATURAL_FULL_OUTER_JOIN\" title=\"\u4f7f\u7528NATURAL FULL OUTER JOIN\">\u4f7f\u7528NATURAL FULL OUTER JOIN<\/a><\/li><li class='ez-toc-page-1 ez-toc-heading-level-4'><a class=\"ez-toc-link ez-toc-heading-5\" href=\"https:\/\/coolshell.cn\/articles\/925.html\/#MySQL_SQL_%E4%BB%A3%E7%A0%81\" title=\"MySQL SQL \u4ee3\u7801\">MySQL SQL \u4ee3\u7801<\/a><\/li><li class='ez-toc-page-1 ez-toc-heading-level-4'><a class=\"ez-toc-link ez-toc-heading-6\" href=\"https:\/\/coolshell.cn\/articles\/925.html\/#PostgreSQL_%E4%B8%8B%E7%9A%84SQL%E8%AF%AD%E5%8F%A5\" title=\"PostgreSQL \u4e0b\u7684SQL\u8bed\u53e5\">PostgreSQL \u4e0b\u7684SQL\u8bed\u53e5<\/a><\/li><\/ul><\/nav><\/div>\n<h4><span class=\"ez-toc-section\" id=\"_jajal\"><\/span>\u00a0jajal<span class=\"ez-toc-section-end\"><\/span><\/h4>\n<table id=\"wptable-7\" class=\"wptable rowstyle-alt\" border=\"0\" cellspacing=\"1\">\n<thead>\n<tr>\n<th class=\"sortable\" style=\"width: 30px;\" align=\"center\">user_id<\/th>\n<th class=\"sortable\" style=\"width: 30px;\" align=\"center\">first_name<\/th>\n<th class=\"sortable\" style=\"width: 30px;\" align=\"center\">last_name<\/th>\n<th class=\"sortable\" style=\"width: 30px;\" align=\"center\">grade<\/th>\n<\/tr>\n<\/thead>\n<tbody>\n<tr>\n<td style=\"width: 30px;\" align=\"center\">1<\/td>\n<td style=\"width: 30px;\" align=\"center\">Some<\/td>\n<td style=\"width: 30px;\" align=\"center\">Dude<\/td>\n<td style=\"width: 30px;\" align=\"center\">A<\/td>\n<\/tr>\n<tr class=\"alt\">\n<td style=\"width: 30px;\" align=\"center\">2<\/td>\n<td style=\"width: 30px;\" align=\"center\">Other<\/td>\n<td style=\"width: 30px;\" align=\"center\">Guy<\/td>\n<td style=\"width: 30px;\" align=\"center\">B<\/td>\n<\/tr>\n<tr>\n<td style=\"width: 30px;\" align=\"center\">3<\/td>\n<td style=\"width: 30px;\" align=\"center\">You are<\/td>\n<td style=\"width: 30px;\" align=\"center\">Welcome<\/td>\n<td style=\"width: 30px;\" align=\"center\">B<\/td>\n<\/tr>\n<tr class=\"alt\">\n<td style=\"width: 30px;\" align=\"center\">4<\/td>\n<td style=\"width: 30px;\" align=\"center\">What<\/td>\n<td style=\"width: 30px;\" align=\"center\">Other<\/td>\n<td style=\"width: 30px;\" align=\"center\">A<\/td>\n<\/tr>\n<tr>\n<td style=\"width: 30px;\" align=\"center\">5<\/td>\n<td style=\"width: 30px;\" align=\"center\">INeed<\/td>\n<td style=\"width: 30px;\" align=\"center\">You<\/td>\n<td style=\"width: 30px;\" align=\"center\">C<\/td>\n<\/tr>\n<tr class=\"alt\">\n<td style=\"width: 30px;\" align=\"center\">6<\/td>\n<td style=\"width: 30px;\" align=\"center\">Mixed<\/td>\n<td style=\"width: 30px;\" align=\"center\">Nuts<\/td>\n<td style=\"width: 30px;\" align=\"center\">Z<\/td>\n<\/tr>\n<tr>\n<td style=\"width: 30px;\" align=\"center\">7<\/td>\n<td style=\"width: 30px;\" align=\"center\">Kirk<\/td>\n<td style=\"width: 30px;\" align=\"center\">Land<\/td>\n<td style=\"width: 30px;\" align=\"center\">B<\/td>\n<\/tr>\n<tr class=\"alt\">\n<td style=\"width: 30px;\" align=\"center\">8<\/td>\n<td style=\"width: 30px;\" align=\"center\">Bit<\/td>\n<td style=\"width: 30px;\" align=\"center\">Shooter<\/td>\n<td style=\"width: 30px;\" align=\"center\">A<\/td>\n<\/tr>\n<tr>\n<td style=\"width: 30px;\" align=\"center\">9<\/td>\n<td style=\"width: 30px;\" align=\"center\">Sun<\/td>\n<td style=\"width: 30px;\" align=\"center\">Microsystem<\/td>\n<td style=\"width: 30px;\" align=\"center\">C<\/td>\n<\/tr>\n<tr class=\"alt\">\n<td style=\"width: 30px;\" align=\"center\">10<\/td>\n<td style=\"width: 30px;\" align=\"center\">Extra<\/td>\n<td style=\"width: 30px;\" align=\"center\">Fancy<\/td>\n<td style=\"width: 30px;\" align=\"center\">B<\/td>\n<\/tr>\n<\/tbody>\n<\/table>\n<h4><span class=\"ez-toc-section\" id=\"jajal_copy\"><\/span>jajal_copy<span class=\"ez-toc-section-end\"><\/span><\/h4>\n<table id=\"wptable-8\" class=\"wptable rowstyle-alt\" border=\"0\" cellspacing=\"1\">\n<thead>\n<tr>\n<th class=\"sortable\" style=\"width: 30px;\" align=\"center\">user_id<\/th>\n<th class=\"sortable\" style=\"width: 30px;\" align=\"center\">first_name<\/th>\n<th class=\"sortable\" style=\"width: 30px;\" align=\"center\">last_name<\/th>\n<th class=\"sortable\" style=\"width: 30px;\" align=\"center\">grade<\/th>\n<\/tr>\n<\/thead>\n<tbody>\n<tr>\n<td style=\"width: 30px;\" align=\"center\">1<\/td>\n<td style=\"width: 30px;\" align=\"center\">Some<\/td>\n<td style=\"width: 30px;\" align=\"center\">Dude<\/td>\n<td style=\"width: 30px;\" align=\"center\">A<\/td>\n<\/tr>\n<tr class=\"alt\">\n<td style=\"width: 30px;\" align=\"center\">2<\/td>\n<td style=\"width: 30px;\" align=\"center\">Other<\/td>\n<td style=\"width: 30px;\" align=\"center\">Guy<\/td>\n<td style=\"width: 30px;\" align=\"center\">B<\/td>\n<\/tr>\n<tr>\n<td style=\"width: 30px;\" align=\"center\">3<\/td>\n<td style=\"width: 30px;\" align=\"center\">You are<\/td>\n<td style=\"width: 30px;\" align=\"center\">Welcome<\/td>\n<td style=\"width: 30px;\" align=\"center\">B<\/td>\n<\/tr>\n<tr class=\"alt\">\n<td style=\"width: 30px;\" align=\"center\">4<\/td>\n<td style=\"width: 30px;\" align=\"center\">What<\/td>\n<td style=\"width: 30px;\" align=\"center\">Other<\/td>\n<td style=\"width: 30px;\" align=\"center\">A<\/td>\n<\/tr>\n<tr>\n<td style=\"width: 30px;\" align=\"center\">5<\/td>\n<td style=\"width: 30px;\" align=\"center\">INeed<\/td>\n<td style=\"width: 30px;\" align=\"center\">You<\/td>\n<td style=\"width: 30px;\" align=\"center\">C<\/td>\n<\/tr>\n<tr class=\"alt\">\n<td style=\"width: 30px;\" align=\"center\">6<\/td>\n<td style=\"width: 30px;\" align=\"center\">Mixed<\/td>\n<td style=\"width: 30px;\" align=\"center\">Nuts<\/td>\n<td style=\"width: 30px;\" align=\"center\">C<\/td>\n<\/tr>\n<tr>\n<td style=\"width: 30px;\" align=\"center\">7<\/td>\n<td style=\"width: 30px;\" align=\"center\">Kirk<\/td>\n<td style=\"width: 30px;\" align=\"center\">Land<\/td>\n<td style=\"width: 30px;\" align=\"center\">B<\/td>\n<\/tr>\n<tr class=\"alt\">\n<td style=\"width: 30px;\" align=\"center\">8<\/td>\n<td style=\"width: 30px;\" align=\"center\">Bit<\/td>\n<td style=\"width: 30px;\" align=\"center\">Shooter<\/td>\n<td style=\"width: 30px;\" align=\"center\">A<\/td>\n<\/tr>\n<tr>\n<td style=\"width: 30px;\" align=\"center\">9<\/td>\n<td style=\"width: 30px;\" align=\"center\">Sun<\/td>\n<td style=\"width: 30px;\" align=\"center\">Microsystem<\/td>\n<td style=\"width: 30px;\" align=\"center\">C<\/td>\n<\/tr>\n<tr class=\"alt\">\n<td style=\"width: 30px;\" align=\"center\">10<\/td>\n<td style=\"width: 30px;\" align=\"center\">Extra<\/td>\n<td style=\"width: 30px;\" align=\"center\">Fancy<\/td>\n<td style=\"width: 30px;\" align=\"center\">B<\/td>\n<\/tr>\n<\/tbody>\n<\/table>\n<p>\u00a0<\/p>\n<p>\u8981\u6bd4\u8f83\u8fd9\u4e24\u5f20\u8868\u7684\u6570\u636e\uff0c\u627e\u51fa\u4e0d\u4e00\u6837\u7684\u6570\u636e\u884c\u3002\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528<a href=\"http:\/\/en.wikipedia.org\/wiki\/Join_(SQL)#Outer_joins\"><span style=\"color: #967001;\">outer join<\/span><\/a> \u6280\u672f\u3002\u6211\u7ed9outer join\u505a\u4e86\u4e00\u4e2a\u94fe\u63a5\uff0c\u662fWikipedia\u7684\uff0c\u5982\u679c\u4f60\u5bf9\u8fd9\u4e2a\u6280\u672f\u4e0d\u662f\u5f88\u6e05\u695a\uff0c\u8fd8\u8bf7\u4f60\u884c\u770b\u770b\u5176\u6280\u672f\u7ec6\u8282\u3002<\/p>\n<p>\u4e0b\u9762\u662f\u5177\u4f53\u7684SQL\u8bed\u53e5\uff1a<\/p>\n<h4><span class=\"ez-toc-section\" id=\"%E4%BD%BF%E7%94%A8FULL_OUTER_JOIN\"><\/span><span style=\"text-decoration: underline;\">\u4f7f\u7528FULL OUTER JOIN<\/span><span class=\"ez-toc-section-end\"><\/span><\/h4>\n<pre data-enlighter-language=\"sql\" class=\"EnlighterJSRAW\">\r\nSELECT\r\n\u00a0    *\r\nFROM\r\n\u00a0    jajal j\r\n\u00a0    FULL OUTER JOIN jajal_copy jc ON jc.first_name = j.first_name\r\n\u00a0\u00a0   AND jc.last_name = j.last_name\r\n\u00a0\u00a0   AND jc.grade = j.grade\r\n\u00a0\u00a0   AND jc.user_id = j.user_id\r\nWHERE\r\n\u00a0    j.user_id IS NULL\r\n\u00a0    OR jc.user_id IS NULL\r\n<\/pre>\n<p>\u8fd0\u884c\u7ed3\u679c\u5982\u4e0b\uff1a<\/p>\n<table id=\"wptable-9\" class=\"wptable rowstyle-alt\" border=\"0\" cellspacing=\"1\">\n<thead>\n<tr>\n<th class=\"sortable\" style=\"width: 30px;\" align=\"center\">user_id<\/th>\n<th class=\"sortable\" style=\"width: 30px;\" align=\"center\">first_name<\/th>\n<th class=\"sortable\" style=\"width: 30px;\" align=\"center\">last_name<\/th>\n<th class=\"sortable\" style=\"width: 30px;\" align=\"center\">grade<\/th>\n<th class=\"sortable\" style=\"width: 30px;\" align=\"center\">user_id<\/th>\n<th class=\"sortable\" style=\"width: 30px;\" align=\"center\">first_name<\/th>\n<th class=\"sortable\" style=\"width: 30px;\" align=\"center\">last_name<\/th>\n<th class=\"sortable\" style=\"width: 30px;\" align=\"center\">grade<\/th>\n<\/tr>\n<\/thead>\n<tbody>\n<tr>\n<td style=\"width: 30px;\" align=\"center\">[NULL]<\/td>\n<td style=\"width: 30px;\" align=\"center\">[NULL]<\/td>\n<td style=\"width: 30px;\" align=\"center\">[NULL]<\/td>\n<td style=\"width: 30px;\" align=\"center\">[NULL]<\/td>\n<td style=\"width: 30px;\" align=\"center\">6<\/td>\n<td style=\"width: 30px;\" align=\"center\">Mixed<\/td>\n<td style=\"width: 30px;\" align=\"center\">Nuts<\/td>\n<td style=\"width: 30px;\" align=\"center\">C<\/td>\n<\/tr>\n<tr class=\"alt\">\n<td style=\"width: 30px;\" align=\"center\">6<\/td>\n<td style=\"width: 30px;\" align=\"center\">Mixed<\/td>\n<td style=\"width: 30px;\" align=\"center\">Nuts<\/td>\n<td style=\"width: 30px;\" align=\"center\">Z<\/td>\n<td style=\"width: 30px;\" align=\"center\">[NULL]<\/td>\n<td style=\"width: 30px;\" align=\"center\">[NULL]<\/td>\n<td style=\"width: 30px;\" align=\"center\">[NULL]<\/td>\n<td style=\"width: 30px;\" align=\"center\">[NULL]<\/td>\n<\/tr>\n<\/tbody>\n<\/table>\n<p>\u00a0<\/p>\n<h4><span class=\"ez-toc-section\" id=\"%E4%BD%BF%E7%94%A8NATURAL_FULL_OUTER_JOIN\"><\/span><span style=\"text-decoration: underline;\">\u4f7f\u7528NATURAL FULL OUTER JOIN<\/span><span class=\"ez-toc-section-end\"><\/span><\/h4>\n<p>\u5173\u4e8e<a href=\"http:\/\/en.wikipedia.org\/wiki\/Join_(SQL)#Natural_join\"><span style=\"color: #967001;\">natural join<\/span><\/a>\uff0c\u4f60\u53ef\u4ee5\u770b\u770bWikipedia\u662f\u600e\u4e48\u8bf4\u7684\u3002<\/p>\n<pre data-enlighter-language=\"sql\" class=\"EnlighterJSRAW\">\r\nSELECT\r\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 *\r\nFROM\r\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 jajal j\r\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 NATURAL FULL OUTER JOIN jajal_copy jc\r\nWHERE\r\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 j.user_id IS NULL\r\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 OR jc.user_id IS NULL\r\n<\/pre>\n<p>\u8fd0\u884c\u7ed3\u679c\u5982\u4e0b\uff1a<\/p>\n<table id=\"wptable-10\" class=\"wptable rowstyle-alt\" border=\"0\" cellspacing=\"1\">\n<thead>\n<tr>\n<th class=\"sortable\" style=\"width: 30px;\" align=\"center\">user_id<\/th>\n<th class=\"sortable\" style=\"width: 30px;\" align=\"center\">first_name<\/th>\n<th class=\"sortable\" style=\"width: 30px;\" align=\"center\">last_name<\/th>\n<th class=\"sortable\" style=\"width: 30px;\" align=\"center\">grade<\/th>\n<\/tr>\n<\/thead>\n<tbody>\n<tr>\n<td style=\"width: 30px;\" align=\"center\">6<\/td>\n<td style=\"width: 30px;\" align=\"center\">Mixed<\/td>\n<td style=\"width: 30px;\" align=\"center\">Nuts<\/td>\n<td style=\"width: 30px;\" align=\"center\">C<\/td>\n<\/tr>\n<tr class=\"alt\">\n<td style=\"width: 30px;\" align=\"center\">6<\/td>\n<td style=\"width: 30px;\" align=\"center\">Mixed<\/td>\n<td style=\"width: 30px;\" align=\"center\">Nuts<\/td>\n<td style=\"width: 30px;\" align=\"center\">Z<\/td>\n<\/tr>\n<\/tbody>\n<\/table>\n<p>\u00a0<\/p>\n<h4><span class=\"ez-toc-section\" id=\"MySQL_SQL_%E4%BB%A3%E7%A0%81\"><\/span><span style=\"text-decoration: underline;\">MySQL SQL \u4ee3\u7801<\/span><span class=\"ez-toc-section-end\"><\/span><\/h4>\n<pre>MySQL \u5e76\u4e0d\u652f\u6301 FULL OUTER JOIN\uff0c\u4f46\u662f\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528LEFT JOIN \u548c RIGHT JOIN \u6765\u5b9e\u73b0\u8fd9\u4e00\u529f\u80fd\u3002\u5982\u4e0b\u6240\u793a\u3002<\/pre>\n<pre data-enlighter-language=\"sql\" class=\"EnlighterJSRAW\">\r\nSELECT\r\n*\r\nFROM\r\njajal j\r\nLEFT JOIN jajal_copy jc ON jc.first_name = j.first_name\r\nAND jc.last_name = j.last_name\r\nAND jc.grade = j.grade\r\nAND jc.user_id = j.user_id\r\nWHERE\r\njc.user_id IS NULL\r\nUNION ALL\r\nSELECT\r\n*\r\nFROM\r\njajal j\r\nRIGHT JOIN jajal_copy jc ON jc.first_name = j.first_name\r\nAND jc.last_name = j.last_name\r\nAND jc.grade = j.grade\r\nAND jc.user_id = j.user_id\r\nWHERE\r\nj.user_id IS NULL\r\n<\/pre>\n<p>\u6216\u8005\u4f60\u66f4\u559c\u6b22NATURAL JOIN \u7248\u672c<\/p>\n<pre data-enlighter-language=\"sql\" class=\"EnlighterJSRAW\">\r\nSELECT\r\n*\r\nFROM\r\njajal j\r\nNATURAL LEFT JOIN jajal_copy jc\r\nWHERE\r\njc.user_id IS NULL\r\nUNION ALL\r\nSELECT\r\n*\r\nFROM\r\njajal j\r\nNATURAL RIGHT JOIN jajal_copy jc\r\nWHERE\r\nj.user_id IS NULL\r\n<\/pre>\n<p>\u5f53\u7136\uff0c\u5982\u679c\u4f60\u9700\u8981\u4e00\u4e2aMySQL\u7684\u5b58\u50a8\u8fc7\u7a0b\u7684\u8bdd\uff0c\u4e0b\u9762\u662f\u4e00\u4e2a\u793a\u4f8b\uff1a<\/p>\n<pre data-enlighter-language=\"sql\" class=\"EnlighterJSRAW\">\r\nDELIMITER $$\r\n\r\nCREATE PROCEDURE `db_schema`.`tablediff`\r\n\u00a0\u00a0\u00a0 (schema_name VARCHAR(64), table1 VARCHAR(64), table2 VARCHAR(64))\r\nBEGIN\r\n\u00a0\u00a0\u00a0 DECLARE done INT DEFAULT 0;\r\n\u00a0\u00a0\u00a0 DECLARE sql_statement TEXT DEFAULT &#039;&#039;;\r\n\u00a0\u00a0\u00a0 DECLARE sql_statement_where TEXT DEFAULT &#039;&#039;;\r\n\u00a0\u00a0\u00a0 DECLARE sql_statement_pk TEXT DEFAULT &#039;&#039;;\r\n\u00a0\u00a0\u00a0 DECLARE col_name VARCHAR(64);\r\n\u00a0\u00a0\u00a0 DECLARE col_name_cur CURSOR FOR\r\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 SELECT\r\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 COLUMN_NAME\r\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 FROM\r\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 information_schema.COLUMNS\r\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 WHERE\r\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 TABLE_SCHEMA = schema_name\r\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 AND TABLE_NAME = table1\r\n\u00a0\u00a0\u00a0 ;\r\n\u00a0\u00a0\u00a0 DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = 1;\r\n\r\n\u00a0\u00a0\u00a0 OPEN col_name_cur;\r\n\u00a0\u00a0\u00a0 traverse_columns: LOOP\r\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 FETCH col_name_cur INTO col_name;\r\n\r\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 IF done THEN\r\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 CLOSE col_name_cur;\r\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 LEAVE traverse_columns;\r\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 END IF;\r\n\r\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 SET sql_statement_where = CONCAT(sql_statement_where,\r\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 &#039; AND a.&#039;, col_name, &#039; = b.&#039;, col_name);\r\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 SET sql_statement_pk = CONCAT(sql_statement_pk,\r\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 &#039;AND b.&#039;, col_name, &#039; IS NULL&#039;);\r\n\u00a0\u00a0\u00a0 END LOOP;\r\n\r\n\u00a0\u00a0\u00a0 SELECT\r\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 COLUMN_NAME INTO col_name\r\n\u00a0\u00a0\u00a0 FROM\r\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 information_schema.KEY_COLUMN_USAGE\r\n\u00a0\u00a0\u00a0 WHERE\r\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 CONSTRAINT_SCHEMA = schema_name\r\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 AND CONSTRAINT_NAME = &#039;PRIMARY&#039;\r\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 AND TABLE_NAME = table1\r\n\u00a0\u00a0\u00a0 LIMIT 1\r\n\u00a0\u00a0\u00a0 ;\r\n\u00a0\u00a0\u00a0 IF col_name IS NOT NULL THEN\r\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 SET sql_statement_pk = CONCAT(&#039;AND b.&#039;, col_name, &#039; IS NULL&#039;);\r\n\u00a0\u00a0\u00a0 END IF;\r\n\r\n\u00a0\u00a0\u00a0 SET sql_statement = CONCAT(&#039;SELECT * FROM &#039;, schema_name, &#039;.&#039;, table1, &#039; a LEFT JOIN &#039;, schema_name, &#039;.&#039;, table2, &#039; b ON TRUE&#039;);\r\n\u00a0\u00a0\u00a0 SET sql_statement = CONCAT(sql_statement, sql_statement_where, &#039; WHERE TRUE &#039;, sql_statement_pk);\r\n\u00a0\u00a0\u00a0 SET sql_statement = CONCAT(sql_statement, &#039; UNION ALL SELECT * FROM &#039;, schema_name, &#039;.&#039;, table1, &#039; b RIGHT JOIN &#039;, schema_name, &#039;.&#039;, table2, &#039; a ON TRUE&#039;);\r\n\u00a0\u00a0\u00a0 SET sql_statement = CONCAT(sql_statement, sql_statement_where, &#039; WHERE TRUE &#039;, sql_statement_pk);\r\n\r\n\u00a0\u00a0\u00a0 SET @s = sql_statement;\r\n\u00a0\u00a0\u00a0 PREPARE stmt1 FROM @s;\r\n\u00a0\u00a0\u00a0 EXECUTE stmt1;\r\n\u00a0\u00a0\u00a0 DEALLOCATE PREPARE stmt1;\r\n\r\nEND$$\r\nDELIMITER ;\r\n<\/pre>\n<p>\u00a0<\/p>\n<p>\u00a0<\/p>\n<h4><span class=\"ez-toc-section\" id=\"PostgreSQL_%E4%B8%8B%E7%9A%84SQL%E8%AF%AD%E5%8F%A5\"><\/span><span style=\"text-decoration: underline;\">PostgreSQL \u4e0b\u7684SQL\u8bed\u53e5<\/span><span class=\"ez-toc-section-end\"><\/span><\/h4>\n<p>\u4e0b\u9762\u662fPostgreSQL\u7684\u4e00\u4e2a\u5b58\u50a8\u8fc7\u7a0b\uff1a<\/p>\n<pre data-enlighter-language=\"sql\" class=\"EnlighterJSRAW\">\r\nCREATE OR REPLACE FUNCTION tablediff (\r\n\u00a0\u00a0\u00a0 IN schema_name VARCHAR(64),\r\n\u00a0\u00a0\u00a0 IN table1 VARCHAR(64),\r\n\u00a0\u00a0\u00a0 IN table2 VARCHAR(64)\r\n) RETURNS BIGINT AS\r\n$BODY$\r\nDECLARE\r\n\u00a0\u00a0\u00a0 the_result BIGINT DEFAULT 0;\r\n\u00a0\u00a0\u00a0 sql_statement TEXT DEFAULT &#039;&#039;;\r\n\u00a0\u00a0\u00a0 sql_statement_where TEXT DEFAULT &#039;&#039;;\r\n\u00a0\u00a0\u00a0 sql_statement_pk TEXT DEFAULT &#039;&#039;;\r\n\u00a0\u00a0\u00a0 col_name VARCHAR(64);\r\n\u00a0\u00a0\u00a0 col_name_cur CURSOR FOR\r\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 SELECT\r\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 column_name\r\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 FROM\r\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 information_schema.columns\r\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 WHERE\r\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 table_catalog = schema_name\r\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 AND table_schema = &#039;public&#039;\r\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 AND table_name = table1\r\n\u00a0\u00a0\u00a0 ;\r\nBEGIN\r\n\u00a0\u00a0\u00a0 OPEN col_name_cur;\r\n\r\n\u00a0\u00a0\u00a0 LOOP\r\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 FETCH col_name_cur INTO col_name;\r\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 IF NOT FOUND THEN\r\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 EXIT;\r\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 END IF;\r\n\r\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 sql_statement_where := sql_statement_where || &#039; AND a.&#039; || col_name || &#039; = b.&#039; || col_name;\r\n\u00a0\u00a0\u00a0 END LOOP;\r\n\r\n\u00a0\u00a0\u00a0 SELECT\r\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 column_name INTO col_name\r\n\u00a0\u00a0\u00a0 FROM\r\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 information_schema.table_constraints tc\r\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 JOIN information_schema.constraint_column_usage ccu ON\r\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 ccu.constraint_name = tc.constraint_name\r\n\u00a0\u00a0\u00a0 WHERE\r\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 tc.table_catalog = schema_name\r\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 AND tc.table_schema = &#039;public&#039;\r\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 AND tc.table_name = table1\r\n\u00a0\u00a0\u00a0 LIMIT 1\r\n\u00a0\u00a0\u00a0 ;\r\n\r\n\u00a0\u00a0\u00a0 IF col_name IS NOT NULL THEN\r\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 sql_statement_pk := &#039; a.&#039; || col_name || &#039; IS NULL&#039;;\r\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 sql_statement_pk := sql_statement_pk || &#039; OR b.&#039; || col_name || &#039; IS NULL&#039;;\r\n\u00a0\u00a0\u00a0 END IF;\r\n\r\n\u00a0\u00a0\u00a0 sql_statement := &#039;SELECT COUNT(*) FROM &#039; || schema_name || &#039;.public.&#039; || table1 || &#039; a FULL OUTER JOIN &#039; || schema_name || &#039;.public.&#039; || table2 || &#039; b ON TRUE&#039;;\r\n\u00a0\u00a0\u00a0 sql_statement := sql_statement || sql_statement_where || &#039; WHERE &#039; || sql_statement_pk;\r\n\r\n\u00a0\u00a0\u00a0 EXECUTE sql_statement INTO the_result;\r\n\r\n\u00a0\u00a0\u00a0 RETURN the_result;\r\nEND;$BODY$\r\nLANGUAGE &#039;plpgsql&#039; STABLE;\r\n<\/pre>\n<p>\u00a0<\/p>\n<p>\u6587\u7ae0\uff1a<a href=\"http:\/\/www.microshell.com\/database\/sql\/comparing-data-from-2-database-tables\/\" target=\"_blank\">\u6765\u6e90<\/a><\/p>\n","raw":"","protected":false},"excerpt":{"rendered":"<p>\u6709\u4e9b\u65f6\u5019\uff0c\u6211\u4eec\u53ef\u80fd\u60f3\u8981\u6bd4\u8f83\u4e00\u4e0b\u4e24\u4e2a\u6570\u636e\u8868\uff0c\u4ee5\u627e\u5230\u5176\u4e2d\u4e0d\u540c\u7684\u6570\u636e\u3002\u6bd4\u5982\uff0c\u5728\u8fdb\u884c\u6570\u636e\u79fb\u690d\u7684\u65f6\u5019\uff0c\u6216\u662f\u5728\u5408\u5e76\u6570\u636e\u7684\u65f6\u5019\uff0c\u6216\u662f\u5728\u6bd4\u5bf9\u9a8c\u8bc1\u6570\u636e\u7684\u65f6\u5019\u3002\u5f53\u7136\u6bd4\u8f83\u4e24\u4e2a\u8868\uff0c\u9700\u8981&#8230;<\/p>\n<p class=\"read-more\"><a class=\"btn btn-default\" href=\"https:\/\/coolshell.cn\/articles\/925.html\"> Read More<span class=\"screen-reader-text\">  Read More<\/span><\/a><\/p>\n","protected":false},"author":2,"featured_media":0,"comment_status":"open","ping_status":"open","sticky":false,"template":"","format":"standard","meta":[],"categories":[105],"tags":[106,132,131],"series":[],"aioseo_notices":[],"views":22911,"post_thumbnail_image":"","content_first_image":"","post_medium_image_300":"","post_thumbnail_image_624":"","post_frist_image":"","post_medium_image":"","post_large_image":"","post_full_image":"","post_all_images":[],"videoAdId":"","listAd":"0","listAdId":"","listAdEvery":5,"total_comments":5,"category_name":"\u6570\u636e\u5e93","post_date":"2009-05-27","like_count":"0","praiseWord":"\u9f13\u52b1","excitationAd":"0","rewardedVideoAdId":"","detailAdId":"","detailAd":"0","enterpriseMinapp":"0","audios":[],"postImageUrl":"http:\/\/coolshell.cn\/wp-content\/uploads\/2016\/09\/coolshell-360x200.jpg","avatarurls":[],"related_posts":[],"pageviews":22912,"pageviews_wl":8965,"ratings_average":3,"ratings_total":23,"ratings_users":7,"next_post_id":962,"next_post_title":"\u3010\u539f\u521b\u3011SQL\u680f\u76ee\u6811\u7684\u4ee3\u7801","previous_post_id":652,"previous_post_title":"MySQL: InnoDB \u8fd8\u662f MyISAM?"}